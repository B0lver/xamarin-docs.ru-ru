---
title: «Песочница» для приложения Xamarin.Mac
description: В этой статье рассматриваются песочницы приложении Xamarin.Mac для выпуска в магазине приложений. Она охватывает все элементы, входящие в «песочницы» для контейнера каталоги, прав, определенного пользователем разрешения, разделение прав доступа и принудительного применения ядра.
ms.prod: xamarin
ms.assetid: 06A2CA8D-1E46-410F-8C31-00EA36F0735D
ms.technology: xamarin-mac
author: bradumbaugh
ms.author: brumbaug
ms.date: 03/14/2017
ms.openlocfilehash: a02d7639975de092b05f31bacedd6bde4c9392f9
ms.sourcegitcommit: 945df041e2180cb20af08b83cc703ecd1aedc6b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/04/2018
---
# <a name="sandboxing-a-xamarinmac-app"></a>«Песочница» для приложения Xamarin.Mac

_В этой статье рассматриваются песочницы приложении Xamarin.Mac для выпуска в магазине приложений. Она охватывает все элементы, входящие в «песочницы» для контейнера каталоги, прав, определенного пользователем разрешения, разделение прав доступа и принудительного применения ядра._

## <a name="overview"></a>Обзор

При работе с C# и .NET в приложении Xamarin.Mac, как и при работе с Objective-C или Swift имеют такие же возможности изолированного приложения.

[![Пример выполняемого приложения](sandboxing-images/intro01.png "пример выполняемого приложения")](sandboxing-images/intro01-large.png#lightbox)

В этой статье рассматриваются основы работы с "песочницы" в приложении Xamarin.Mac и все элементы, входящие в "песочницы": каталоги контейнера, прав, определенного пользователем разрешения, разделение прав доступа и принудительного применения ядра. Настоятельно рекомендуется работать через [Hello, Mac](~/mac/get-started/hello-mac.md) статью, во-первых, в частности [введение в Xcode и интерфейс построителя](~/mac/get-started/hello-mac.md#Introduction_to_Xcode_and_Interface_Builder) и [выходов и действия](~/mac/get-started/hello-mac.md#Outlets_and_Actions) разделы, как он охватывает основные принципы и методы, которые будут использоваться в этой статье.

Может потребоваться рассмотреть [предоставление C# классы и методы для Objective-C](~/mac/internals/how-it-works.md) раздел [внутренние компоненты Xamarin.Mac](~/mac/internals/how-it-works.md) документов также объясняется, какие `Register` и `Export` атрибуты используется для подключения классов C# для Objective-C-объекты и пользовательского интерфейса элементов.

## <a name="about-the-app-sandbox"></a>О App "песочницы"

Приложение "песочницы" предоставляет надежный защиты от повреждения, может быть вызвано вредоносное приложение выполняется на компьютере Mac, ограничивая доступ приложения к системным ресурсам.

Изолированное приложение имеет полные права пользователя, на котором работает приложение и доступа или все, что пользователь может выполнить. Если приложение содержит бреши в системе безопасности (или любую платформу, в которой он используется), злоумышленник потенциально можно использовать его эти слабые места и использовать приложение для управления Mac, который выполняется на.

Ограничивая доступ к ресурсам на основе каждого приложения, изолированное приложение обеспечивает уровень защиты от краж, повреждения или злоумышленников со стороны приложения, запущенного на компьютере пользователя.

Приложение "песочницы" — это технология управления доступа, встроены в macOS (применяется на уровне ядра), предоставляющий преследует две стратегии:

1. Приложение "песочницы" позволяет разработчику для описания _как_ приложения будет взаимодействовать с операционной Системой и, таким образом, он предоставляется только права доступа, необходимые для выполнения задачи и ничего более.
2. Приложение "песочницы" позволяет пользователю легко предоставить дальнейший доступ к системе через открытия сохранить диалоговые окна и перетащите операций и другие, распространенные пользовательские взаимодействия.

### <a name="preparing-to-implement-the-app-sandbox"></a>Подготовка к реализации изолированного приложения

Ниже приведены элементы приложения "песочницы", будет подробно в статье.

- Каталоги контейнера
- Объемы обслуживания
- Разрешения, определенного пользователем
- Разделение прав доступа
- Применение ядра

После того, как эти сведения, можно будет создать план перехода приложения "песочницы" в приложении Xamarin.Mac.

Во-первых необходимо определить, если приложение является хорошим кандидатом для изолирования (большинство приложений доступно). Далее необходимо устранить любые проблемы совместимости с API и определить, какие элементы изолированного приложения потребуется. Наконец найдите в с помощью разделения прав доступа, чтобы максимально увеличить уровень защиты приложения.

После перехода на платформу приложений "песочнице", некоторые расположений файловой системы, которые приложение использует будут отличаться. В частности ваше приложение получит контейнерный каталог, который будет использоваться для файлов поддержки приложения, базы данных, кэши и другие файлы, которые не являются документы пользователя. MacOS и Xcode обеспечивают поддержку для миграции этих типов файлов, из их стандартные области контейнера.

## <a name="sandboxing-quick-start"></a>«Песочница» для быстрого запуска

В этом разделе мы создадим простое Xamarin.Mac приложение, которое использует веб-представление (для которого требуется сетевое подключение, для которого ограничены в разделе "песочницы", без особого запроса) в качестве примера Приступая к работе с App "песочницы".

Мы проверьте, что приложение действительно изолированным и узнайте, как для диагностики и устранения распространенных ошибок приложения "песочницы".

### <a name="creating-the-xamarinmac-project"></a>Создание проекта Xamarin.Mac

Давайте выполните следующие действия для создания нашего примера проекта:

1. Запустите Visual Studio для Mac и нажмите кнопку **новое решение...** .
2. Из **новый проект** выберите **Mac** > **приложения** > **Cocoa приложения**: 

    [![Создание нового приложения Cocoa](sandboxing-images/sample01.png "Создание нового приложения Cocoa")](sandboxing-images/sample01-large.png#lightbox)
3. Нажмите кнопку **Далее** кнопку, введите `MacSandbox` имя проекта и нажмите кнопку **создать** кнопки: 

    [![Введите имя приложения](sandboxing-images/sample02.png "после ввода имени приложения")](sandboxing-images/sample02-large.png#lightbox)
4. В **Pad решения**, дважды щелкните **Main.storyboard** файл, чтобы открыть его для редактирования в Xcode: 

    [![Изменение основного раскадровки](sandboxing-images/sample03.png "редактирования основного раскадровки")](sandboxing-images/sample03-large.png#lightbox)
5. Перетащите **веб-представление** на окно, размер его для заполнения содержимого области и задайте его увеличиваться и уменьшаться с окном: 

    [![Добавление веб-представление](sandboxing-images/sample04.png "Добавление веб-представление")](sandboxing-images/sample04-large.png#lightbox)
6. Создание выхода для веб-страницы вызывается `webView`: 

    [![Создание нового выхода](sandboxing-images/sample05.png "Создание нового выхода")](sandboxing-images/sample05-large.png#lightbox)
7. Вернитесь в Visual Studio для Mac и дважды щелкните **ViewController.cs** файла в **Pad решения** чтобы открыть его для редактирования.
8. Добавьте следующий код с помощью инструкции: `using WebKit;`
9. Сделать `ViewDidLoad` внешний метод следующим образом: 

```csharp
public override void AwakeFromNib ()
{
    base.AwakeFromNib ();
    webView.MainFrame.LoadRequest(new NSUrlRequest(new NSUrl("http://www.apple.com")));
}
```

10. Сохраните изменения.

Запуск приложения и убедиться, что на веб-сайте Apple в окне следующим образом:

[![Отображение выполнения примера приложения](sandboxing-images/sample06.png "отображение выполнения примера приложения")](sandboxing-images/sample06-large.png#lightbox)

<a name="Signing_and_Provisioning_the_App" />

### <a name="signing-and-provisioning-the-app"></a>Подписи и подготовительного приложения

Прежде чем мы можно включить App "песочницы", необходимо сначала подготовить и подписать приложение Xamarin.Mac.

Позволяет сделать следующее:

1. Войдите на портал разработчиков Apple: 

    [![Вход на портал разработчиков Apple](sandboxing-images/sign01.png "входа на портал разработчиков Apple")](sandboxing-images/sign01-large.png#lightbox)
2. Выберите **сертификатов, профили & идентификаторы**: 

    [![Выбор сертификатов, идентификаторов и профилей](sandboxing-images/sign02.png "Выбор сертификатов, идентификаторов и профилей")](sandboxing-images/sign02-large.png#lightbox)
3. В разделе **приложений Mac**выберите **идентификаторы**: 

    [![При выборе идентификаторов](sandboxing-images/sign03.png "выбора идентификаторов")](sandboxing-images/sign03-large.png#lightbox)
4. Создайте новый идентификатор для приложения: 

    [![Создание нового идентификатора приложения](sandboxing-images/sign04.png "создания нового идентификатора приложения")](sandboxing-images/sign04-large.png#lightbox)
5. В разделе **профили подготовки**выберите **разработки**: 

    [![При выборе разработки](sandboxing-images/sign05.png "при выборе разработки")](sandboxing-images/sign05-large.png#lightbox)
6. Создание профиля и выберите **разработка приложений для Mac**: 

    [![Создание профиля](sandboxing-images/sign06.png "Создание профиля")](sandboxing-images/sign06-large.png#lightbox)
7. Выберите идентификатор приложения, созданной ранее. 

    [![При выборе идентификатор приложения](sandboxing-images/sign07.png "при выборе идентификатор приложения")](sandboxing-images/sign07-large.png#lightbox)
8. Выберите разработчиков для этого профиля. 

    [![Добавление разработчики](sandboxing-images/sign08.png "Добавление разработчиков")](sandboxing-images/sign08-large.png#lightbox)
9. Выберите компьютеры, для этого профиля: 

    [![Выбор разрешенных компьютеров](sandboxing-images/sign09.png "выбора разрешенных компьютеров")](sandboxing-images/sign09-large.png#lightbox)
10. Присвойте имя профиля: 

    [![Присвоение имени профиля](sandboxing-images/sign10.png "указания имени профиля")](sandboxing-images/sign10-large.png#lightbox)
11. Нажмите кнопку **сделать** кнопки.

> [!IMPORTANT]
> В некоторых случаях может потребоваться загрузить новый профиль подготовки с портала разработчиков Apple напрямую и дважды щелкните его для установки. Также может потребоваться остановить и перезапустить Visual Studio для Mac, прежде чем сможет получить доступ к новой конфигурации.

Далее нам нужно загрузить новый идентификатор приложения и профиля на компьютере разработчика. Давайте выполните следующие действия.

1. Запустить Xcode и выберите **предпочтения** из **Xcode** меню: 

    ![Изменение учетных записей в Xcode](sandboxing-images/sign11.png "редактирование учетных записей в Xcode")
2. Щелкните **просмотра сведений...**  кнопки: 

    ![Нажав кнопку Просмотр сведений о](sandboxing-images/sign12.png "нажав кнопку Просмотр сведений")
3. Щелкните **обновление** кнопки (в левом нижнем углу).
4. Щелкните **сделать** кнопки.

Далее нам необходимо выбрать новый идентификатор приложения и профиль подготовки в данном проекте Xamarin.Mac. Давайте выполните следующие действия.

1. В **Pad решения**, дважды щелкните **Info.plist** файл, чтобы открыть его для редактирования.
2. Убедитесь, что **идентификатор пакета** соответствует нашей идентификатор приложения, созданной ранее (пример: `com.appracatappra.MacSandbox`): 

    [![Редактирование идентификатор пакета](sandboxing-images/sign13.png "редактирование идентификатор пакета")](sandboxing-images/sign13-large.png#lightbox)
3. Далее дважды щелкните **Entitlements.plist** файл и убедитесь, наши **iCloud хранилищу ключей и значений** и **iCloud контейнеры** соответствовать всем нашей идентификатор приложения, созданной ранее (пример: `com.appracatappra.MacSandbox`): 

    [![Изменение файла Entitlements.plist](sandboxing-images/sign17.png "редактирования файла Entitlements.plist")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения.
4. В **Pad решения**, дважды щелкните файл проекта, чтобы открыть его параметры для изменения:  

    ![Editign параметры решения](sandboxing-images/sign14.png "Editign параметры решения")
5. Выберите **подписи Mac**, затем проверьте **подписать пакет приложения** и **подписать пакет установщика**. В разделе **профиль подготовки**, выберите ту, созданной ранее: 

    ![Установка профиля подготовки](sandboxing-images/sign15.png "параметр профиля подготовки")
6. Нажмите кнопку **сделать** кнопки.

> [!IMPORTANT]
> Может потребоваться выйти и перезапустить Visual Studio для Mac получить его распознать новый идентификатор приложения и профиль подготовки, который был установлен в Xcode.

#### <a name="troubleshooting-provisioning-issues"></a>Устранение неполадок подготовки

На этом этапе можно попытаться запустить приложение и убедитесь, что все подписана и неправильно подготовлена. Если приложение по-прежнему запускается как и ранее, все, что является хорошим. В случае сбоя может появиться диалоговое окно, как показано ниже:

[![Пример проблемы диалоговое окно подготовки](sandboxing-images/sign16.png "пример проблемы диалоговое окно подготовки")](sandboxing-images/sign16-large.png#lightbox)

Ниже приведены наиболее распространенные причины подготовки и подписи проблемы.

- Идентификатор пакета приложений не соответствует ИД приложения выбранного профиля.
- КОД разработчика не соответствует ИД разработчика выбранного профиля.
- UUID Mac, который проверяется на не зарегистрирован в рамках выбранного профиля.

В случае проблемы устранить ее на портале разработчиков Apple. обновите профили в Xcode и выполнить чистую сборку в Visual Studio для Mac.

### <a name="enable-the-app-sandbox"></a>Включить изолированную приложения

Приложение "песочницы" Включить, установив флажок в параметрах проектов. Выполните следующие действия:

1. В **Pad решения**, дважды щелкните **Entitlements.plist** файл, чтобы открыть его для редактирования.
2. Установите флажки **включите права** и **приложения «песочницы» для включения**: 

    [![Изменение прав и включение «песочницы» для](sandboxing-images/sign17.png "редактирование прав и включение "песочницы"")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения.

На этом этапе вы включили приложение "песочницы", но вы не предоставили требуется сетевой доступ для веб-представление. Если запустить приложение, вы должны получить пустое окно:

[![Отображение в веб-доступа блокируются](sandboxing-images/sample08.png "отображение блокирования доступа в Интернет")](sandboxing-images/sample08-large.png#lightbox)

### <a name="verifying-that-the-app-is-sandboxed"></a>Проверка изолированного приложения

Помимо ресурсов, поведение блокировки существует три основных способа определить, имеет ли приложение Xamarin.Mac успешно изолированного:

1. В средстве поиска, проверьте содержимое `~/Library/Containers/` папку - Если изолированное, это приложение будет папку с именем, например идентификатор пакета приложения (пример: `com.appracatappra.MacSandbox`): 

    [![Открытие набора приложений](sandboxing-images/sample09.png "Открытие набора приложений")](sandboxing-images/sample09-large.png#lightbox)
2. Система видит приложение как изолированное в мониторе активности:
    - Запустите монитор активности (под `/Applications/Utilities`). 
    - Выберите **представление** > **столбцы** и убедитесь, что **"песочницы"** отмечен пункт меню.
    - Убедитесь, что читает столбец "песочницы" `Yes` для приложения: 

    [![Проверка приложения в мониторе активности](sandboxing-images/sample10.png "Проверка приложения в мониторе активности")](sandboxing-images/sample10-large.png#lightbox)
3. Убедитесь, что изолированное приложение двоичные:
    - Запустите приложение "Терминал".
    - Перейдите к приложениям `bin` каталога.
    - Выполните эту команду: `codesign -dvvv --entitlements :- executable_path` (где `executable_path` — это путь к приложению): 

    [![Проверка приложения в командной строке](sandboxing-images/sample11.png "Проверка приложения в командной строке")](sandboxing-images/sample11-large.png#lightbox)

### <a name="debugging-a-sandboxed-app"></a>Отладка изолированного приложения

Отладчик подключается к приложениям Xamarin.Mac через TCP, это означает, что по умолчанию при включении песочницы, не удается подключиться к приложению, поэтому при попытке запустить приложение без соответствующих разрешений, который включен, возникает сообщение об ошибке *«не удалось подключиться к отладчик»*. 

[![Задайте необходимые параметры](sandboxing-images/debug01.png "задайте необходимые параметры")](sandboxing-images/debug01-large.png#lightbox)

**Разрешить исходящих сетевых соединений (клиент)** разрешение является требуемую для отладчика, включение этого класса, позволит отладку в обычном режиме. Поскольку нельзя выполнять отладку без него, мы обновили `CompileEntitlements` целевого объекта для `msbuild` для автоматического добавления этого разрешения прав для любого приложения, изолированным для отладки только сборок. Построения выпуска следует использовать права, указанные в файле прав, без изменений.

### <a name="resolving-an-app-sandbox-violation"></a>Разрешение нарушение приложение "песочницы"

Приложение "песочницы" нарушение Если изолированного Xamarin.Mac приложение пытается получить доступ к ресурсу, с не разрешаются явным образом. Например, наш веб-представление будет отображаться на веб-сайте Apple. больше не производится.

Наиболее распространенный источник нарушений изолированного приложения происходит, когда параметры права, указанные в Visual Studio для Mac не соответствуют требованиям приложения. Опять же обратно к нашему примеру: отсутствует сетевое подключение права, предотвращения рабочий веб-представление.

#### <a name="discovering-app-sandbox-violations"></a>Обнаружение нарушений приложение "песочницы"

Если есть подозрение, что происходит нарушение приложение "песочницы" в приложении Xamarin.Mac, самый быстрый способ обнаружения проблемы — с помощью **консоли** приложения.

Выполните следующие действия:

1. Скомпилируйте приложение в вопросе и запустите его из Visual Studio для Mac.
2. Откройте **консоли** приложения (из `/Applications/Utilties/`).
3. Выберите **все сообщения** на боковой панели и введите `sandbox` поиска: 

    [![Пример проблемы в консоли «песочницы» для](sandboxing-images/resolve01.png "пример проблем "песочницы" в консоли")](sandboxing-images/resolve01-large.png#lightbox)

Для нашего выше примере приложения вы увидите, что Kernal блокирует `network-outbound` трафика из-за приложения "песочницы", так как не был запрошен эти права.

#### <a name="fixing-app-sandbox-violations-with-entitlements"></a>Устранение нарушений с правами "песочницы" приложения

Теперь, когда мы рассмотрели найти нарушений «песочницы» для приложения, давайте посмотрим, как они могут быть устранены путем настройки прав нашего приложения.

Выполните следующие действия:

1. В **Pad решения**, дважды щелкните **Entitlements.plist** файл, чтобы открыть его для редактирования.
2. В разделе **прав** установите флажок **разрешить исходящих сетевых соединений (клиент)** флажок: 

    [![Изменение прав](sandboxing-images/sign17.png "редактирование прав")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения в приложение.

Если мы делать все вышеперечисленное для нашего примера приложения, затем постройте и запустите его, веб-содержимое теперь отображается должным образом.

## <a name="the-app-sandbox-in-depth"></a>Приложение "песочницы" подробное описание

Механизмы управления доступом, предоставляемые изолированного приложения несколько и легкими для понимания. Однако способом, что каждое приложение будет развернуто приложение "песочницы" является уникальным и учетом требований приложения.

Учитывая все усилия для защиты приложения Xamarin.Mac предотвращающие вредоносный код, должны существовать только один уязвимости в любом приложении (или один из библиотеки или платформ, он использует) для получения контроля над взаимодействия приложения с система.

Приложение "песочницы" была разработана для предотвращения перехват (или уменьшить ущерб, который может привести к), позволяя указать предполагаемого взаимодействия приложения с системой. Система только предоставляет доступ для ресурса, которому требуется приложение для выполнения его работы и ничего более.

При разработке приложения изолированной среде разработке для Худший случай. Приложение скомпрометирован вредоносный код, ограничен доступ к файлам и ресурсы в изолированной среде приложения.

### <a name="entitlements-and-system-resource-access"></a>Права и доступ к ресурсам системы

Как было показано выше, Xamarin.Mac приложение, которое не было изолированного предоставляется полные права доступа и права доступа пользователя, на котором выполняется приложение. Компрометация вредоносным кодом незащищенные приложения могут действовать как агент опасного поведения, с широким, диапазоне возможных для причинения ущерба.

Включение приложения "песочницы", удалите все, кроме минимальный набор привилегий, которую затем повторно включить на необходимость только использование прав Xamarin.Mac приложения. 

Изменение ресурсов "песочницы" приложение приложения путем редактирования его **Entitlements.plist** файла и проверка или выбор прав, необходимых в раскрывающихся списках редакторы:

[![Изменение прав](sandboxing-images/sign17.png "редактирование прав")](sandboxing-images/sign17-large.png#lightbox)

### <a name="container-directories-and-file-system-access"></a>Каталоги контейнера и доступ к файловой системе

Когда приложение Xamarin.Mac принимает изолированного приложения, он получает доступ к следующим разделам:

- **Контейнерный каталог приложения** — при первом запуске операционной системы создается специальный _контейнерный каталог_ там, где его ресурсы перейти только его доступность. Приложение будет иметь доступ на чтение и запись в этот каталог.
- **Каталоги контейнер группы приложения** -приложения может быть предоставлен доступ к одному или нескольким _контейнеров группы_ , совместно используемых приложений в одной группе.
- **Определяемый пользователем файлов** -приложение автоматически получает доступ к файлам, которые являются явно открыт или перетащить на приложения пользователем.
- **Связанные элементы** -с соответствующие права, приложение может иметь доступ в файл с тем же именем, но разными расширениями. Например, документ, который был сохранен как `.txt` файла и `.pdf`.
- **Временные каталоги, каталоги средство командной строки и определенных местах мира для чтения** -приложение имеет разные уровни доступа к файлам в других четко определенных расположениях, как указано в системе.

#### <a name="the-app-container-directory"></a>Каталог приложения контейнера

В приложении Xamarin.Mac приложения контейнерный каталог имеет следующие характеристики:

- Он находится в расположении, скрытые в домашнем каталоге пользователя (обычно `~Library/Containers`) и можно осуществить с помощью `NSHomeDirectory` функции (см. ниже) в приложении. Так как он находится в домашнем каталоге, каждый пользователь получит свои собственные контейнер для приложения.
- Приложение имеет неограниченный доступ чтения и записи к каталогу контейнер и все его вложенные каталоги и файлы в нем.
- Большинство интерфейсов API macOS в путь поиска являются относительно контейнера приложения. Например, контейнер будет иметь свой собственный **библиотеки** (полученной `NSLibraryDirectory`), **поддержки приложения** и **предпочтения** подкаталоги.
- macOS устанавливает и применяет к подключению и приложения и его контейнера через подписи кода. Даже является другое приложение пытается подделать приложения с помощью его **идентификатор пакета**, он не будет доступа к контейнеру из-за подписывания кода.
- Контейнер не для файлов, создаваемого пользователем. Вместо этого оно доступно для файлов, используемые приложением, такие как базы данных, кэши или других определенных типов данных.
- Для _коробки_ типов приложения (такие как Apple фото), содержимое пользователя перейдет в контейнере.

> [!IMPORTANT]
> К сожалению, Xamarin.Mac имеет 100% API покрытия еще (в отличие от Xamarin.iOS), в результате `NSHomeDirectory` API не сопоставлен в текущей версии Xamarin.Mac.

Для временного решения проблемы можно использовать следующий код:

```csharp
[System.Runtime.InteropServices.DllImport("/System/Library/Frameworks/Foundation.framework/Foundation")]
public static extern IntPtr NSHomeDirectory();

public static string ContainerDirectory {
    get {
        return ((NSString)ObjCRuntime.Runtime.GetNSObject(NSHomeDirectory())).ToString ();
        }
}
```

#### <a name="the-app-group-container-directory"></a>Каталог приложения группы контейнера

Начиная с Mac macOS 10.7.5 (и более), приложение может использовать `com.apple.security.application-groups` права на доступ к общей контейнер, который является общим для всех приложений в группе. Можно использовать этот общий контейнер для содержимого с выходом не написанный пользователем, например базы данных или других типов файлов поддержки (например, кэши).

Контейнеры группы автоматически добавляются в контейнер "песочницы" каждого приложения (если они являются частью группы) и сохраняются на `~/Library/Group Containers/<application-group-id>`. Идентификатор группы _должен_ начинаются с идентификатора группы разработки и за период, например:

```plist
<team-id>.com.company.<group-name>
```

Дополнительные сведения см. в разделе Apple [Добавление приложения в группу приложений](https://developer.apple.com/library/prerelease/mac/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) в [справочника по ключам правах](https://developer.apple.com/library/prerelease/mac/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/AboutEntitlements.html#//apple_ref/doc/uid/TP40011195).

#### <a name="powerbox-and-file-system-access-outside-of-the-app-container"></a>Доступ к системе Powerbox и файл вне контейнера приложения

Изолированное приложение Xamarin.Mac получать доступ к файловой системе в месте за пределами своего контейнера одним из следующих способов:

- В определенном направлении пользователя (с помощью открыть и сохранить диалоговые окна или другие методы, такие как перетаскивание).
- С помощью прав для расположений определенной файловой системы (например, `/bin` или `/usr/lib`).
* Если папка в файловой системе находится в определенные каталоги, которые являются world для чтения (например, общий доступ).

_Powerbox_ — технология безопасности, взаимодействие с пользователем, чтобы развернуть права доступа для файла изолированного приложения Xamarin.Mac macOS. Powerbox имеет не API, но прозрачно активируется, когда приложение вызывает `NSOpenPanel` или `NSSavePanel`. Powerbox доступ осуществляется через прав, заданные для Xamarin.Mac приложения.

Если изолированное приложение отображает открыть или сохранить диалоговое окно, окно представленных Powerbox (и не AppKit) и имеет доступ к любой файл или каталог, в котором пользователь имеет доступ к.

Когда пользователь выбирает файл или каталог из открыть или сохранить диалоговое окно (или перетаскивает либо на значок приложения), Powerbox добавляет связанный путь приложения "песочницы".

Кроме того система автоматически разрешает следующую команду для изолированного приложения:

- Метод ввода подключения к системе.
- Вызов службы, выбранные пользователем из **службы** меню (только для служб, помеченных как _безопасным для приложений "песочнице"_ поставщиком услуг).
- Выберите открытые файлы, пользователем из **открыть последние** меню.
- Используйте копирование и вставка между другими приложениями.
- Чтение файлов в следующих местах мира для чтения:
    - `/bin`
    - `/sbin`
    - `/usr/bin`
    - `/usr/lib`
    - `/usr/sbin`
    - `/usr/share`
    - `/System`
- Чтение и запись файлов в каталоги, созданные `NSTemporaryDirectory`.

По умолчанию файлы открыть или сохранить в изолированном приложении Xamarin.Mac останутся доступными, до завершения приложения (если файл был по-прежнему открыт в том случае, когда приложение завершает работу). Открытых файлов будет автоматически восстановлен для "песочницы" приложения через функцию Resume macOS при следующем запуске приложения.

Для обеспечения сохраняемости к файлам, находящимся вне контейнера приложения Xamarin.Mac, с помощью закладок уровня безопасности (см. ниже).

#### <a name="related-items"></a>Связанные элементы

Приложение "песочницы" позволяет приложению получить доступ к связанных элементов, которые с одинаковыми именами, но разными расширениями. Компонент состоит из двух частей:) список связанных модулей в приложении `Info.plst` файл, (б) код нужно сообщить "песочницы", что приложение будет делает с этими файлами.

Существует два сценария, где это имеет смысл.

1. Приложение необходимо сохранить другую версию файла (с расширением новый). Например, экспорт `.txt` файл `.pdf` файла. Чтобы решить эту проблему, необходимо использовать `NSFileCoordinator` доступа к файлу. Будет вызван `WillMove(fromURL, toURL)` сначала переместите файл в новое расширение и затем вызвать `ItemMoved(fromURL, toURL)`.
2. Приложение, необходимо открыть главный файл с расширением одно и несколько вспомогательных файлов с разными расширениями. Например фильма и файл подзаголовок. Используйте `NSFilePresenter` для получения доступа к файлу получателей. Основной файл для предоставления `PrimaryPresentedItemURL` свойство и вторичный файл `PresentedItemURL` свойство. При открытии основного файла, вызовите `AddFilePresenter` метод `NSFileCoordinator` класса для регистрации дополнительного файла.

В обоих случаях приложения **Info.plist** файла необходимо объявлять типы документов, можно открыть приложение. Все типы файлов, добавьте `NSIsRelatedItemType` (со значением `YES`) для его записи в `CFBundleDocumentTypes` массива.

#### <a name="open-and-save-dialog-behavior-with-sandboxed-apps"></a>Открытие и сохранение поведения диалогового окна с изолированных приложений

Следующие ограничения, помещаются в `NSOpenPanel` и `NSSavePanel` при их вызове из изолированного приложения Xamarin.Mac:

- Вы не можете вызывать программно **ОК** кнопки.
- Невозможно изменить программным путем выбора пользователя в `NSOpenSavePanelDelegate`.

Кроме того следующие изменения наследования, в месте:

- **Изолированные приложения** - `NSOpenPanel` `NSSavePanel``NSPanel``NSWindow``NSResponder``NSObject``NSOpenPanel``NSSavePanel``NSObject``NSOpenPanel``NSSavePanel`

### <a name="security-scoped-bookmarks-and-persistent-resource-access"></a>Области безопасности закладки и доступа к ресурсам постоянно

Как уже говорилось выше, приложение изолированного Xamarin.Mac можно получить доступ к файлу или ресурсу за пределами своего контейнера посредством прямого взаимодействия с пользователем (как указано в PowerBox). Однако доступ к этим ресурсам не сохраняется автоматически запускает приложения или системы перезагрузки.

С помощью _Security-Scoped закладки_, Xamarin.Mac изолированного приложения можно сохранить намерения пользователя и обеспечения доступа к заданной ресурсы после приложение перезапустить.

#### <a name="security-scoped-bookmark-types"></a>Типы уровня безопасности закладки

При работе с Security-Scoped закладки и постоянный доступ к ресурсам, существует два варианта использования sistine:

- **Закладка App-Scoped постоянный доступ к указанного пользователем файла или папки.** 

    Например, если изолированного приложения Xamarin.Mac позволяет использовать для открытия внешний документ для редактирования (с помощью `NSOpenPanel`), приложения могут создавать закладки App-Scoped, чтобы он получает доступ к тому же файлу в будущем.
- **Закладка Document-Scoped обеспечивает постоянный доступ к определенной документов вложенный файл.** 

Например видео редактирования приложение, которое создает файл проекта, который имеет доступ к отдельных изображений, видеоклипы и звуковые файлы, которые позже будут объединены в одну фильма.

Если пользователь импортирует файл ресурсов в проект (через `NSOpenPanel`), приложение создает закладку Document-Scoped для элемента, который хранится в проекте, чтобы он всегда доступны для приложения.

Document-Scoped закладки может быть решена любое приложение, которое можно открыть данные закладки и сам документ. Это обеспечивает поддержку переносимость, чтобы пользователи могли отправлять файлы проекта на другого пользователя и наличие все закладки также работать для них.

> [!IMPORTANT]
> Закладка Document-Scoped можно _только_ пункты одного файла, а не папка и не может быть файл в расположение, используемое в системе (например, `/private` или `/Library`).

#### <a name="using-security-scoped-bookmarks"></a>С помощью закладок уровня безопасности

С помощью любого типа Security-Scoped закладку, необходимо выполните следующие действия:

1. **Настройка соответствующих прав в приложении Xamarin.Mac, должен использовать закладки Security-Scoped** -For App-Scoped закладок, задайте `com.apple.security.files.bookmarks.app-scope` правах ключ `true`. Закладки Document-Scoped задать `com.apple.security.files.bookmarks.document-scope` правах ключ `true`.
2. **Создать закладку Security-Scoped** -это нужно сделать для любого файла или папки, пользователь предоставил доступ к (через `NSOpenPanel` например), необходимость постоянный доступ к приложению. Используйте `public virtual NSData CreateBookmarkData (NSUrlBookmarkCreationOptions options, string[] resourceValues, NSUrl relativeUrl, out NSError error)` метод `NSUrl` класса для создания закладки.
3. **Разрешить закладки Security-Scoped** — когда приложению требуется доступ к ресурсу еще раз (например, после перезагрузки) потребуется разрешить закладки в URL-адрес с областью безопасности. Используйте `public static NSUrl FromBookmarkData (NSData data, NSUrlBookmarkResolutionOptions options, NSUrl relativeToUrl, out bool isStale, out NSError error)` метод `NSUrl` класса, чтобы устранить закладки.
4. **Явно уведомить системы, в которой необходимо получить доступ к файлу по URL-адресу Security-Scoped** — этот шаг должен выполняться сразу после получения Security-Scoped URL-адрес выше, или если позднее потребуется восстановить доступ к ресурсу после появления освобождаться, доступ к нему. Вызовите `StartAccessingSecurityScopedResource ()` метод `NSUrl` класса, чтобы получить доступ к URL-адрес Security-Scoped.
5. **Явно уведомить в системе, которая больше не требуется доступ к файлу по URL-адресу Security-Scoped** -как можно быстрее, следует сообщить системе, когда приложение больше не требуется доступ к файлу (например, если пользователь не закроет его). Вызовите `StopAccessingSecurityScopedResource ()` метод `NSUrl` класса завершат Security-Scoped URL-адрес.

После можно передать доступ к ресурсу, необходимо будет вернуться к шагу 4 еще раз, чтобы восстановить доступ. При перезапуске приложения Xamarin.Mac, необходимо вернуться к шагу 3 и заново разрешить закладки.

> [!IMPORTANT]
> Ошибка для предоставления доступа к ресурсам URL-адрес Security-Scoped вызовет приложении Xamarin.Mac утечку ресурсов ядра. В результате приложение больше не будет добавлять расположений файловой системы к его контейнеру до его перезапуска.

### <a name="the-app-sandbox-and-code-signing"></a>Приложение "песочницы" и подписывание кода

После включения изолированного приложения и включить эти особые требования для приложения Xamarin.Mac (с помощью прав), необходимо запрограммировать входа проекта для изолирования вступили в силу. Необходимо выполнить код, подписи, так как связанные права, необходимые для приложения «песочницы» для подписи приложения. 

macOS обеспечивает связь между приложения контейнера и его подпись кода, таким образом другие приложения не может обращаться к этот контейнер, даже если его подменяет приложений идентификатор пакета. Этот механизм работает следующим образом:

1. Когда система создает контейнер приложения, он задает _управления доступом_ (ACL) для этого контейнера. Исходный элемент управления в списке содержит приложения _назначенному требование_ (DR) описано, как будущих версий приложения может быть распознан (если он будет обновлен).
2. Каждый раз, запускает приложение с одним и тем же Идентификатором пакета, система проверяет соответствие указанных требованиям, указанным в одной из записей в список управления Доступом контейнера подписи кода приложения. Если система не найден, его приложение не сможет запускать.

Code Signing works одним из следующих способов:

1. Перед созданием проекта Xamarin.Mac, получите сертификат разработки, распространения сертификат и сертификат разработчика идентификатор с портала разработчиков Apple.
2. Mac App Store распространяет приложение Xamarin.Mac, подписывается подпись кода Apple.

При тестировании и отладке, вы будете использовать версию приложения Xamarin.Mac подписан (который будет использоваться для создания приложения контейнера). Позже Если требуется протестировать или установить из магазина Apple будут подписаны подписи Apple и не запустится (поскольку он не имеет сигнатуру код исходного приложения контейнера). В этом случае вы получите отчет о сбоях следующего вида:

```csharp
Exception Type:  EXC_BAD_INSTRUCTION (SIGILL)
```

Чтобы устранить эту проблему, необходимо настроить запись ACL, чтобы она указывала на Apple подписанную версию приложения.

Дополнительные сведения о создании и загрузке профилей подготовки, необходимые для изолирования см. в разделе [подписи и подготовительного приложение](#Signing_and_Provisioning_the_App) выше.

#### <a name="adjusting-the-acl-entry"></a>Настройка записи ACL

Чтобы разрешить Apple подписанную версию Xamarin.Mac приложение для запуска, выполните следующее:

1. Откройте приложение "Терминал" (в `/Applications/Utilities`).
2. Откройте окно поиска до версии знаком Apple Xamarin.Mac приложения.
3. Тип `asctl container acl add -file ` в окне терминала.
4. Перетащите значок приложения Xamarin.Mac из окна поиска и разместите его в окне терминала.
5. Полный путь к файлу будет добавлен в команду терминалов.
6. Нажмите клавишу **ввод** для выполнения команды.

ACL контейнера теперь содержит требования к указанного кода для обеих версий приложения Xamarin.Mac и macOS обеспечит для выполнения любой из версий.

#### <a name="display-a-list-of-acl-code-requirements"></a>Отобразить список ACL требования к коду

Список требований, код можно просмотреть в списке ACL контейнера следующим образом:

1. Откройте приложение "Терминал" (в `/Applications/Utilities`).
2. Введите `asctl container acl list -bundle <container-name>`.
3. Нажмите клавишу **ввод** для выполнения команды.

`<container-name>` Обычно является идентификатор пакета для приложения Xamarin.Mac.

## <a name="designing-a-xamarinmac-app-for-the-app-sandbox"></a>Разработка приложения Xamarin.Mac для приложения "песочницы"

Нет общих рабочий процесс, который следует выполнить при разработке приложения Xamarin.Mac для приложения "песочницы". С другой стороны, будет особенности реализации "песочницы" в приложении должно быть уникальным для данного приложения его функциональность.

### <a name="six-steps-for-adopting-the-app-sandbox"></a>Шесть шагов перехода приложения "песочницы"

Разработка приложения Xamarin.Mac для изолированного приложения обычно состоит из следующих действий:

1. Определите, подходит ли приложение для "песочницы".
2. Разработка стратегии разработки и распространения.
3. В случае несовместимости любого API.
4. Применить к проекту Xamarin.Mac необходимых прав "песочницы" для приложения.
5. Добавьте с помощью XPC Разделение прав доступа.
6. Реализуйте стратегию миграции.

> [!IMPORTANT]
> Необходимо не только песочница основного исполняемого файла в комплект приложения, но также каждые включены вспомогательного приложения или средства в этом пакете. Это требуется для любого приложения, распределенных в магазине приложений Mac и, если это возможно, необходимо выполнить для любой другой формы распространения приложений.

Список всех исполняемых двоичных файлов в приложении Xamarin.Mac пакет введите следующую команду в терминала:

```bash
find -H [Your-App-Bundle].app -print0 | xargs -0 file | grep "Mach-O .*executable"
```

Где `[Your-App-Bundle]` — имя и путь к пакету приложения.

### <a name="determine-whether-a-xamarinmac-app-is-suitable-for-sandboxing"></a>Определить, является ли приложение Xamarin.Mac подходит для "песочницы"

Большинство приложений Xamarin.Mac полностью совместимы с изолированного приложения и, следовательно, подходящий для "песочницы". Если приложению требуется поведение, которое не разрешается использовать приложение "песочницы", следует рассмотреть Альтернативным подходом.

Если вашему приложению требуется один из следующих вариантов поведения, он не совместим с App "песочницы":

- **Службы авторизации** -с помощью приложений "песочнице", не может работать с функциями, описанной в [Справочник по C авторизации служб](https://developer.apple.com/library/prerelease/mac/documentation/Security/Reference/authorization_ref/index.html#//apple_ref/doc/uid/TP30000826).
- **Специальные возможности API-интерфейсы** -нельзя "песочницы" вспомогательные приложения, такие как средства чтения с экрана или приложений, управления другими приложениями.
- **Отправлять события Apple произвольный приложений** -Если приложению требуется отправки событий Apple неизвестны, произвольный приложения, не может быть изолированного. Список известных вызываемой приложений приложение по-прежнему может быть изолированных и правами, которые необходимо включать список вызываемой приложений.
- **Отправить сведения о пользовательских словарей в уведомлениях распределенных другие задачи** -с помощью приложений "песочнице", не может включать `userInfo` словаря, помещая в `NSDistributedNotificationCenter` объекта для обмена сообщениями с другими задачами.
- **Загрузить расширения ядра** -Загрузка ядра расширения запрещена изоляцией приложения.
- **Имитация ввода пользователя открыть, сохранить выше** — программными средствами обработки открыть или сохранить диалоговые окна для имитации или alter ввод данных пользователем запрещенные изоляцией приложения.
- **Получение или установка параметров для других приложений,** -изменения параметров других приложений запрещено изоляцией приложения.
- **Настройка параметров сети** -обработка параметров сети запрещено изоляцией приложения.
- **Завершение другие приложения** -приложений "песочнице" запрещает использование `NSRunningApplication` для завершения других приложений.

### <a name="resolving-api-incompatibilities"></a>Устранение несовместимости API

При разработке приложения Xamarin.Mac для изолированного приложения, могут возникнуть несовместимость с использованием некоторых macOS API-интерфейсы.

Ниже приведены несколько распространенных проблем и факторов и способы их решения.

- **Открытие, сохранение и отслеживание документов** — Если вы управляете документы, используя любую технологию, отличный от `NSDocument`, следует перейти к нему, благодаря встроенной поддержке для приложения "песочницы". `NSDocument` автоматически работает с PowerBox и обеспечивает поддержку для сохранения документов в изолированную среду при их перемещении в средстве поиска.
- **Сохраните доступ к файловым ресурсам системы** — Если Xamarin.Mac, приложение зависит от постоянный доступ к ресурсам за пределами своего контейнера, с помощью закладок уровня безопасности для сохранения доступа.
- **Создание элемента имени входа для приложения** -с помощью приложений "песочнице", не удается создать элемент с помощью имени входа `LSSharedFileList` и не управлять состояние запуска служб с помощью `LSRegisterURL`. Используйте `SMLoginItemSetEnabled` работать так, как описано в яблоки [Добавление элементов входа в систему, используя инфраструктуру службы управления](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLoginItems.html#//apple_ref/doc/uid/10000172i-SW5-SW1) документации.
- **Доступ к данным пользователя** — при использовании функции POSIX, таких как `getpwuid` для получения домашний каталог пользователя из службы каталогов, рекомендуется использовать символы Cocoa или основу, такой как `NSHomeDirectory`.
- **Доступ к предпочтения другие приложения** — так как "песочницы" приложение направляет путь поиск API-интерфейсы для приложения-контейнера, изменение настроек имеет место этого контейнера и доступа к ним другим приложениям предпочтения в не допускается. 
- **Использование HTML5 внедренное видео в веб-представления** -Xamarin.Mac приложение использует WebKit для воспроизведения внедренное видео HTML5, необходимо также связать приложение на платформе framework AV Foundation. Приложение "песочницы" сделает невозможным CoreMedia play видеоролики, в противном случае.

### <a name="applying-required-app-sandbox-entitlements"></a>Применение необходимых прав приложения "песочницы"

Необходимо будет изменить права для любого Xamarin.Mac приложения, которое требуется для запуска в изолированной среде приложение и проверьте **включить приложение песочницы** флажок.

На основе функциональности приложения, может потребоваться для включения других прав для доступа к возможности операционной системы или ресурсов. Приложения «песочницы» для лучше при свертывании прав, запрос на минимальные необходимые для запуска приложения, поэтому случайным образом включите права.

Чтобы определить, какие права Xamarin.Mac приложению, выполните следующие действия.

1. Включить изолированную приложения и запустить приложение Xamarin.Mac.
2. Запуск с помощью возможностей приложения.
3. Откройте консольное приложение (в `/Applications/Utilities`) и выполните поиск `sandboxd` нарушений в **все сообщения** журнала.
4. Для каждого `sandboxd` нарушение, устраните проблему с помощью контейнера приложения вместо других расположений файловой системы или применить прав приложения "песочницы", чтобы разрешить доступ к ограниченные возможности операционной системы.
5. Повторно запустите и выполните повторную проверку всех функций приложения Xamarin.Mac.
6. Пока все повторения `sandboxd` нарушений были устранены.

### <a name="add-privilege-separation-using-xpc"></a>Добавление с помощью XPC Разделение прав доступа

При разработке приложения Xamarin.Mac для приложения "песочницы", проверьте поведения приложения в терминах права доступа и доступа, а затем можно выделить операций с высоким риском в свои собственные XPC службы.

Дополнительные сведения см. в разделе Apple [Создание службы XPC](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html#//apple_ref/doc/uid/10000172i-SW6) и [управляющие программы и руководство по программированию служб](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/Introduction.html#//apple_ref/doc/uid/10000172i).

### <a name="implement-a-migration-strategy"></a>Реализовать стратегию миграции

Выпущено новое изолированное версия Xamarin.Mac приложение, которое не было ранее изолированного, необходимо обеспечить плавного порядка обновления текущих пользователей. 

 Дополнительные сведения о том, как реализовать манифеста миграции контейнера чтения Apple [миграция приложения в "песочнице"](https://developer.apple.com/library/prerelease/mac/documentation/Security/Conceptual/AppSandboxDesignGuide/MigratingALegacyApp/MigratingAnAppToASandbox.html#//apple_ref/doc/uid/TP40011183-CH6-SW1) документации.

## <a name="summary"></a>Сводка

В этой статье были предприняты никакие подробное рассмотрение функции «песочницы» для приложения Xamarin.Mac. Во-первых мы создали просто Xamarin.Mac приложение демонстрирует основные приложения "песочницы". Далее мы были рассмотрены способы устранения нарушений "песочницы". Затем мы воспользовались подробные рассмотрим приложение "песочницы" и наконец, мы рассмотрели проектирование приложения Xamarin.Mac для приложения "песочницы".



## <a name="related-links"></a>Связанные ссылки

- [Публикация в App Store](~/mac/deploy-test/publishing-to-the-app-store/index.md)
- [О App "песочницы"](https://developer.apple.com/library/content/documentation/Security/Conceptual/AppSandboxDesignGuide/AboutAppSandbox/AboutAppSandbox.html)
- [Распространенные проблемы «песочницы» для приложения](https://developer.apple.com/library/content/qa/qa1773/_index.html)
