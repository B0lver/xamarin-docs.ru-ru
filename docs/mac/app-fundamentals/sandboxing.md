---
title: Песочница приложения Xamarin.Mac
description: В этой статье рассматриваются песочница приложения Xamarin.Mac для выпуска в App Store. Он включает в себя все элементы, которые необходимо выполнить в "песочницы", такие как каталоги контейнера, назначения, определенного пользователем разрешения, разделение привилегий и принудительного применения ядра.
ms.prod: xamarin
ms.assetid: 06A2CA8D-1E46-410F-8C31-00EA36F0735D
ms.technology: xamarin-mac
author: lobrien
ms.author: laobri
ms.date: 03/14/2017
ms.openlocfilehash: 6bf2f63e944e178d80f76fe363ef24410ff052ce
ms.sourcegitcommit: 4b402d1c508fa84e4fc3171a6e43b811323948fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61237107"
---
# <a name="sandboxing-a-xamarinmac-app"></a>Песочница приложения Xamarin.Mac

_В этой статье рассматриваются песочница приложения Xamarin.Mac для выпуска в App Store. Он включает в себя все элементы, которые необходимо выполнить в "песочницы", такие как каталоги контейнера, назначения, определенного пользователем разрешения, разделение привилегий и принудительного применения ядра._

## <a name="overview"></a>Обзор

При работе с C# и .NET в приложении Xamarin.Mac, как это делается при работе с Objective-C или Swift имеют такие же возможности "песочницы" приложения.

[![Пример запущенного приложения](sandboxing-images/intro01.png "пример запущенного приложения")](sandboxing-images/intro01-large.png#lightbox)

В этой статье мы рассмотрим основы работы с "песочницы" в приложении Xamarin.Mac и все элементы, которые необходимо выполнить в "песочницы": каталоги контейнера, назначения, определенного пользователем разрешения, разделение привилегий и принудительного применения ядра. Настоятельно рекомендуется работать через [Привет, Mac](~/mac/get-started/hello-mac.md) статьи, во-первых, в частности [введение в Xcode и конструкторе Interface Builder](~/mac/get-started/hello-mac.md#introduction-to-xcode-and-interface-builder) и [переменных экземпляров и действий](~/mac/get-started/hello-mac.md#outlets-and-actions) разделы, так как он рассматриваются основные понятия и методы, которые мы будем использовать в этой статье.

Может потребоваться взгляните на [предоставление C# классы / методы Objective-c](~/mac/internals/how-it-works.md) раздел [структуре Xamarin.Mac](~/mac/internals/how-it-works.md) документа, он объясняет `Register` и `Export` атрибуты используется для привязывания классов C# к объектам Objective-C и пользовательского интерфейса элементов.

## <a name="about-the-app-sandbox"></a>О "песочница" приложений

"Песочница" приложений обеспечивает надежный защиты от повреждений, которые могут быть вызваны вредоносное приложение выполняется на компьютере Mac, ограничивая доступ приложения к системным ресурсам.

Изолированное приложение имеет полные права пользователя, на котором выполняется приложение и доступа или все, что пользователь может сделать. Если приложение содержит бреши в системе безопасности (или любой платформы, которой он используется), злоумышленник потенциально можно воспользоваться этими слабыми местами и контролировать, на котором он выполняется на компьютере Mac с помощью приложения.

Ограничивая доступ к ресурсам на основе каждого приложения, приложения «песочницы» предоставляет линию обороны против кражи, повреждения или злоумышленниками со стороны приложения, запущенного на компьютере пользователя.

"Песочница" приложений — это технология управления доступом, встроенные в macOS (применяется на уровне ядра), который предоставляет стратегию этого две причины:

1. "Песочница" приложений позволяет разработчику для описания _как_ приложение будет взаимодействовать с операционной Системой и, таким образом, он предоставляется только права доступа, необходимые для выполнения работы и ничего более.
2. "Песочница" приложений позволяет легко предоставить дальнейший доступ к системе через открытия сохранить диалоговые окна и перетащите операций и взаимодействия с другими, общих пользователем.

### <a name="preparing-to-implement-the-app-sandbox"></a>Подготовка к реализации "песочница" приложений

Далее приведены элементы будут обсуждаться подробно в статье "песочница" приложений.

- Каталоги контейнера
- Права
- Разрешения, определенного пользователем
- Разделение прав доступа
- Принудительное применение ядра

Изучив эти сведения, вы сможете создать план для внедрения "песочница" приложений в приложении Xamarin.Mac.

Во-первых необходимо определить, если приложение является хорошим кандидатом для "песочницы" (большинство приложений доступно). Далее необходимо устранить все проблемы совместимости API и решить, какие элементы "песочница" приложений будет проводиться. Наконец рассмотрите возможность применения разделение привилегий для обеспечения максимальной защиты уровня приложения.

При внедрении "песочница" приложений, некоторые файловой системы, которые приложение использует будет отличаться. В частности приложение будет иметь контейнерный каталог, который будет использоваться для поддержки файлов приложения, базы данных, кэшей и другие файлы, которые не являются документы пользователя. MacOS и Xcode обеспечивают поддержку для переноса этих типов файлов из их расположений прежних версий в контейнер.

## <a name="sandboxing-quick-start"></a>Быстрый запуск "песочницы"

В этом разделе мы создадим простое приложение Xamarin.Mac, которое использует веб-представление (для которого требуется сетевое подключение, для которого ограничены в разделе "песочницы", если запрошенный) в качестве примера Приступая к работе с "песочница" приложений.

Мы проверим, что приложение фактически изолированным и узнайте, как определить и устранить распространенные ошибки "песочница" приложений.

### <a name="creating-the-xamarinmac-project"></a>Создание проекта Xamarin.Mac

Давайте, выполните следующие действия для создания наш пример проекта.

1. Запустите Visual Studio для Mac и нажмите кнопку **новое решение...** .
2. Из **новый проект** выберите **Mac** > **приложения** > **приложение Cocoa**: 

    [![Создание нового приложения Cocoa](sandboxing-images/sample01.png "Создание нового приложения Cocoa")](sandboxing-images/sample01-large.png#lightbox)
3. Нажмите кнопку **Далее** , введите `MacSandbox` имя проекта и нажмите кнопку **создать** кнопки: 

    [![Введите имя приложения](sandboxing-images/sample02.png "ввод имени приложения")](sandboxing-images/sample02-large.png#lightbox)
4. В **панели решения**, дважды щелкните **Main.storyboard** файл, чтобы открыть его для редактирования в Xcode: 

    [![Изменение основной раскадровки](sandboxing-images/sample03.png "редактирования основной раскадровки")](sandboxing-images/sample03-large.png#lightbox)
5. Перетащите **веб-представление** в окно, измените его размер для заполнения области содержимого и настройте его для увеличения и сжатия с окном: 

    [![Добавление веб-представление](sandboxing-images/sample04.png "Добавление веб-представление")](sandboxing-images/sample04-large.png#lightbox)
6. Создание переменной экземпляра для веб-страницы вызывается `webView`: 

    [![Создание нового розетки](sandboxing-images/sample05.png "Создание новой переменной экземпляра")](sandboxing-images/sample05-large.png#lightbox)
7. Вернитесь в Visual Studio для Mac и дважды щелкните файл **ViewController.cs** файл **панели решения** чтобы открыть его для редактирования.
8. Добавьте следующий оператор using: `using WebKit;`
9. Сделать `ViewDidLoad` внешний метод следующим образом: 

```csharp
public override void AwakeFromNib ()
{
    base.AwakeFromNib ();
    webView.MainFrame.LoadRequest(new NSUrlRequest(new NSUrl("http://www.apple.com")));
}
```

10. Сохраните изменения.

Запуск приложения и убедитесь, что веб-сайте Apple отображается в окне, как показано ниже:

[![Отображение выполнения пример приложения](sandboxing-images/sample06.png "отображение выполнения пример приложения")](sandboxing-images/sample06-large.png#lightbox)

<a name="Signing_and_Provisioning_the_App" />

### <a name="signing-and-provisioning-the-app"></a>Подписывание и Подготовка приложения

Прежде чем мы можем включить "песочница" приложений, необходимо сначала подготовить и подписать приложение Xamarin.Mac.

Позвольте сделайте следующее:

1. Войдите на портал разработчика Apple: 

    [![Вход на портал разработчиков Apple](sandboxing-images/sign01.png "войти на портал разработчиков Apple")](sandboxing-images/sign01-large.png#lightbox)
2. Выберите **сертификаты, идентификаторы и профили**: 

    [![Выбор сертификатов, идентификаторов и профилей](sandboxing-images/sign02.png "Выбор сертификатов, идентификаторов и профилей")](sandboxing-images/sign02-large.png#lightbox)
3. В разделе **приложений Mac**выберите **идентификаторы**: 

    [![Выбрав идентификаторы](sandboxing-images/sign03.png "выбора идентификаторов")](sandboxing-images/sign03-large.png#lightbox)
4. Создайте новый идентификатор для приложения: 

    [![Создание нового идентификатора приложения](sandboxing-images/sign04.png "Создание нового идентификатора приложения")](sandboxing-images/sign04-large.png#lightbox)
5. В разделе **профили подготовки**выберите **разработки**: 

    [![Выбрав разработки](sandboxing-images/sign05.png "выбрав разработки")](sandboxing-images/sign05-large.png#lightbox)
6. Создайте новый профиль и выберите **разработка приложений для Mac**: 

    [![Создание профиля](sandboxing-images/sign06.png "Создание профиля")](sandboxing-images/sign06-large.png#lightbox)
7. Выберите идентификатор приложения, мы создали выше: 

    [![Выбор идентификатора приложения](sandboxing-images/sign07.png "выбор идентификатора приложения")](sandboxing-images/sign07-large.png#lightbox)
8. Выберите разработчиков для этого профиля: 

    [![Добавление разработчиков](sandboxing-images/sign08.png "Добавление разработчиков")](sandboxing-images/sign08-large.png#lightbox)
9. Выберите компьютеры, для этого профиля: 

    [![Выбор разрешенных компьютеров](sandboxing-images/sign09.png "Выбор разрешенных компьютеров")](sandboxing-images/sign09-large.png#lightbox)
10. Присвойте имя профиля: 

    [![Задав имя профиля](sandboxing-images/sign10.png "присвоить имя профиля")](sandboxing-images/sign10-large.png#lightbox)
11. Нажмите кнопку **сделать** кнопки.

> [!IMPORTANT]
> В некоторых случаях может потребоваться загрузить новый профиль подготовки на портале разработчика Apple напрямую и дважды щелкните его, чтобы установить. Также может потребоваться остановить и перезапустить Visual Studio для Mac, прежде чем он будет иметь возможность доступа к нового профиля.

Далее нам нужно загрузить новый идентификатор приложения и профиль на компьютере разработчика. Давайте, сделайте следующее:

1. Запустите Xcode и выберите **предпочтения** из **Xcode** меню: 

    ![Изменение учетных записей в Xcode](sandboxing-images/sign11.png "редактирование учетных записей в Xcode")
2. Щелкните **просмотра сведений...**  кнопки: 

    ![Нажав кнопку Просмотр сведений о](sandboxing-images/sign12.png "кнопку Просмотр сведений")
3. Щелкните **обновить** кнопки (в левом нижнем углу).
4. Щелкните **сделать** кнопки.

Далее нам необходимо выбрать новый идентификатор приложения и профиль подготовки в наш проект Xamarin.Mac. Давайте, сделайте следующее:

1. В **панели решения**, дважды щелкните **Info.plist** файл, чтобы открыть его для редактирования.
2. Убедитесь, что **идентификатор пакета** соответствует наш идентификатор приложения, мы создали выше (пример: `com.appracatappra.MacSandbox`): 

    [![Изменение идентификатора пакета](sandboxing-images/sign13.png "редактирования идентификатор пакета")](sandboxing-images/sign13-large.png#lightbox)
3. Далее дважды щелкните **Entitlements.plist** файл и убедитесь, наши **iCloud Store ключ-значение** и **контейнеры iCloud** соответствовать всем наш идентификатор приложения, мы создали выше (пример: `com.appracatappra.MacSandbox`): 

    [![Редактирование файла Entitlements.plist](sandboxing-images/sign17.png "редактирования файла Entitlements.plist")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения.
4. В **панели решения**, дважды щелкните файл проекта, чтобы открыть его параметры для редактирования:  

    ![Editign параметры решения](sandboxing-images/sign14.png "Editign параметры решения")
5. Выберите **подписывание Mac**, затем проверьте **подписывания пакета приложения** и **подписать пакет установщика**. В разделе **профиль подготовки**, выберите ту, мы создали выше: 

    ![Установка профиля подготовки](sandboxing-images/sign15.png "Установка профиля подготовки")
6. Нажмите кнопку **сделать** кнопки.

> [!IMPORTANT]
> Может потребоваться перезапустить Visual Studio для Mac получить ее распознать новый идентификатор приложения и профиль подготовки, который был установлен в Xcode.

#### <a name="troubleshooting-provisioning-issues"></a>Устранение неполадок подготовки

На этом этапе следует попытаться запустить приложение и убедитесь, что все, что подписана и подготовлен неправильно. Если приложение по-прежнему работает как и раньше, все ли. В случае сбоя может появиться диалоговое окно, аналогичный приведенному ниже:

[![Пример проблемы диалоговое окно подготовки](sandboxing-images/sign16.png "пример проблемы диалоговое окно подготовки")](sandboxing-images/sign16-large.png#lightbox)

Ниже приведены наиболее распространенные причины подготовки и подписывания проблемы.

- Идентификатор пакета приложения не соответствует Идентификатору выбранного профиля.
- Идентификатор разработчика не соответствует идентификатора разработчика выбранного профиля.
- UUID протестированы на компьютере Mac не зарегистрировано как часть выбранного профиля.

В случае проблемы устранить ее на портале разработчика Apple, обновите профили в Xcode и выполнения чистой сборки в Visual Studio для Mac.

### <a name="enable-the-app-sandbox"></a>Включить "песочница" приложений

"Песочница" приложений включить, установив флажок в параметрах проектах. Выполните следующие действия:

1. В **панели решения**, дважды щелкните **Entitlements.plist** файл, чтобы открыть его для редактирования.
2. Выберите оба варианта **включите права** и **включить приложение "песочницы"**: 

    [![Редактирование назначений и включение "песочницы"](sandboxing-images/sign17.png "редактирование назначений и включение \"песочницы\"")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения.

На этом этапе вы включили "песочница" приложений, но вы не предоставили требуется сетевой доступ для веб-представление. Если запустить приложение сейчас, должен отобразиться пустое окно.

[![Отображение веб-доступ блокируется](sandboxing-images/sample08.png "отображение блокирования доступа в Интернет")](sandboxing-images/sample08-large.png#lightbox)

### <a name="verifying-that-the-app-is-sandboxed"></a>Проверка того, что приложения хранятся в изолированной среде

Помимо ресурсов, поведение блокировки существуют три основных способа сообщить, если был успешно изолированного приложения Xamarin.Mac:

1. В средстве поиска, проверьте содержимое `~/Library/Containers/` папка — Если приложения хранятся в изолированной среде, будет существовать папка с именем, например идентификатор пакета приложения (пример: `com.appracatappra.MacSandbox`): 

    [![Открытие пакета приложения](sandboxing-images/sample09.png "открытия пакета приложения")](sandboxing-images/sample09-large.png#lightbox)
2. Система считает приложение изолированной в мониторе активности:
    - Запустить монитор активности (в разделе `/Applications/Utilities`). 
    - Выберите **представление** > **столбцы** и убедитесь, что **"песочницы"** отмечен пункт меню.
    - Убедитесь, что в столбце "песочницы" считывает `Yes` для вашего приложения: 

    [![Проверка приложения в мониторе активности](sandboxing-images/sample10.png "проверку приложения в мониторе активности")](sandboxing-images/sample10-large.png#lightbox)
3. Убедитесь, что приложение двоичный изолированной:
    - Запустите приложение "Терминал".
    - Перейдите к приложениям `bin` каталога.
    - Выполните эту команду: `codesign -dvvv --entitlements :- executable_path` (где `executable_path` — это путь к приложению): 

    [![Проверка приложения в командной строке](sandboxing-images/sample11.png "проверку приложения в командной строке")](sandboxing-images/sample11-large.png#lightbox)

### <a name="debugging-a-sandboxed-app"></a>Отладка приложения «песочницы»

Отладчик подключается к приложений Xamarin.Mac по протоколу TCP, это означает, что по умолчанию при включении "песочницы", он не сможет подключиться к приложению, поэтому при попытке запустить приложение без необходимых разрешений, которые включены, отобразится сообщение об ошибке *«не удалось подключиться к отладчик»*. 

[![Задайте необходимые параметры](sandboxing-images/debug01.png "задайте необходимые параметры")](sandboxing-images/debug01-large.png#lightbox)

**Разрешить исходящих сетевых подключений (клиент)** разрешение является требуется для отладчика, включение этой позволит отладку в обычном режиме. Так как не удается выполнить отладку без него, мы обновили `CompileEntitlements` целевого объекта для `msbuild` для автоматического добавления этого разрешения права доступа для любого приложения, хранятся в изолированной среде отладки только сборок. Сборки выпуска следует использовать права, указанные в файле прав, без изменений.

### <a name="resolving-an-app-sandbox-violation"></a>Разрешение нарушение "песочница" приложений

Приложение "песочницы" нарушение Если изолированной Xamarin.Mac, приложение пытается получить доступ к ресурсу, который содержит запрещено явным образом. Например, наш веб-представление, невозможность для отображения веб-сайте Apple.

Наиболее распространенный источник нарушения "песочницы" приложения происходит, когда параметры, права, указанные в Visual Studio для Mac не соответствуют требованиям приложения. Опять же обратно к нашему примеру, отсутствует сетевое подключение права, которые обеспечивают работу веб-представление.

#### <a name="discovering-app-sandbox-violations"></a>Обнаружение нарушений "песочница" приложений

Если вы подозреваете, что происходит нарушение прав приложения "песочницы" в приложении Xamarin.Mac, самый быстрый способ обнаружили проблему при помощи **консоли** приложения.

Выполните следующие действия:

1. Скомпилируйте приложение и запустите его из Visual Studio для Mac.
2. Откройте **консоли** приложения (из `/Applications/Utilties/`).
3. Выберите **все сообщения** на боковой панели и ввод `sandbox` при поиске: 

    [![Пример проблемы "песочницы" в консоли](sandboxing-images/resolve01.png "пример проблемы \"песочницы\" в консоли")](sandboxing-images/resolve01-large.png#lightbox)

Для наших приведенное выше приложение, вы можете увидеть, что блокируется Kernal `network-outbound` трафика из-за "песочница" приложений, так как не был запрошен, это право.

#### <a name="fixing-app-sandbox-violations-with-entitlements"></a>Устранение нарушений с назначениями "песочница" приложений

Теперь, когда мы увидели, как найти приложение "песочницы" нарушения, давайте посмотрим, как они могут быть устранены путем настройки прав приложения.

Выполните следующие действия:

1. В **панели решения**, дважды щелкните **Entitlements.plist** файл, чтобы открыть его для редактирования.
2. В разделе **прав** установите флажок **разрешить исходящих сетевых подключений (клиент)** флажок: 

    [![Редактирование назначений](sandboxing-images/sign17.png "редактирование назначений")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения в приложение.

Если мы выполнить оба действия для нашего примера приложения, затем постройте и запустите его, веб-содержимое теперь отображается должным образом.

## <a name="the-app-sandbox-in-depth"></a>"Песочница" приложений подробные

Механизмы управления доступом, предоставляемые "песочница" приложений несколько и легкими для понимания. Тем не менее так, что каждое приложение будет развернуто "песочница" приложений должно быть уникальным и зависимости от требований приложения.

Учитывая все усилия для защиты приложения Xamarin.Mac, предотвращающие вредоносным кодом, должны существовать только одного уязвимостей в любом приложении (или одну из библиотек или платформ он использует) получение контроля над взаимодействия приложения с помощью система.

"Песочница" приложений была разработана для предотвращения смену (или ограничения ущерба, это может привести к), позволяя указать предполагаемого взаимодействия приложения с системой. Система будет предоставлять только доступ к вашему приложению для выполнения его работы ресурса и ничего более.

При разработке для "песочница" приложений, разработке для худшем. Если приложение скомпрометирован, вредоносный код, ограничен доступ к только те файлы и ресурсы в изолированной среде приложения.

### <a name="entitlements-and-system-resource-access"></a>Права и доступ к ресурсам системы

Как было показано выше, приложения Xamarin.Mac, которое не было изолированной предоставляется полный доступ и доступ пользователя, на котором выполняется приложение. Если нарушена вредоносным кодом, незащищенные приложения может действовать как агент для опасного поведения с широким, диапазоне потенциальных для причинения ущерба.

Включив "песочница" приложений, удалите все, кроме минимального набора прав доступа, который вы затем повторно включить на необходимость только использование прав приложения Xamarin.Mac. 

Изменение ресурсов "песочницы" приложения для приложения, изменив его **Entitlements.plist** файла и проверка или выбрав права, необходимые из раскрывающихся списков редакторы:

[![Редактирование назначений](sandboxing-images/sign17.png "редактирование назначений")](sandboxing-images/sign17-large.png#lightbox)

### <a name="container-directories-and-file-system-access"></a>Каталоги контейнера и доступ к файловой системе

Когда приложение Xamarin.Mac принимает "песочница" приложений, он получает доступ в следующих расположениях:

- **Контейнерный каталог приложения** -при первом запуске, операционная система создает специальный _контейнерный каталог_ там, где все ее ресурсы перейти, только его доступность. Приложение получит доступ на чтение и запись в этот каталог.
- **Каталоги контейнера группы приложения** -приложение может быть предоставлен доступ к одному или нескольким _групповым контейнерам_ , общих для приложений в той же группе.
- **Пользовательские файлы** -приложение автоматически получает доступ к файлам, которые являются явно открыт или перетащить на приложения пользователем.
- **Связанные элементы** -с соответствующие права, приложение может иметь доступ к файлу с тем же именем, но с другим расширением. Например, документ, который был сохранен как `.txt` файл и `.pdf`.
- **Временные папки, каталоги средство командной строки и определенных расположений по всему миру для чтения** -приложение имеет различными уровнями доступа к файлам в других четко определенных местах, как указано в системе.

#### <a name="the-app-container-directory"></a>Контейнерный каталог приложения

Приложения App контейнерный каталог имеет следующие характеристики:

- Он находится в расположении, скрытые в домашнем каталоге пользователя (обычно `~Library/Containers`) и может осуществляться с помощью `NSHomeDirectory` функция (см. ниже) в приложении. Так как он находится в домашнем каталоге, каждый пользователь получит собственный контейнер для приложения.
- Приложение имеет неограниченный доступ на чтение/запись к контейнерный каталог и все его подкаталоги и файлы в нем.
- Большинство API-интерфейсов для macOS на поиск пути указываются относительно контейнера приложения. Например, контейнер будет иметь свой собственный **библиотеки** (полученной `NSLibraryDirectory`), **поддержки приложения** и **предпочтения** подкаталоги.
- macOS устанавливает и приводит к образованию связи между и приложение и его контейнера с помощью подписи кода. Даже пытается другого приложения подделать приложения с помощью его **идентификатор пакета**, его нельзя будет получить доступ к контейнеру из-за подписывания кода.
- Контейнер не для файлов, созданные пользователем. Вместо этого он используется для файлов, используемые приложением, например баз данных, кэшей или других определенных типов данных.
- Для _shoebox_ типов приложений (например, приложение по обмену фотографиями Apple), содержимое пользователя будет отправлена в контейнер.

> [!IMPORTANT]
> К сожалению, Xamarin.Mac не имеет 100% покрытия API еще (в отличие от Xamarin.iOS), в результате `NSHomeDirectory` API не сопоставлен в текущей версии Xamarin.Mac.

В качестве временного решения можно использовать следующий код:

```csharp
[System.Runtime.InteropServices.DllImport("/System/Library/Frameworks/Foundation.framework/Foundation")]
public static extern IntPtr NSHomeDirectory();

public static string ContainerDirectory {
    get {
        return ((NSString)ObjCRuntime.Runtime.GetNSObject(NSHomeDirectory())).ToString ();
        }
}
```

#### <a name="the-app-group-container-directory"></a>Контейнерный каталог группы приложений

Начиная с Mac macOS 10.7.5 (и выше), приложение может использовать `com.apple.security.application-groups` прав на доступ к общей контейнер, который является общим для всех приложений в группе. Можно использовать этот общий контейнер для содержимого с выходом не написанный пользователем, например базы данных или других типов файлов поддержки (например, кэши).

Группа контейнеров автоматически добавляются в контейнер "песочницы" для каждого приложения (если они являются частью группы) и хранятся на `~/Library/Group Containers/<application-group-id>`. Идентификатор группы _необходимо_ начинаются с идентификатора вашей команды разработки и период, например:

```plist
<team-id>.com.company.<group-name>
```

Дополнительные сведения см. в разделе Apple [Добавление приложения в группу приложения](https://developer.apple.com/library/prerelease/mac/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) в [Справочник по ключам назначений](https://developer.apple.com/library/prerelease/mac/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/AboutEntitlements.html#//apple_ref/doc/uid/TP40011195).

#### <a name="powerbox-and-file-system-access-outside-of-the-app-container"></a>Доступ к системе Powerbox и файл вне контейнера приложения

Изолированное приложение Xamarin.Mac можно получить доступ к файловой системы за пределами своего контейнера одним из следующих способов:

- В определенном направлении пользователя (через открыть и сохранить диалоговые окна или другие методы, такие как перетаскивание).
- С помощью прав для определенной файловой системы (такие как `/bin` или `/usr/lib`).
* Если папка в файловой системе находится в некоторые каталоги, world для чтения (например, общий доступ).

_Powerbox_ — macOS технология безопасности, который взаимодействует с пользователем, чтобы расширить права доступа для файла изолированного приложения Xamarin.Mac. Powerbox имеет интерфейс API, но прозрачно активируется, когда приложение вызывает `NSOpenPanel` или `NSSavePanel`. Доступ Powerbox включается с помощью прав, указанных для приложения Xamarin.Mac.

Когда приложения «песочницы» отображает открытый или диалоговое окно сохранения, окно представляется Powerbox (и не AppKit) и поэтому имеет доступ к любой файл или каталог, к которым имеет доступ к.

Когда пользователь выбирает из открытого файла или каталога или диалоговое окно сохранения (или перетаскивает либо на значок приложения), "песочница" приложений Powerbox добавляет соответствующий путь.

Кроме того система автоматически разрешает следующую команду, чтобы приложения «песочницы»:

- Метод ввода для подключения к системе.
- Вызов служб, выбранного пользователем из **служб** меню (только для служб с пометкой _безопасным для приложения "песочницы"_ поставщиком услуг).
- Выберите открытые файлы пользователем из **открыть последние** меню.
- Используйте копирование и вставка между другими приложениями.
- Чтение файлов из следующих расположений для чтения world:
    - `/bin`
    - `/sbin`
    - `/usr/bin`
    - `/usr/lib`
    - `/usr/sbin`
    - `/usr/share`
    - `/System`
- Чтение и запись файлов в каталоги, созданные `NSTemporaryDirectory`.

По умолчанию файлы открыть или сохранить, изолированного приложения Xamarin.Mac останутся доступными, пока не завершит работу приложения, (если файл был по-прежнему открыт в том случае, когда приложение завершает работу). Открытых файлов будет автоматически восстановлен для "песочницы" приложения с помощью функции Resume macOS при следующем запуске приложения.

Для обеспечения сохраняемости к файлам, находящимся за пределами контейнера приложения Xamarin.Mac, с помощью закладок, области безопасности (см. ниже).

#### <a name="related-items"></a>Связанные элементы

"Песочница" приложений позволяет приложению получить доступ к связанных элементов, которые с одинаковыми именами, но разными расширениями. Компонент состоит из двух частей:) список связанных расширений в приложении `Info.plst` файл (б) код, чтобы сказать «песочнице», что приложение будет делать с этими файлами.

Существует два сценария, где это имеет смысл:

1. Приложение должно иметь возможность сохранить другую версию файла (с расширением новый). Например, экспорт `.txt` файл `.pdf` файл. Чтобы решить эту проблему, необходимо использовать `NSFileCoordinator` для доступа к файлу. Вы вызовете `WillMove(fromURL, toURL)` метод сначала переместите файл в новое расширение и затем вызвать `ItemMoved(fromURL, toURL)`.
2. Приложение должно открыть основной файл с расширением один и несколько вспомогательных файлов с разными расширениями. Для этого фильма и файл субтитров. Используйте `NSFilePresenter` для получения доступа к вторичный файл. Укажите основной файл для `PrimaryPresentedItemURL` свойство и дополнительный файл `PresentedItemURL` свойство. Если основной файл открыт, вызовите `AddFilePresenter` метод `NSFileCoordinator` класса для регистрации дополнительного файла.

В обоих случаях приложение в **Info.plist** файл должен объявлять типы документов, которое может открыть приложение. Для файлов любого типа, добавьте `NSIsRelatedItemType` (со значением `YES`) для его записи в `CFBundleDocumentTypes` массива.

#### <a name="open-and-save-dialog-behavior-with-sandboxed-apps"></a>Открытие и сохранение поведения диалогового окна с помощью изолированного приложения

Ниже приведены ограничения, помещаются на `NSOpenPanel` и `NSSavePanel` при их вызове из изолированного приложения Xamarin.Mac:

- Не удается вызвать программно **ОК** кнопки.
- Невозможно программно изменить выбор пользователя в `NSOpenSavePanelDelegate`.

Кроме того следующие изменения наследования, в месте:

- **Приложения без «песочницы»** - `NSOpenPanel` `NSSavePanel``NSPanel``NSWindow``NSResponder``NSObject``NSOpenPanel``NSSavePanel``NSObject``NSOpenPanel``NSSavePanel`

### <a name="security-scoped-bookmarks-and-persistent-resource-access"></a>Закладки, уровня безопасности и доступа к ресурсам постоянных

Как уже говорилось, изолированного приложения можно получить доступ к файла или ресурса за пределами своего контейнера посредством прямого взаимодействия с пользователем (как PowerBox). Тем не менее доступ к этим ресурсам не сохраняются автоматически между запусков приложений или системы перезапусков.

С помощью _Security-Scoped закладки_, можно сохранить намерения пользователя и сохранять доступ к заданным ресурсам после приложения перезапустите изолированного приложения.

#### <a name="security-scoped-bookmark-types"></a>Закладка уровня безопасности типов

При работе с Security-Scoped закладок и постоянного доступа к ресурсам, существует два варианта использования sistine:

- **Закладка App-Scoped предоставляет постоянный доступ к пользовательской файла или папки.** 

    Например, если изолированного приложения Xamarin.Mac позволяет открывать во внешний документ для редактирования (с помощью `NSOpenPanel`), приложение можно создать закладку App-Scoped таким образом, он может получить доступ к тот же файл в будущем.
- **Закладка Document-Scoped предоставляет постоянный доступ конкретным документом вложенный файл.** 

Например видео редактирования приложение, которое создает файл проекта, который имеет доступ к отдельных изображений, видеороликов и звуковые файлы, которые позже будут объединены в единый фильм.

Когда пользователь импортирует файл ресурсов в проект (через `NSOpenPanel`), приложение создает Document-Scoped закладку для элемента, который хранится в проекте, чтобы он всегда доступные приложению.

Закладка Document-Scoped можно устранить, любое приложение, которое можно открыть данные закладки и сам документ. Это поддерживает переносимость, что позволяет пользователю отправлять файлы проекта на другой пользователь и увидеть все закладки также работать для них.

> [!IMPORTANT]
> Закладка Document-Scoped можно _только_ пункты одного файла, а не папкой, и этот файл не может быть в расположении, используемые системой (например `/private` или `/Library`).

#### <a name="using-security-scoped-bookmarks"></a>Использование закладок, области безопасности

С помощью любого типа Security-Scoped закладку, необходимо выполните следующие действия:

1. **Задайте соответствующие права доступа в приложении Xamarin.Mac, который должен использовать закладки Security-Scoped** -For App-Scoped закладки, задайте `com.apple.security.files.bookmarks.app-scope` назначение ключа `true`. Закладки Document-Scoped задать `com.apple.security.files.bookmarks.document-scope` назначение ключа `true`.
2. **Создать закладку Security-Scoped** -это реализуется для любого файла или папки, доступ к назначенной пользователем (через `NSOpenPanel` например), что приложению потребуется постоянный доступ к. Используйте `public virtual NSData CreateBookmarkData (NSUrlBookmarkCreationOptions options, string[] resourceValues, NSUrl relativeUrl, out NSError error)` метод `NSUrl` класса для создания закладки.
3. **Разрешить закладки Security-Scoped** — Если приложению требуется доступ к ресурсу еще раз (например, после перезагрузки) его нужно будет разрешить закладку на URL-адрес уровня безопасности. Используйте `public static NSUrl FromBookmarkData (NSData data, NSUrlBookmarkResolutionOptions options, NSUrl relativeToUrl, out bool isStale, out NSError error)` метод `NSUrl` класс для разрешения закладки.
4. **Явным образом уведомить системы, в которой необходимо получить доступ к файлу с URL-адреса Security-Scoped** - этот шаг необходимо выполнить сразу после получения Security-Scoped URL-адрес выше, или, если позднее потребуется снова получить доступ к ресурсу после того, как Освобожденные ваш доступ к нему. Вызовите `StartAccessingSecurityScopedResource ()` метод `NSUrl` класса для получения доступа к URL-адрес Security-Scoped.
5. **Явно уведомлять, что вы закончите системы, доступ к файлу с URL-адреса Security-Scoped** -как можно скорее, следует сообщать системе, когда приложению больше не нужен доступ к файлу, (например, если пользователь не закроет его). Вызовите `StopAccessingSecurityScopedResource ()` метод `NSUrl` класса, чтобы прекратить доступ к URL-адрес Security-Scoped.

После теряется доступ к ресурсу, необходимо вернуться к шагу 4 еще раз, чтобы восстановить доступ. При перезапуске приложения Xamarin.Mac, необходимо будет вернуться к шагу 3 и повторно разрешить закладки.

> [!IMPORTANT]
> Сбой при освобождении доступ к ресурсам Security-Scoped URL-адрес вызовет утечку ресурсов ядра приложения Xamarin.Mac. Таким образом приложение больше не сможете добавить файловой системы к его контейнеру до его перезапуска.

### <a name="the-app-sandbox-and-code-signing"></a>"Песочница" приложений и подписывание кода

После включения "песочница" приложений и включение конкретных требований для приложения Xamarin.Mac (с помощью прав), необходимо закодировать знак проекта для "песочницы" вступили в силу. Необходимо выполнить подписи, так как связанные права, необходимые для приложения "песочницы" подпись приложения кода. 

macOS обеспечивает связь между контейнер приложения и его подпись кода, таким образом, никакие другие приложения могут обращаться к этот контейнер, даже если подменяет приложения идентификатор пакета. Этот механизм работает следующим образом:

1. Когда система создает контейнер приложения, он устанавливает _список управления доступом_ (ACL) на этом контейнере. Исходный элемент управления в списке содержит приложение _назначенному требование_ (DR), описывающей как будущих версий приложения можно распознать (когда он будет обновлен).
2. Каждый раз, запускает приложение с таким же Идентификатором пакета, система проверяет соответствие указанных требованиям, указанным в одну из записей в ACL контейнера подписи кода приложения. Если системе не удается найти совпадение, предотвращает запуск приложения.

Code Signing works следующих способов:

1. Перед созданием проекта Xamarin.Mac, получите сертификат разработки, распространения сертификат и сертификат идентификатора разработчика на портале разработчика Apple.
2. Когда Mac App Store распределяет приложения Xamarin.Mac, она была подписана подпись кода Apple.

При тестировании и отладке, будем использовать версию приложения Xamarin.Mac, автоматический (который будет использоваться для создания контейнера приложения). Позже Если вы хотите протестировать или установить из Apple App Store, будут подписаны подписи Apple и не будет запущен (поскольку он не имеет от исходного контейнера приложения подписи кода). В этом случае вы получите отчет о сбоях следующего вида:

```csharp
Exception Type:  EXC_BAD_INSTRUCTION (SIGILL)
```

Чтобы устранить эту проблему, необходимо настроить запись ACL, чтобы они указывали Apple подписанную версию приложения.

Дополнительные сведения о создании и загрузке профилей подготовки, необходимые для "песочницы", см. в разделе [подписывания и подготовки приложения](#Signing_and_Provisioning_the_App) предыдущем разделе.

#### <a name="adjusting-the-acl-entry"></a>Настройка записи ACL

Чтобы разрешить Apple подписанную версию приложения Xamarin.Mac для запуска, сделайте следующее:

1. Откройте приложение "Терминал" (в `/Applications/Utilities`).
2. Откройте окно Finder для Apple подписанную версию приложения Xamarin.Mac.
3. Тип `asctl container acl add -file ` в окне терминала.
4. Перетащите значок приложения Xamarin.Mac из окна поиска и разместите его в окне терминала.
5. Полный путь к файлу будет добавляться в команду в терминале.
6. Нажмите клавишу **ввод** для выполнения команды.

ACL контейнера теперь содержит указанный код требования к обеим версиям приложения Xamarin.Mac и macOS теперь позволяет любой из версий для запуска.

#### <a name="display-a-list-of-acl-code-requirements"></a>Отобразить список требований к коду ACL

Можно просмотреть список требований к коду в ACL контейнера, сделав следующее:

1. Откройте приложение "Терминал" (в `/Applications/Utilities`).
2. Введите `asctl container acl list -bundle <container-name>`.
3. Нажмите клавишу **ввод** для выполнения команды.

`<container-name>` Обычно является идентификатор пакета для приложения Xamarin.Mac.

## <a name="designing-a-xamarinmac-app-for-the-app-sandbox"></a>Разработка приложения Xamarin.Mac для "песочница" приложений

Нет общих рабочего процесса, которые необходимо соблюдать при разработке приложения Xamarin.Mac для "песочница" приложений. С другой стороны, будет особенности реализации "песочницы" в приложении должно быть уникальным для данного приложения его функциональность.

### <a name="six-steps-for-adopting-the-app-sandbox"></a>Шесть шагов заимствования "песочница" приложений

Разработка приложения Xamarin.Mac для "песочница" приложений обычно состоит из следующих действий:

1. Определите, подходит ли приложение для "песочницы".
2. Разработайте стратегию разработки и распространения.
3. Разрешить все несовместимости API.
4. Применить необходимые назначения приложения "песочницы" в проект Xamarin.Mac.
5. Добавьте с помощью XPC разделение привилегий.
6. Реализуйте стратегию миграции.

> [!IMPORTANT]
> Необходимо не только "песочницы" основного исполняемого файла в набор приложений, но также каждые включены вспомогательные приложения или средство в этом пакете. Это является обязательным для любого приложения, полученные из Mac App Store и, если это возможно, необходимо сделать для любой другой форме распространение приложений.

Список всех исполняемых двоичных файлов в пакете приложения Xamarin.Mac введите следующую команду в окне терминала:

```bash
find -H [Your-App-Bundle].app -print0 | xargs -0 file | grep "Mach-O .*executable"
```

Где `[Your-App-Bundle]` — это имя и путь к пакету приложения.

### <a name="determine-whether-a-xamarinmac-app-is-suitable-for-sandboxing"></a>Определить, подходит ли приложение Xamarin.Mac для "песочницы"

Большинство приложений Xamarin.Mac полностью совместимы с "песочница" приложений и, следовательно, подходящий для "песочницы". Если приложению требуется поведение, которое не допускает "песочница" приложений, следует рассмотреть альтернативный подход.

Если вашему приложению требуется один из следующих вариантов поведения, он не совместим с "песочница" приложений:

- **Службы авторизации** -с "песочница" приложений, не может работать с функциями, рассматриваемыми в [Справочник по C службы авторизации](https://developer.apple.com/library/prerelease/mac/documentation/Security/Reference/authorization_ref/index.html#//apple_ref/doc/uid/TP30000826).
- **Специальные возможности API-интерфейсы** -нельзя "песочницы" специальных приложений, таких как средства чтения с экрана или приложений, которые управляют другими приложениями.
- **Отправка событий Apple в произвольных приложений** — Если приложению требуется отправки событий Apple неизвестны, произвольное приложение, не может быть изолированной. Перечень известных вызываемой приложений приложение по-прежнему может быть изолированной и права доступа, необходимо включить список именем приложения.
- **Отправка сведений о пользовательских словарях в уведомлениях, распределенных в другие задачи** -с "песочница" приложений, не может включать `userInfo` словарь при отправке сообщения `NSDistributedNotificationCenter` объект для обмена сообщениями других задач.
- **Загрузить расширения ядра** -Загрузка ядра расширения запрещена "песочница" приложений.
- **Имитация ввода пользователя на открытие и сохранение диалоговые окна** - программными средствами управления открыть или сохранить диалоговые окна для имитации или alter ввод данных пользователем запрещена "песочница" приложений.
- **Получение или Установка настроек в других приложениях** -изменения параметров других приложений запрещена "песочница" приложений.
- **Настройка параметров сети** -управление параметры сети запрещена "песочница" приложений.
- **Завершает работу других приложений** -запрещает "песочница" приложений с помощью `NSRunningApplication` завершить другие приложения.

### <a name="resolving-api-incompatibilities"></a>Устранение несовместимости API

При разработке приложения Xamarin.Mac для "песочница" приложений, могут возникнуть несовместимости с использование некоторых macOS API-интерфейсы.

Ниже приведены несколько распространенных проблем и действия, которые можно выполнить их решения.

- **Открытие, сохранение и отслеживание документов** — Если вы управляете документов с помощью любой технологии, отличное от `NSDocument`, следует перейти к нему из-за встроенная поддержка "песочница" приложений. `NSDocument` автоматически работает с PowerBox и обеспечивает поддержку для хранения документов в изолированную среду, если пользователь переместит их в средстве поиска.
- **Сохранение доступа к системным ресурсам файл** — Если Xamarin.Mac, приложение зависит от постоянный доступ к ресурсам за пределами своего контейнера, использование закладок, уровня безопасности для обеспечения доступа.
- **Создание элемента имени входа для приложения** -с "песочница" приложений, не удается создать элемент с помощью имени входа `LSSharedFileList` и не могут управлять состояние запуска служб с помощью `LSRegisterURL`. Используйте `SMLoginItemSetEnabled` работать так, как описано в яблоки [Добавление элементов входа в систему, используя платформу управления службы](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLoginItems.html#//apple_ref/doc/uid/10000172i-SW5-SW1) документации.
- **Доступ к данным пользователя** — при использовании функции POSIX, такие как `getpwuid` для получения домашний каталог пользователя из службы каталогов, рекомендуется использовать Cocoa или основу символов, такой как `NSHomeDirectory`.
- **Доступ к предпочтения другие приложения** — так как "песочница" приложений направляет путь поиска API-интерфейсы в контейнер приложения, изменение настроек выполняется в этом контейнере и доступ к другим настройкам приложений в, даже если не допускается. 
- **С помощью внедренного видео HTML5 на веб-представления** -приложения Xamarin.Mac WebKit использует для воспроизведения внедренное видео HTML5, необходимо также связать приложения с платформы AV Foundation. "Песочница" приложений будет препятствовать CoreMedia play видеоролики, в противном случае.

### <a name="applying-required-app-sandbox-entitlements"></a>Применяя те же права "песочница" приложений

Вам потребуется изменить права доступа к любого приложения Xamarin.Mac, которое требуется для запуска в изолированной среде приложения и проверьте **включить приложение "песочницы"** флажок.

На основе функциональности приложения, может потребоваться включить другие права на доступ к функции ОС или ресурсам. Приложение "песочницы" оптимизирована для работы при свертывании права доступа, запрос на минимальные необходимые для запуска приложения, поэтому просто случайно включите права.

Чтобы определить, какие права Xamarin.Mac, приложению требуется, сделайте следующее:

1. Включите "песочница" приложений и запуск приложения Xamarin.Mac.
2. Запуск с помощью возможностей приложения.
3. Откройте консольное приложение (в `/Applications/Utilities`) и найдите `sandboxd` нарушений в **все сообщения** журнала.
4. Для каждого `sandboxd` нарушение, устраните проблему с помощью контейнера приложения вместо других расположений файловой системы или применения прав приложения "песочницы", чтобы разрешить доступ к ограниченные возможности операционной системы.
5. Повторно запустите и протестируйте все функции приложения Xamarin.Mac еще раз.
6. Повтора, пока все `sandboxd` нарушений, которые были разрешены.

### <a name="add-privilege-separation-using-xpc"></a>Добавить с помощью XPC разделение привилегий

При разработке приложения Xamarin.Mac для "песочница" приложений, рассмотрим поведение приложения в терминах привилегий и доступа, а затем попробуйте отделить операций с высоким риском в свои собственные службы XPC.

Дополнительные сведения см. в разделе Apple [создание служб XPC](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html#//apple_ref/doc/uid/10000172i-SW6) и [управляющие программы и руководство по программированию служб](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/Introduction.html#//apple_ref/doc/uid/10000172i).

### <a name="implement-a-migration-strategy"></a>Реализуйте стратегию миграции

Если вы выпускаете новые изолированной версию приложения Xamarin.Mac, который не был ранее изолированной, необходимо обеспечить плавный путь обновления для текущих пользователей. 

 Дополнительные сведения о том, как реализовать манифеста миграции контейнера чтение Apple [миграции приложения для песочницы](https://developer.apple.com/library/prerelease/mac/documentation/Security/Conceptual/AppSandboxDesignGuide/MigratingALegacyApp/MigratingAnAppToASandbox.html#//apple_ref/doc/uid/TP40011183-CH6-SW1) документации.

## <a name="summary"></a>Сводка

В этой статье были предприняты никакие подробно рассматривались "песочницы" в приложении Xamarin.Mac. Во-первых мы создали приложения Xamarin.Mac просто показать основы "песочница" приложений. Далее мы показали, как для устранения нарушения "песочницы". Затем мы воспользовались подробно рассмотрим "песочница" приложений, и наконец, мы рассмотрели проектирование приложения Xamarin.Mac для "песочница" приложений.



## <a name="related-links"></a>Связанные ссылки

- [Публикация в App Store](~/mac/deploy-test/publishing-to-the-app-store/index.md)
- [О "песочница" приложений](https://developer.apple.com/library/content/documentation/Security/Conceptual/AppSandboxDesignGuide/AboutAppSandbox/AboutAppSandbox.html)
- [Распространенные проблемы приложения "песочницы"](https://developer.apple.com/library/content/qa/qa1773/_index.html)
