---
title: Использование Team City с Xamarin
description: В этом руководстве будут обсуждаться шаги, связанные с использованием TeamCity для компиляции мобильных приложений, а затем представить их в App Center Test.
ms.prod: xamarin
ms.assetid: AC2626CB-28A7-4808-B2A9-789D67899546
author: davidortinau
ms.author: daortin
ms.date: 04/01/2020
ms.openlocfilehash: 6ecd453180e8c392ba7d7527778617eb40950a9e
ms.sourcegitcommit: 6f3281a32017cfcebadde8a2d6e10651a277828f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2020
ms.locfileid: "80587465"
---
# <a name="using-team-city-with-xamarin"></a>Использование Team City с Xamarin

_В этом руководстве будут обсуждаться шаги, связанные с использованием TeamCity для компиляции мобильных приложений, а затем представить их в App Center Test._

Как говорится в руководстве [по внедрению в непрерывную интеграцию,](~/tools/ci/intro-to-ci.md) непрерывная интеграция (CI) является полезной практикой при разработке качественных мобильных приложений. Есть много жизнеспособных вариантов для непрерывной интеграции серверного программного обеспечения; это руководство будет сосредоточено на [TeamCity](https://www.jetbrains.com/teamcity/) от JetBrains.

Есть несколько различных перестановок установки TeamCity. В следующем списке описаны некоторые из этих перестановок:

- **Служба Windows** — В этом сценарии TeamCity запускается, когда Windows загружается как служба Windows. Он должен быть в паре с Mac Build Host для компиляции любых приложений iOS.

- **Запуск Daemon на OS X** - Концептуально, это похоже на работает как служба Windows описано в предыдущем шаге. По умолчанию сборки будут работать под корневой учетной записью.

- **Учетная запись пользователя на OS X** - Можно запустить TeamCity под учетную запись пользователя, которая запускается каждый раз, когда пользователь входит в систему.

Из предыдущих сценариев, запуск TeamCity под учетной записью пользователя на OS X является самым простым и простым в настройке.

Существует несколько шагов, связанных с созданием TeamCity:

- **Установка TeamCity** - Установка TeamCity не рассматривается в этом руководстве. Это руководство предполагает, что TeamCity устанавливается и работает под учетной записью пользователя. Инструкции по [установке TeamCity](https://confluence.jetbrains.com/display/TCD8/Installation) можно найти в [документации TeamCity 8](https://confluence.jetbrains.com/display/TCD8/TeamCity+Documentation) от JetBrains.

- **Подготовка сервера сборки** – Этот шаг включает в себя установку необходимого программного обеспечения, инструментов и сертификатов, необходимых для создания мобильных приложений и подготовки их к распространению.

- **Создание сценария сборки** — Этот шаг не является строго необходимым, но сценарий сборки является полезным подслащанием для создания приложений без присмотра. Использование сценария сборки поможет с устранением неполадок в сборке, которые могут возникнуть, и обеспечит последовательный, повторяемый способ создания файларий для дистрибутива, даже если непрерывная интеграция не практикуется.

- **Создание проекта TeamCity** - После завершения предыдущих трех шагов мы должны создать проект TeamCity, который будет содержать все метаданные, необходимые для получения исходного кода, компиляции проектов и отправки тестов в App Center Test.

## <a name="requirements"></a>Требования

Необходим опыт работы с [тестом App Center.](https://docs.microsoft.com/appcenter/test-cloud/)

Знакомство с TeamCity 8.1 не требуется. Установка TeamCity выходит за рамки настоящего документа. Предполагается, что TeamCity устанавливается на OS X Mavericks и работает под обычной учетной записью пользователя, а не корневой учетной записью.

Сервер сборки должен быть автономным компьютером под управлением OS X, который предназначен для непрерывной интеграции. В идеале сервер сборки не будет отвечать за другие роли, такие как сервер базы данных, веб-сервер или рабочая станция разработчика.

> [!IMPORTANT]
> Это руководство не охватывает "безголовый" установки Xamarin.

[!include[](~/tools/ci/includes/firewall-information.md)]

## <a name="preparing-the-build-server"></a>Подготовка сервера сборки

Важным шагом в настройке сервера сборки является установка всех необходимых инструментов, программного обеспечения и сертификатов для создания мобильных приложений. Важно, чтобы сервер сборки мог компилировать мобильное решение и запускать любые тесты. Чтобы свести к минимуму проблемы с конфигурацией, программное обеспечение и инструменты должны быть установлены в той же учетной записи пользователя, которая размещает TeamCity. В следующем списке подробно описано, что требуется:

1. **Визуальная студия для Mac** - Это включает в себя Xamarin.iOS и Xamarin.Android.
2. **Войдите в магазин компонентов Xamarin** - Этот шаг является необязательным и требуется только в том случае, если приложение использует компоненты из магазина Xamarin Component. Проактивный вход в хранилище компонентов в этот момент предотвратит любые проблемы, когда сборка TeamCity попытается компилировать приложение.
3. **Xcode** - Xcode необходим для компиляции и подписания приложений iOS.
4. **Xcode Command-Line Tools** - Это описано в шаге 1 раздела Установки Updating Ruby с руководством [rbenv.](https://github.com/calabash/calabash-ios/wiki)
5. **Подписание идентификационных & профилей предоставления** - Импорт сертификатов и профилей подготовки через XCode. Для получения более подробной информации о руководстве Apple по [экспорту идентификационных данных и профилей подготовки подписей смотрите руководство Apple по экспорту подписных удостоверений и профилей подготовки.](https://developer.apple.com/library/ios/recipes/xcode_help-accounts_preferences/articles/export_signing_assets.html)
6. **Android Keystores** - Копировать необходимые ключевые магазины Android в каталоге, `~/Documents/keystores/MyAndroidApp1`к доступу к которому имеет доступ пользователь TeamCity, т.е. .
7. **Calabash** - Это необязательный шаг, если ваше приложение имеет тесты, написанные с использованием Calabash. Для получения дополнительной информации смотрите [руководство по установке Calabash на OS X Mavericks](https://github.com/calabash/calabash-ios/wiki) и updating Ruby с руководством [rbenv.](https://github.com/calabash/calabash-ios/wiki)

Следующая диаграмма иллюстрирует все эти компоненты:

![](teamcity-images/image1.png "This diagram illustrates all of these components")

После установки всего программного обеспечения войдите в учетную запись пользователя и подтвердите, что все программное обеспечение правильно установлено и работает. Это должно включать в себя компиляцию решения и отправку приложения в App Center Test. Это можно упростить, запустив сценарий сборки, как описано в следующем разделе.

## <a name="create-a-build-script"></a>Создание сценария сборки

Хотя TeamCity может самостоятельно обрабатывать все аспекты компиляции и отправки мобильных приложений на App Center Test; рекомендуется создать сценарий сборки. Скрипт сборки обеспечивает следующие преимущества:

1. **Документация** — Сценарий сборки служит формой документации о том, как строится программное обеспечение. Это устраняет некоторые "волшебство", связанное с развертыванием приложения, и позволяет разработчикам сосредоточиться на функциональности.
1. **Повторяемость** — Сценарий сборки гарантирует, что каждый раз, когда приложение компилируется и развертывается, это происходит одинаково, независимо от того, кто или что выполняет работу. Эта повторяемая согласованность устраняет любые проблемы или ошибки, которые могут появиться из-за неправильно выполненной сборки или человеческой ошибки.
1. **Версия** — Скрипт сборки может быть включен в систему управления исходным источником. Это означает, что изменения в скрипте сборки можно отслеживать, отслеживать и исправлять при обнаружении ошибок или неточностей.
1. **Подготовка среды** - Сценарий сборки может включать логику для установки любых необходимых зависимостей третьей стороны. Это гарантирует, что приложения построены с соответствующими компонентами.

Сценарий сборки может быть таким же простым, как файл PowerShell (на Windows) или скрипт Bash (на OS X). При создании сценария сборки существует несколько вариантов языков сценариев:

- [**Rake**](https://github.com/jimweirich/rake) - это язык домена-специфического (DSL) для строительных проектов, основанных на Ruby. Грабли имеет преимущество популярности и богатую экосистему библиотек.

- [**psake**](https://github.com/psake/psake) - это библиотека Windows PowerShell для создания программного обеспечения

- [**FAKE**](https://fsharp.github.io/FAKE/) - это DSL, базирующийся в F, который позволяет использовать существующие библиотеки .NET в случае необходимости.

Какой язык скриптов используется, зависит от ваших предпочтений и требований.

> [!NOTE]
> Можно использовать систему сборки на основе XML, такую как MSBuild или NAnt, но в них отсутствует выразительность и удобство DSL, который посвящен созданию программного обеспечения.

### <a name="parameterizing-the-build-script"></a>Параметрыализация сценария сборки

Процесс создания и тестирования программного обеспечения требует информации, которая должна храниться в тайне. Для создания APK может потребоваться пароль для магазина ключей и/или псевдоним ключа в магазине ключей. Аналогичным образом, App Center Test требует [aPI-ключа,](/appcenter/api-docs/) который является уникальным для разработчика. Эти типы значений не должны быть жестко закодированы в скрипте сборки. Вместо этого они должны быть переданы в качестве переменных для сценария сборки.

Менее чувствительны такие значения, как iOS идентификатор устройства или идентификатор устройства Android, которые определяют, какие устройства App Center следует использовать для тестовых запусков. Это не значения, которые должны быть защищены, но они могут измениться от сборки к сборке.

Хранение этих типов переменных за пределами скрипта сборки также упрощает совместное представление скрипта сборки в организации, например, с разработчиками. Разработчики могут использовать точно такой же сценарий, как сервер сборки, но могут использовать свои собственные клавиатуры и [клавиши API.](/appcenter/api-docs/)

Существует два возможных варианта хранения этих чувствительных значений:

- **Файл конфигурации** - Для защиты [ключа API](/appcenter/api-docs/) это значение не должно быть проверено в управлении версиями. Файл может быть создан для каждой машины. Способ чтения значений из этого файла зависит от используемого языка скриптов.

- **Переменные среды** - они могут быть легко установлены на основе на машине и не зависят от основного языка скриптов.

Есть преимущества и недостатки в каждом из этих вариантов. TeamCity хорошо работает с переменными среды, поэтому это руководство будет рекомендовать этот метод при создании скриптов сборки.

### <a name="build-steps"></a>Строить шаги

Скрипт сборки должен выполнять следующие действия:

- **Составить приложение** - Это включает в себя подписание приложения с правильным профилем подготовки.

- **Отправить приложение в Xamarin Test Cloud** - Это включает в себя подписание и zip выравнивание APK с соответствующим ключевым магазином.

Эти два шага будут объяснены более подробно ниже.

#### <a name="compiling-a-xamarinios-application"></a>Составление приложения Xamarin.iOS

[!include[](~/tools/ci/includes/commandline-compile-of-xamarin-ios-ipa.md)]

#### <a name="compiling-a-xamarinandroid-application"></a>Составление приложения Xamarin.Android

Для компиляции приложения для Android используйте **xbuild** (или **msbuild** на Windows):

```bash
/Library/Frameworks/Mono.framework/Commands/xbuild /t:SignAndroidPackage /p:Configuration=Release /path/to/android.csproj
```
Компиляция приложения **Android xbuild** использует проект, в то время как приложение iOS **xbuild** использует решение.

#### <a name="submitting-xamarinuitests-to-app-center"></a>Отправка Xamarin.UITests в App Center

UITests представлены с помощью [App Center CLI](https://github.com/microsoft/appcenter-cli), как показано в следующем фрагменте:

```bash
appcenter test run uitest --app <TEAM-NAME/APP-NAME> --devices <DEVICE_SET> --token <API_KEY> --app-path <appname.APK-or-appname.IPA> --merge-nunit-xml report.xml --build-dir pathToUITestBuildDir
```

При запуске теста результаты теста будут возвращены в виде файла XML-стиля NUnit под названием **report.xml.** TeamCity будет отображать информацию в журнале сборки.

Для получения дополнительной информации о том, как отправить UITests в [Preparing Xamarin.iOS Apps](/appcenter/test-cloud/uitest/preparing-for-upload-ios)App Center, [см.](/appcenter/test-cloud/uitest/preparing-for-upload-android)

#### <a name="submitting-calabash-tests-to-app-center"></a>Отправка calabash испытаний в App Center

Calabash тесты представлены с помощью [App Center CLI](https://github.com/microsoft/appcenter-cli), как показано в следующем фрагменте:

```bash
appcenter test run calabash --app <TEAM-NAME/APP-NAME> --devices <DEVICE_SET> --token <API_KEY> --app-path <appname.APK-or-appname.IPA> --project-dir pathToProjectDir
```

Чтобы отправить приложение для Android в App Center Test, необходимо сначала восстановить тестовый сервер APK с помощью калабаш-андроида:

```bash
$ calabash-android build </path/to/signed/APK>
$ appcenter test run calabash --app <TEAM-NAME/APP-NAME> --devices <DEVICE_SET> --token <API_KEY> --app-path <appname.APK> --project-dir pathToProjectDir
```

Для получения дополнительной информации о представлении Calabash испытаний, обратитесь к Xamarin руководство по [отправке Calabash испытаний для тестирования облака](https://github.com/calabash/calabash-ios/wiki).

## <a name="creating-a-teamcity-project"></a>Создание проекта TeamCity

После установки TeamCity и Visual Studio для Mac может построить ваш проект, пришло время создать проект в TeamCity, чтобы построить проект и представить его в App Center.

1. Начал с входа в TeamCity через веб-браузер. Перейдите к корневому проекту:

    ![Перейдите к корневому проекту](teamcity-images/image2.png "Перейдите к корневому проекту") Под корневым проектом создайте новый подпроект:

    ![Перейдите к корневому проекту под корневым проектом, создайте новый подпроект](teamcity-images/image3.png "Перейдите к корневому проекту под корневым проектом, создайте новый подпроект")
2. Как только подпроект создан, добавьте новую конфигурацию сборки:

    ![Как только подпроект создан, добавьте новую конфигурацию сборки](teamcity-images/image5.png "После создания подпроекта добавьте новую конфигурацию сборки")
3. Прикрепите проект VCS к конфигурации сборки. Это делается через экран настройки управления версией:

    ![Это делается через экран настройки управления версией](teamcity-images/image6.png "Это делается через экран настройки управления версией")

    Если проект VCS не создан, можно создать его на новой странице VCS Root, показанной ниже:

    ![Если нет созданного проекта VCS, можно создать его с новой страницы ROOT VCS](teamcity-images/image7.png "Если проект VCS не создан, у вас есть возможность создать его с новой страницы ROOT VCS")

    После того, как корень VCS был прикреплен, TeamCity проверит проект и попытается автоматически обнаружить шаги сборки. Если вы знакомы с TeamCity, вы можете выбрать один из обнаруженных шагов сборки. Пока можно безообращаться с обнаруженными шагами сборки.

4. Затем настройте триггер сборки. Это приведет к подошве сборки при определенных условиях, например, когда пользователь подчищает код в репозиторий. На следующем скриншоте показано, как добавить триггер сборки:

    ![На этом скриншоте показано, как добавить триггер сборки](teamcity-images/image8.png "На этом скриншоте показано, как добавить триггер сборки") Пример настройки триггера сборки можно увидеть на следующем скриншоте:

    ![Пример настройки триггера сборки можно увидеть на этом скриншоте](teamcity-images/image9.png "Пример настройки триггера сборки можно увидеть на этом скриншоте")

5. В предыдущем разделе, Parameterizing The Build Script, предлагалось хранить некоторые значения в качестве переменных среды. Эти переменные могут быть добавлены к конфигурации сборки через экран параметров. Добавьте переменные для [клавишы API](/appcenter/api-docs/)App Center, идентификатор устройства iOS и идентификатор устройства Android, показанный на скриншоте ниже:

    ![Добавьте переменные для клавишы API-центра App Center, идентификатора устройства iOS и идентификатора устройства Android](teamcity-images/image11.png "Добавьте переменные для идентификатора тестового облачного API, идентификатора устройства iOS и идентификатора устройства Android")

6. Последним шагом является добавление шага сборки, который будет вызывать сценарий сборки для компиляции приложения и приоуэн приложения в App Center Test. Следующий скриншот является примером шага сборки, который использует Rakefile для создания приложения:

    ![Этот скриншот является примером шага сборки, который использует Rakefile для создания приложения](teamcity-images/image12.png "Этот скриншот является примером шага сборки, который использует Rakefile для создания приложения")

7. На этом этапе конфигурация сборки завершена. Рекомендуется запустить сборку, чтобы подтвердить, что проект правильно настроен. Хороший способ сделать это — совершить небольшое, незначительное изменение в репозитории. TeamCity должен обнаружить коммит и начать сборку.

8. После завершения сборки проинспектировать журнал сборки и посмотреть, есть ли какие-либо проблемы или предупреждения с сборкой, которые требуют внимания.

## <a name="summary"></a>Сводка

Это руководство охватывало, как использовать TeamCity для создания мобильных приложений Xamarin, а затем представить их на App Center Test. Мы обсудили создание сценария сборки для автоматизации процесса сборки. Скрипт сборки позаботится о компиляции приложения, отправке в App Center Test и ожидании результатов.

Затем мы рассмотрели, как создать проект в TeamCity, который будет стоять в очереди сборки каждый раз, когда разработчик фиксирует код и будет вызывать сценарий сборки.

## <a name="related-links"></a>Связанные ссылки

- [Подготовка приложений Xamarin.Android](/appcenter/test-cloud/uitest/preparing-for-upload-android)
- [Подготовка приложений Xamarin.iOS](/appcenter/test-cloud/uitest/preparing-for-upload-ios)
- [Установка и настройка TeamCity](https://confluence.jetbrains.com/display/TCD8/Installing+and+Configuring+the+TeamCity+Server)
