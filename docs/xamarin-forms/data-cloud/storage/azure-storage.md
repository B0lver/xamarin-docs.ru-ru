---
title: "Хранение и доступ к данным в хранилище Azure"
description: "Хранилища Azure — это решение масштабируемые облачные хранилища, который может использоваться для хранения данных, структурированные и неструктурированные. В этой статье демонстрируется использование Xamarin.Forms для хранения текст и двоичные данные в хранилище Azure и способах доступа к данным."
ms.topic: article
ms.prod: xamarin
ms.assetid: 5B10D37B-839B-4CD0-9C65-91014A93F3EB
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 06/16/2017
ms.openlocfilehash: d2d85840a0c698bfd3aa01dbacb204072ecca119
ms.sourcegitcommit: 61f5ecc5a2b5dcfbefdef91664d7460c0ee2f357
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2018
---
# <a name="storing-and-accessing-data-in-azure-storage"></a>Хранение и доступ к данным в хранилище Azure

_Хранилища Azure — это решение масштабируемые облачные хранилища, который может использоваться для хранения данных, структурированные и неструктурированные. В этой статье демонстрируется использование Xamarin.Forms для хранения текст и двоичные данные в хранилище Azure и способах доступа к данным._

## <a name="overview"></a>Обзор

Хранилище Azure предоставляет четыре службы хранилища.

- Хранилище больших двоичных объектов. Большой двоичный объект может быть текст или двоичные данные, такие как резервные копии виртуальных машин, файлов мультимедиа и документы.
- Табличное хранилище является хранилищем NoSQL ключевым атрибутом.
- Очереди хранилища является службой обмена сообщениями для обработки рабочего процесса и обмена данными между облачными службами.
- Файл хранилища предоставляет общее хранилище, с помощью протокола SMB.

Существует два типа учетных записей хранения:

- Учетные записи хранения общего назначения предоставляет доступ к службам хранилища Azure из одной учетной записи.
- Учетная запись хранения BLOB-объекта — учетная запись специализированных хранения для хранения больших двоичных объектов. Этот тип учетной записи рекомендуется в том случае, если необходимо хранить данные большого двоичного объекта.

В этой статье, а также пример приложения, сопровождающие демонстрирует отправки файлов изображение и текст для хранилища больших двоичных объектов и загрузить их. Кроме того здесь также показано получение списка файлов из хранилища больших двоичных объектов и удаление файлов.

Дополнительные сведения о хранилище Azure см. в разделе [ознакомление с хранилищем](https://azure.microsoft.com/documentation/articles/storage-introduction/).

## <a name="introduction-to-blob-storage"></a>Введение в хранилище больших двоичных объектов

Хранилище больших двоичных объектов состоит из трех компонентов, которые показаны на следующей схеме:

![](azure-storage-images/blob-storage.png "Основные понятия хранилища больших двоичных объектов")

Весь доступ к службе хранилища Azure выполняется с помощью учетной записи хранилища. Учетная запись хранилища может содержать неограниченное количество контейнеров и в контейнере может храниться неограниченное количество больших двоичных объектов, вплоть до предела емкости учетной записи хранения.

Большой двоичный объект — это файл любого типа и размера. Хранилище Azure поддерживает три типа другой большой двоичный объект.

- Блочные большие двоичные объекты оптимизированы для потоковой передачи и хранения объектов в облаке и оптимально подходят для хранения резервных копий, файлов мультимедиа, документы и т. д. Блочные большие двоичные объекты могут иметь размер до 195 ГБ.
- Добавление похожи на блочных больших двоичных объектов, но оптимизированы для операций, например ведение журнала добавления. Добавление BLOB-объектов может иметь размер до 195 ГБ.
- Страничные большие двоичные объекты оптимизированы для операций часто чтения и записи и обычно используется для хранения виртуальных машин и их диски. Страничные большие двоичные объекты могут быть размером до 1 ТБ.

> [!NOTE]
> Обратите внимание, что учетные записи хранения BLOB-объектов поддерживают блокировку append больших двоичных объектов, но не страничные большие двоичные объекты.

Большой двоичный объект отправляется в хранилище Azure и загрузить из хранилища Azure, как поток байтов. Таким образом файлы необходимо преобразовать в поток байтов до передачи и преобразованный назад в их исходное представление после загрузки.

Каждый объект, который хранится в хранилище Azure имеет уникальный URL-адрес. Имя учетной записи хранения forms поддомена сочетание форм имя дочернего домена и домена и этот адрес *конечная точка* учетной записи хранилища. Например, если имя учетной записи хранения *mystorageaccount*, конечная точка BLOB-объектов по умолчанию для учетной записи хранения `https://mystorageaccount.blob.core.windows.net`.

URL-адрес для доступа к объекту в учетной записи хранилища создается путем добавления расположение объекта в учетной записи хранения в конечную точку. Например, адрес большого двоичного объекта будут иметь формат `https://mystorageaccount.blob.core.windows.net/mycontainer/myblob`.

## <a name="setup"></a>Установка

Интеграция учетную запись хранилища Azure в приложении Xamarin.Forms выполняется следующим образом:

1. Создайте учетную запись хранилища. Дополнительные сведения см. в разделе [создать учетную запись хранилища](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/#create-a-storage-account).
1. Добавить [клиентская библиотека хранилища Azure](https://www.nuget.org/packages/WindowsAzure.Storage/) приложению Xamarin.Forms.
1. Настройка строки подключения хранилища. Дополнительные сведения см. в разделе [подключении к хранилищу Azure](#connecting).
1. Добавить `using` директивы для `Microsoft.WindowsAzure.Storage` и `Microsoft.WindowsAzure.Storage.Blob` пространства имен, классы, которые будут обращаться к службе хранилища Azure.

> [!NOTE]
> Хотя в этом примере используется проект общего доступа, клиентская библиотека хранилища Azure теперь также поддерживает полученное из проекта переносимой библиотеки классов (PCL).

<a name="connecting" />

## <a name="connecting-to-azure-storage"></a>Подключение к хранилищу Azure

Каждый запрос к ресурсам учетной записи хранилища должен пройти проверку подлинности. Хотя большие двоичные объекты можно настроить для поддержки анонимную проверку подлинности, существует два основных подхода, которые приложение может использовать для проверки подлинности с помощью учетной записи хранилища.

- Общий ключ. Этот подход использует хранилище Azure ключ учетной записи имя и учетную запись для доступа к службам хранилища. Учетной записи хранилища назначается два закрытых ключей при создании, который может использоваться для проверки подлинности общего ключа.
- Подписанный URL-адрес. Это маркер, который может быть добавлен к URL-адрес, позволяющий делегированный доступ к ресурсу хранилища, с разрешениями, оно указывает, в течение периода времени, это значение.

Строки подключения можно указать, включают сведения о проверке подлинности, необходимые для доступа к ресурсам хранилища Azure из приложения. Кроме того можно настроить строку подключения для подключения к эмулятору хранилища Azure из Visual Studio.

> [!NOTE]
> Хранилище Azure поддерживает HTTP и HTTPS в строке подключения. Тем не менее рекомендуется использовать протокол HTTPS.

### <a name="connecting-to-the-azure-storage-emulator"></a>Подключение к эмулятору хранилища Azure

Эмулятор хранилища Azure предоставляет локальную среду, эмулирующую Azure BLOB-объектов, очередей и служб таблиц для целей разработки.

Следующая строка подключения должна использоваться для подключения к эмулятору хранилища Azure:

```csharp
UseDevelopmentStorage=true
```

Дополнительные сведения об эмуляторе хранилища Azure см. в разделе [использование эмулятора хранилища Azure для разработки и тестирования](https://azure.microsoft.com/documentation/articles/storage-use-emulator/).

### <a name="connecting-to-azure-storage-using-a-shared-key"></a>Подключение к хранилищу Azure с помощью общего ключа

Следует использовать следующий формат строки соединения для подключения к службе хранилища Azure с общим ключом:

```csharp
DefaultEndpointsProtocol=[http|https];AccountName=myAccountName;AccountKey=myAccountKey
```

`myAccountName` необходимо заменить имя учетной записи и `myAccountKey` должно быть заменено одним из двух ключей доступа учетной записи.

> [!NOTE]
> При использовании общего ключа проверки подлинности, имя учетной записи и ключ учетной записи будут распространены на каждого пользователя, использующего приложения, который будет предоставлять полный чтения и записи доступ к учетной записи хранилища. Таким образом используется проверка подлинности shared key для тестирования и никогда не распространяйте ключи другим пользователям.

### <a name="connecting-to-azure-storage-using-a-shared-access-signature"></a>Подключение к хранилищу Azure с помощью подписи общего доступа

Следует использовать следующий формат строки соединения для подключения к службе хранилища Azure с сопоставлениями безопасности:

`BlobEndpoint=myBlobEndpoint;SharedAccessSignature=mySharedAccessSignature`

`myBlobEndpoint` следует заменить на URL-адрес конечной точки большого двоичного объекта, и `mySharedAccessSignature` следует заменить на ваш SAS. SAS реализует протокол конечной точки службы и учетные данные для доступа к ресурсу.

> [!NOTE]
> Для производственных приложений рекомендуется использовать проверку подлинности SAS. Однако в рабочем приложении подписанного URL-адреса должны быть получены из серверной службы по требованию, а не выполняется в состав приложения.

Дополнительные сведения о подписях общего доступа см. в разделе [с помощью общего доступа подписи (SAS)](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/).

## <a name="creating-a-container"></a>Создание контейнера

`GetContainer` Метод используется для извлечения ссылки на именованный контейнер, который затем используется для получения больших двоичных объектов из контейнера или добавить в контейнер больших двоичных объектов. В следующем примере кода показан `GetContainer` метод:

```csharp
static CloudBlobContainer GetContainer(ContainerType containerType)
{
  var account = CloudStorageAccount.Parse(Constants.StorageConnection);
  var client = account.CreateCloudBlobClient();
  return client.GetContainerReference(containerType.ToString().ToLower());
}
```

`CloudStorageAccount.Parse` Метод выполняет синтаксический анализ строки соединения и возвращает `CloudStorageAccount` экземпляр, который представляет учетную запись хранения. Объект `CloudBlobClient` затем создается экземпляр, который используется для получения контейнеров и больших двоичных объектов, `CreateCloudBlobClient` метод. `GetContainerReference` Метод возвращает указанный контейнер как `CloudBlobContainer` экземпляра, прежде чем оно возвращается вызывающему методу. В этом примере имя контейнера — `ContainerType` значение перечисления, преобразовать строку в нижнем регистре.

> [!NOTE]
> Имена контейнеров должны быть строчными и должно начинаться с буквы или цифры. Кроме того они могут содержать только буквы, цифры и тире и должно находиться в диапазоне от 3 до 63 символов.

`GetContainer` Метод вызывается следующим образом:

```csharp
var container = GetContainer(containerType);
```

`CloudBlobContainer` Экземпляр может затем использоваться для создания контейнера, если он еще не существует:

```csharp
await container.CreateIfNotExistsAsync();
```

По умолчанию только что созданный контейнер является закрытым. Это означает, что ключ доступа к хранилищу должно быть указано для извлечения из контейнера больших двоичных объектов. Сведения о том, как большие двоичные объекты в контейнере открытый см. в разделе [создать контейнер](https://azure.microsoft.com/documentation/articles/storage-dotnet-how-to-use-blobs/#create-a-container).

## <a name="uploading-data-to-a-container"></a>Передача данных в контейнер

`UploadFileAsync` Метод используется для передачи потока байтов данных хранилища больших двоичных объектов и показано в следующем примере кода:

```csharp
public static async Task<string> UploadFileAsync(ContainerType containerType, Stream stream)
{
  var container = GetContainer(containerType);
  await container.CreateIfNotExistsAsync();

  var name = Guid.NewGuid().ToString();
  var fileBlob = container.GetBlockBlobReference(name);
  await fileBlob.UploadFromStreamAsync(stream);

  return name;
}
```

После получения ссылке на контейнер, метод создает контейнер, если он еще не существует. Новый `Guid` создается в качестве имени уникальный больших двоичных объектов, и ссылку на блок больших двоичных объектов извлекается в виде `CloudBlockBlob` экземпляра. Поток данных, затем загружается в BLOB-объекта с помощью `UploadFromStreamAsync` метод, который создает большой двоичный объект, если он еще не существует, или перезаписывает его, если он существует.

Прежде чем файл можно загрузить с помощью этого метода хранилище больших двоичных объектов, его необходимо сначала преобразуется в поток байтов. Это показано в следующем примере кода:

```csharp
var byteData = Encoding.UTF8.GetBytes(text);
uploadedFilename = await AzureStorage.UploadFileAsync(ContainerType.Text, new MemoryStream(byteData));
```

`text` Данные преобразуются в массив байтов, который затем помещается в виде потока, передаваемое `UploadFileAsync` метод.

## <a name="downloading-data-from-a-container"></a>Загрузка данных из контейнера

`GetFileAsync` Метод используется для загрузки данных большого двоичного объекта из хранилища Azure и показано в следующем примере кода:

```csharp
public static async Task<byte[]> GetFileAsync(ContainerType containerType, string name)
{
  var container = GetContainer(containerType);

  var blob = container.GetBlobReference(name);
  if (await blob.ExistsAsync())
  {
    await blob.FetchAttributesAsync();
    byte[] blobBytes = new byte[blob.Properties.Length];

    await blob.DownloadToByteArrayAsync(blobBytes, 0);
    return blobBytes;
  }
  return null;
}
```

После получения ссылке на контейнер, этот метод извлекает ссылку на большой двоичный объект для сохраненных данных. Если большой двоичный объект существует, его свойства извлекаются путем `FetchAttributesAsync` метод. Массив байтов, необходимого размера создается и большой двоичный объект загружается как массив байтов, возвращаемый вызывающему методу.

После загрузки данных байт BLOB-объект, его необходимо преобразовать в исходное представление. Это показано в следующем примере кода:

```csharp
var byteData = await AzureStorage.GetFileAsync(ContainerType.Text, uploadedFilename);
string text = Encoding.UTF8.GetString(byteData);
```

Массив байтов, извлекается из хранилища Azure, `GetFileAsync` метод перед преобразованием обратно в UTF8 кодированную строку.

## <a name="listing-data-in-a-container"></a>Вывод данных в контейнере

`GetFilesListAsync` Метод используется для получения списка больших двоичных объектов, хранящихся в контейнере и показано в следующем примере кода:

```csharp
public static async Task<IList<string>> GetFilesListAsync(ContainerType containerType)
{
  var container = GetContainer(containerType);

  var allBlobsList = new List<string>();
  BlobContinuationToken token = null;

  do
  {
    var result = await container.ListBlobsSegmentedAsync(token);
    if (result.Results.Count() > 0)
    {
      var blobs = result.Results.Cast<CloudBlockBlob>().Select(b => b.Name);
      allBlobsList.AddRange(blobs);
    }
    token = result.ContinuationToken;
  } while (token != null);

  return allBlobsList;
}
```

После получения ссылке на контейнер, этот метод использует контейнера `ListBlobsSegmentedAsync` метод для извлечения ссылки на большие двоичные объекты в контейнере. Результаты, возвращенные `ListBlobsSegmentedAsync` метод перечисляются во время `BlobContinuationToken` экземпляр не `null`. Каждый BLOB-объект приведен из возвращенного `IListBlobItem` для `CloudBlockBlob` в порядке access `Name` добавляется свойство большого двоичного объекта, прежде чем он станет значение `allBlobsList` коллекции. Один раз `BlobContinuationToken` экземпляр `null`возвратила последнее имя BLOB-объекта и выполнение выходит из цикла.

## <a name="deleting-data-from-a-container"></a>Удаление данных из контейнера

`DeleteFileAsync` Метод используется для удаления большого двоичного объекта из контейнера и показано в следующем примере кода:

```csharp
public static async Task<bool> DeleteFileAsync(ContainerType containerType, string name)
{
  var container = GetContainer(containerType);
  var blob = container.GetBlobReference(name);
  return await blob.DeleteIfExistsAsync();
}
```

После получения ссылке на контейнер, метод возвращает ссылку на большой двоичный объект для указанного большого двоичного объекта. Большой двоичный объект удаляется с `DeleteIfExistsAsync` метод.

## <a name="summary"></a>Сводка

В этой статье демонстрируется использование Xamarin.Forms для хранения текст и двоичные данные в хранилище Azure и способах доступа к данным. Хранилища Azure — это решение масштабируемые облачные хранилища, который может использоваться для хранения данных, структурированные и неструктурированные.


## <a name="related-links"></a>Связанные ссылки

- [Хранилище Azure (пример)](https://developer.xamarin.com/samples/xamarin-forms/WebServices/AzureStorage/)
- [Введение в хранилище](https://azure.microsoft.com/documentation/articles/storage-introduction/)
- [Использование хранилища BLOB-объектов из Xamarin](https://azure.microsoft.com/documentation/articles/storage-xamarin-blob-storage/)
- [С помощью подписи коллективного доступа (SAS)](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)
- [Windows Azure хранилища](https://www.nuget.org/packages/WindowsAzure.Storage/)
