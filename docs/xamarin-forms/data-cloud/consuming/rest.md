---
title: "Использование веб-службы RESTful"
description: "Интеграция веб-службы в приложении это очень распространенный сценарий. В этой статье показано, как использовать RESTful веб-службы из приложения Xamarin.Forms."
ms.topic: article
ms.prod: xamarin
ms.assetid: B540910C-9C51-416A-AAB9-057BF76489C3
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 05/22/2017
ms.openlocfilehash: 98c38001ea7751c419d4be5b0f68339b06ec656f
ms.sourcegitcommit: 8e722d72c5d1384889f70adb26c5675544897b1f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2018
---
# <a name="consuming-a-restful-web-service"></a>Использование веб-службы RESTful

_Интеграция веб-службы в приложении это очень распространенный сценарий. В этой статье показано, как использовать RESTful веб-службы из приложения Xamarin.Forms._

Representational State Transfer (REST) представляет собой архитектурный стиль для построения веб-служб. ОСТАЛЬНЫЕ запросы выполняются по протоколу HTTP, используются те же глаголы HTTP, используемых веб-браузеры для получения веб-страниц и отправки данных на серверы. Ниже приведены команды.

- **ПОЛУЧИТЬ** — эта операция используется для получения данных из веб-службы.
- **POST** — эта операция используется для создания нового элемента данных на веб-службы.
- **ПОМЕСТИТЕ** — эта операция используется для обновления элемента данных в веб-службе.
- **ИСПРАВЛЕНИЕ** — эта операция используется для обновления элемента данных на веб-службы, описывающий набор инструкций о том, как изменить элемент. Эта команда не используется в примере приложения.
- **Удалить** — эта операция используется для удаления элемента данных на веб-службы.

API-интерфейсы, которые соответствуют ОСТАЛЬНОЙ называются RESTful API-интерфейсов, а также определяются с помощью веб-службы:

- Базовый URI.
- Методы HTTP, такие как GET, POST, PUT, PATCH или DELETE.
- Тип носителя для данных, таких как JavaScript Object Notation (JSON).

Веб-служб rESTful обычно используется сообщений JSON для возвращения данных клиенту. JSON — это формат обмена данными в текстовых, что создает compact полезных данных, что приводит к ограниченной пропускной способности при отправке данных. В примере приложения используется открытый исходный код [NewtonSoft JSON.NET библиотеки](http://www.newtonsoft.com/json) для сериализации и десериализации сообщений.

Простота REST сделала его основной метод для доступа к веб-служб в мобильных приложениях.

Инструкции по настройке службы REST можно найти в файле readme, сопровождающий пример приложения. Тем не менее при запуске примера приложения, он будет подключаться к службе REST, размещенных в Xamarin, которая предоставляет доступ только для чтения к данным, как показано на следующем снимке экрана:

![](rest-images/portal.png "Образец приложения")

> [!NOTE]
> В iOS 9 и более поздней версии безопасность транспорта приложения (ATS) обеспечивает безопасное соединение между Интернет-ресурсов (например, приложение серверных) и приложения, чтобы предотвратить случайное раскрытие конфиденциальных сведений. Поскольку ATS включена по умолчанию в приложениях, разработанных для iOS 9, все соединения будут применяться ATS требования безопасности. Если соединения не удовлетворяют этим требованиям, произойдет сбой с исключением.
>
>Если это не позволяет использовать ATS могут быть присоединены из **HTTPS** протокола и безопасную передачу Интернет-ресурсов. Это можно сделать путем обновления приложения **Info.plist** файла. Дополнительные сведения см. [безопасность транспорта приложения](~/ios/app-fundamentals/ats.md).

## <a name="consuming-the-web-service"></a>Веб-служба

Службы REST записывается с помощью ASP.NET Core и предоставляет следующие операции:

|Операция|Метод HTTP|Относительный URI|Параметры|
|--- |--- |--- |--- |
|Получить список заданий для выполнения|GET|/API/todoitems /|
|Создать новый элемент задачи|ПОМЕСТИТЬ|/API/todoitems /|TodoItem в формате JSON|
|Задание обновления|PUT|/API/todoitems /|TodoItem в формате JSON|
|Удалить задание|DELETE|/API/todoitems / {id}|

Большая часть URL-адреса включают `TodoItem` идентификатор в пути. Например, чтобы удалить `TodoItem` которого является идентификатор `6bb8a868-dba1-4f1a-93b7-24ebce87e243`, клиент отправляет запрос DELETE для `http://hostname/api/todoitems/6bb8a868-dba1-4f1a-93b7-24ebce87e243`. Дополнительные сведения о модели данных, используемые в образце приложения, см. в разделе [моделирования данных](~/xamarin-forms/data-cloud/walkthrough.md).

Платформа веб-API, получив запрос направляется запрос на действие. Эти действия являются просто открытых методов в `TodoItemsController` класса. Платформа использует таблицу маршрутизации, чтобы определить, какое действие следует вызвать в ответ на запрос, как показано в следующем примере кода:

```csharp
config.Routes.MapHttpRoute(
    name: "TodoItemsApi",
    routeTemplate: "api/{controller}/{id}",
    defaults: new { controller="todoitems", id = RouteParameter.Optional }
);
```

Таблица маршрутизации содержит шаблон маршрута и платформа веб-API, получив запрос HTTP, предпринимается попытка найти URI с шаблоном маршрута в таблице маршрутизации. Если соответствующий маршрут не найден, клиент получает ошибку 404 (не найдено). Если совпадающий маршрут найден, веб-API выбирает контроллер и действие следующим образом:

- Чтобы найти контроллер, веб-API добавляет «controller» значение *{controller}* переменной.
- Чтобы найти действие, веб-API рассматривается метод HTTP и рассматривает действия контроллера, оснащенные с один и тот же метод HTTP, как атрибут.
- *{Id}* переменной местозаполнитель сопоставляется параметр действия.

Службы REST использует обычную проверку подлинности. Дополнительные сведения см. [проверки подлинности веб-службы RESTful](~/xamarin-forms/data-cloud/authentication/rest.md). Дополнительные сведения о маршрутизации веб-API ASP.NET см. в разделе [маршрутизации в ASP.NET Web API](http://www.asp.net/web-api/overview/web-api-routing-and-actions/routing-in-aspnet-web-api) на веб-сайте ASP.NET. Дополнительные сведения о создании службы REST, с помощью ASP.NET Core см. в разделе [Создание серверных служб для собственных мобильных приложений](/aspnet/core/mobile/native-mobile-backend/).

> [!NOTE]
> Образец приложения использует размещенное Xamarin REST службу, которая предоставляет доступ только для чтения к веб-службе. Таким образом операции, которые создание, обновление и удаление данных не изменится данным в приложении. Однако доступна в размещаемом версия службы REST **TodoRESTService** папки в соответствующем [пример кода](https://developer.xamarin.com/samples/xamarin-forms/WebServices/TodoREST/).
> Если размещение службы REST самостоятельно он разрешает полное создание, обновление, чтение и удаление доступа к данным.

`HttpClient` Класс используется для отправки и получения запросов по протоколу HTTP. Он предоставляет функциональные возможности для отправки HTTP-запросов и получения HTTP-ответов от URI определен ресурс. Каждый запрос будет отправлен в качестве асинхронной операции. Дополнительные сведения об асинхронных операциях см. в разделе [Общие сведения о поддержке Async](~/cross-platform/platform/async.md).

`HttpResponseMessage` Класс представляет сообщение ответа HTTP, полученных от веб-службы, после внесения HTTP-запроса. Он содержит сведения об ответе, включая код состояния, заголовки и любой текст. `HttpContent` Класс представляет основного текста HTTP и заголовки содержимого, такие как `Content-Type` и `Content-Encoding`. Содержимое можно просмотреть с помощью любой из `ReadAs` методы, такие как `ReadAsStringAsync` и `ReadAsByteArrayAsync`, в зависимости от формата данных.

### <a name="creating-the-httpclient-object"></a>Создание объекта HTTPClient

`HttpClient` Экземпляр объявлен на уровне класса, чтобы для находятся объекты, при условии, что приложение должно выполнять запросы HTTP, как показано в следующем примере кода:

```csharp
public class RestService : IRestService
{
  HttpClient client;
  ...

  public RestService ()
  {
    client = new HttpClient ();
    client.MaxResponseContentBufferSize = 256000;
  }
  ...
}
```

`HttpClient.MaxResponseContentBufferSize` Свойство позволяет указать максимальное число байтов для буферизации при чтении содержимого в сообщение ответа HTTP. Размер по умолчанию этого свойства является максимальное число является целым числом. Таким образом свойство имеет значение меньше значения, безопасность, чтобы ограничить объем данных, приложение будет принимать ответ от веб-службы.

### <a name="retrieving-data"></a>Получение данных

`HttpClient.GetAsync` Метод используется для отправки запроса GET к веб-службе, указанного в URI и затем получения ответа от веб-службы, как показано в следующем примере кода:

```csharp
public async Task<List<TodoItem>> RefreshDataAsync ()
{
  ...
  // RestUrl = http://developer.xamarin.com:8081/api/todoitems/
  var uri = new Uri (string.Format (Constants.RestUrl, string.Empty));
  ...
  var response = await client.GetAsync (uri);
  if (response.IsSuccessStatusCode) {
      var content = await response.Content.ReadAsStringAsync ();
      Items = JsonConvert.DeserializeObject <List<TodoItem>> (content);
  }
  ...
}
```

Службы REST отправляет код состояния HTTP в `HttpResponseMessage.IsSuccessStatusCode` свойство, которое указывает, успешно ли выполнено HTTP-запроса. Для этой операции REST служба отправляет код состояния HTTP 200 (ОК) в ответ, который указывает, что запрос выполнен успешно и не требуемую информацию в ответе.

После успешного операции HTTP, чтение содержимого ответа для отображения. `HttpResponseMessage.Content` Свойство представляет содержимое HTTP-ответа и `HttpContent.ReadAsStringAsync` метод асинхронно записывает содержимое HTTP на строку. Это содержимое затем преобразуется из JSON, `List` из `TodoItem` экземпляров.

### <a name="creating-data"></a>Создание данных

`HttpClient.PostAsync` Метод используется для отправки запроса POST к веб-службе, указанного в URI, а затем для получения ответа от веб-службы, как показано в следующем примере кода:

```csharp
public async Task SaveTodoItemAsync (TodoItem item, bool isNewItem = false)
{
  // RestUrl = http://developer.xamarin.com:8081/api/todoitems/
  var uri = new Uri (string.Format (Constants.RestUrl, string.Empty));

  ...
  var json = JsonConvert.SerializeObject (item);
  var content = new StringContent (json, Encoding.UTF8, "application/json");

  HttpResponseMessage response = null;
  if (isNewItem) {
    response = await client.PostAsync (uri, content);
  }
  ...

  if (response.IsSuccessStatusCode) {
    Debug.WriteLine (@"             TodoItem successfully saved.");

  }
  ...
}
```

`TodoItem` Экземпляр преобразуется в полезные данные JSON для отправки веб-службы. Эти полезные данные включается в тексте HTTP содержимого, которое будет отправляться в веб-службу, перед запросом с `PostAsync` метод.

Службы REST отправляет код состояния HTTP в `HttpResponseMessage.IsSuccessStatusCode` свойство, которое указывает, успешно ли выполнено HTTP-запроса. Приведены общие ответы для этой операции.

- **201 (СОЗДАНО)** — запрос привел к созданию нового ресурса перед отправкой ответа.
- **400 (НЕПРАВИЛЬНЫЙ запрос)** — запрос не понят сервером.
- **409 (конфликт)** — запрос может не выполняться из-за конфликта на сервере.

### <a name="updating-data"></a>Обновление данных

`HttpClient.PutAsync` Метод используется для отправки веб-службы, указанного в URI запроса PUT и затем получения ответа от веб-службы, как показано в следующем примере кода:

```csharp
public async Task SaveTodoItemAsync (TodoItem item, bool isNewItem = false)
{
  ...
  response = await client.PutAsync (uri, content);
  ...
}
```
Работу `PutAsync` метод идентичен методу `PostAsync` метод, используемый для создания данных в веб-службе. Однако отличаются возможные ответы, отправленные из веб-службы.

Службы REST отправляет код состояния HTTP в `HttpResponseMessage.IsSuccessStatusCode` свойство, которое указывает, успешно ли выполнено HTTP-запроса. Приведены общие ответы для этой операции.

- **204 (нет СОДЕРЖИМОГО)** — успешно обработал запрос и ответ намеренно оставлена пустой.
- **400 (НЕПРАВИЛЬНЫЙ запрос)** — запрос не понят сервером.
- **404 (не НАЙДЕНО)** -запрошенный ресурс не существует на сервере.

### <a name="deleting-data"></a>Удаление данных

`HttpClient.DeleteAsync` Метод используется для отправки запроса на удаление веб-службу, указанного в URI, а затем получая ответ от веб-службы, как показано в следующем примере кода:

```csharp
public async Task DeleteTodoItemAsync (string id)
{
  // RestUrl = http://developer.xamarin.com:8081/api/todoitems/{0}
  var uri = new Uri (string.Format (Constants.RestUrl, id));
  ...
  var response = await client.DeleteAsync (uri);
  if (response.IsSuccessStatusCode) {
    Debug.WriteLine (@"             TodoItem successfully deleted.");
  }
  ...
}
```

Службы REST отправляет код состояния HTTP в `HttpResponseMessage.IsSuccessStatusCode` свойство, которое указывает, успешно ли выполнено HTTP-запроса. Приведены общие ответы для этой операции.

- **204 (нет СОДЕРЖИМОГО)** — успешно обработал запрос и ответ намеренно оставлена пустой.
- **400 (НЕПРАВИЛЬНЫЙ запрос)** — запрос не понят сервером.
- **404 (не НАЙДЕНО)** -запрошенный ресурс не существует на сервере.

## <a name="summary"></a>Сводка

В этой статье рассмотрено использование RESTful веб-службы в приложении Xamarin.Forms с помощью `HttpClient` класса. Простота REST сделала его основной метод для доступа к веб-служб в мобильных приложениях.


## <a name="related-links"></a>Связанные ссылки

- [Создание серверных служб для собственных мобильных приложений](/aspnet/core/mobile/native-mobile-backend/)
- [TodoREST (пример)](https://developer.xamarin.com/samples/xamarin-forms/WebServices/TodoREST/)
- [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(v=vs.110).aspx)
