---
title: Аусентикатеусерс с поставщиком удостоверений
description: В этой статье описываются способы использования Xamarin.Auth для управления процессом проверки подлинности в приложении Xamarin.Forms.
ms.prod: xamarin
ms.assetid: D44745D5-77BB-4596-9B8C-EC75C259157C
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 11/07/2019
ms.openlocfilehash: 0fa433de7fd1acb6fb27741f1615a644315f373f
ms.sourcegitcommit: db422e33438f1b5c55852e6942c3d1d75dc025c4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76725563"
---
# <a name="authenticate-users-with-an-identity-provider"></a>Проверка подлинности пользователей с помощью поставщика удостоверений

[![Загрузить образец](~/media/shared/download.png) загрузить пример](https://docs.microsoft.com/samples/xamarin/xamarin-forms-samples/webservices-oauthnativeflow)

_Xamarin. auth — это кросс-платформенный пакет SDK для проверки подлинности пользователей и хранения учетных записей. Он включает в себя средства проверки подлинности OAuth, обеспечивающие поддержку использования поставщиков удостоверений, таких как Google, Microsoft, Facebook и Twitter. В этой статье объясняется, как использовать Xamarin. auth для управления процессом проверки подлинности в приложении Xamarin. Forms._

OAuth — это открытый стандарт для проверки подлинности, а также позволяет владелец ресурса может уведомлять поставщика ресурсов, что разрешение следует предоставлять третьим лицам получить доступ к информации о без совместного использования удостоверения владельцев ресурса. Примером этого может выдаче пользователю возможность уведомлять поставщика удостоверений (например, Google, Майкрософт, Facebook или Twitter), в предоставлении этого разрешения приложению для доступа к своим данным, без предоставления общего доступа удостоверение пользователя. Обычно он используется подход для пользователей для входа в веб-сайтов и приложений с помощью поставщика удостоверений, но без предоставления пароля для веб-сайта или приложения.

Общий обзор потока проверки подлинности при использовании поставщика удостоверений OAuth выглядит следующим образом:

1. Приложение переходит в браузере URL-адрес поставщика удостоверений.
1. Поставщик удостоверений выполняет проверку подлинности пользователя и возвращает код авторизации приложению.
1. Приложение выполняет обмен кода авторизации для маркера доступа от поставщика удостоверений.
1. Приложение использует маркер доступа для доступа к API на поставщика удостоверений, например API для запроса основных пользовательских данных.

Пример приложения демонстрирует использование Xamarin.Auth, чтобы реализовать собственную аутентификацию поток от Google. Хотя Google используется в качестве поставщика удостоверений в этом разделе, этот подход также применима и для других поставщиков удостоверений. Дополнительные сведения о проверке подлинности с помощью конечной точки OAuth 2,0 в Google см. [в статье использование OAuth 2.0 для доступа к Google API](https://developers.google.com/identity/protocols/OAuth2) на веб-сайте Google.

> [!NOTE]
> В iOS 9 и более поздней версии приложение Transport Security (ATS) обеспечивает безопасных соединений между Интернет-ресурсов (например, server серверной части приложения) и приложения, тем самым предотвращая случайное раскрытие конфиденциальной информации. Поскольку ATS включена по умолчанию в приложениях, созданных для iOS 9, все подключения будут применяться требования к безопасности ATS. Если соединения не удовлетворяют этим требованиям, они вызовут сбой с исключением.
> ATS можно отключать, если невозможно использовать протокол `HTTPS` и безопасное взаимодействие с Интернет-ресурсами. Это можно сделать, обновив файл **info. plist** приложения. Дополнительные сведения см. в статье [Безопасность транспорта приложений](~/ios/app-fundamentals/ats.md).

## <a name="using-xamarinauth-to-authenticate-users"></a>С помощью Xamarin.Auth для проверки подлинности пользователей

Xamarin.Auth поддерживает два подхода к приложениям взаимодействовать с конечной точкой авторизации поставщика удостоверений:

1. С помощью внедренных веб-представление. Эта возможность была распространенной практикой, но больше не рекомендуется по следующим причинам:

    - Приложения, на котором размещена веб-представлении можно получить доступ к полной проверки подлинности учетных данных пользователя, не только предоставления авторизации OAuth, предназначенного для приложения. Это нарушает принцип наименьших прав доступа, эти приложения имеют доступ к более мощные учетные данные, чем это необходимо, потенциально увеличивать поверхность атаки приложения.
    - Ведущее приложение может записать имена пользователей и пароли, автоматически отправлять формы и обходить согласия пользователя и скопируйте файлы cookie сеанса и использовать их для выполнения действий, прошедшего проверку подлинности как пользователь.
    - Embedded веб-представления не находиться в состоянии проверки подлинности с другим приложениям или веб-браузере устройства, требующее от пользователя для входа в систему для каждого запроса авторизации, которое считается взаимодействие с пользователем плох.
    - Несколько конечных точек авторизации действий обнаружения и блокировки, полученные из веб-представлений запросов на авторизацию.

1. С помощью веб-браузере устройства, который является рекомендуемым подходом. С помощью обозревателя устройств для OAuth запросов повышает удобство использования приложения, как пользователям нужно только войти в поставщик удостоверений один раз в устройство, повышение скорости преобразования потоков входа и авторизации в приложении. Браузер на устройстве также обеспечивает повышенную безопасность, как приложения могут проверять и изменять содержимое в веб-представление, но не содержимое, отображаемое в браузере. Это подход для использования в этом статья и образец приложения.

На следующей схеме показан общий обзор того, как пример приложения использует Xamarin.Auth для проверки подлинности пользователей и получения их основные данные:

![](oauth-images/google-auth.png "Using Xamarin.Auth to Authenticate with Google")

Приложение выполняет запрос проверки подлинности в Google с помощью класса `OAuth2Authenticator`. Ответ проверки подлинности возвращается, когда пользователь успешно прошел аутентификацию с помощью Google через их страницы входа, который включает в себя маркер доступа. Затем приложение выполняет запрос к Google для основных пользовательских данных с помощью класса `OAuth2Request` с маркером доступа, включаемым в запрос.

### <a name="setup"></a>Настройка

Проект консоли Google API должны создаваться для интеграции Google вход с помощью приложения Xamarin.Forms. Это можно обеспечить, выполнив следующие действия.

1. Перейдите на веб-сайт [Google API console](https://console.developers.google.com) и выполните вход с учетными данными учетной записи Google.
1. Из раскрывающегося списка проект выберите существующий проект или создайте новую.
1. На боковой панели в разделе "Диспетчер API" выберите **учетные данные**, а затем перейдите на **вкладку экран согласия OAuth**. Выберите **адрес электронной почты**, укажите **имя продукта, которое отображается для пользователей**, и нажмите кнопку **сохранить**.
1. На вкладке **учетные данные** выберите в раскрывающемся списке **создать учетные данные** и щелкните **идентификатор клиента OAuth**.
1. В разделе **Тип приложения**выберите платформу, на которой будет выполняться мобильное приложение (**iOS** или **Android**).
1. Введите необходимые сведения и нажмите кнопку **создать** .

> [!NOTE]
> Идентификатор клиента позволяет приложению получить доступ к включенных API-интерфейсов Google и для мобильных приложений является уникальным для нескольких платформ. Поэтому **идентификатор клиента OAuth** должен быть создан для каждой платформы, которая будет использовать вход Google.

После выполнения этих действий, можно использовать Xamarin.Auth инициировать поток проверки подлинности OAuth2 с помощью Google.

### <a name="creating-and-configuring-an-authenticator"></a>Создание и настройка средства проверки подлинности

Класс `OAuth2Authenticator` Xamarin. auth отвечает за обработку потока проверки подлинности OAuth. В следующем примере кода показано создание экземпляра класса `OAuth2Authenticator` при выполнении проверки подлинности с помощью веб-браузера устройства:

```csharp
var authenticator = new OAuth2Authenticator(
    clientId,
    null,
    Constants.Scope,
    new Uri(Constants.AuthorizeUrl),
    new Uri(redirectUri),
    new Uri(Constants.AccessTokenUrl),
    null,
    true);
```

Класс `OAuth2Authenticator` требует несколько параметров, которые приведены ниже.

- **Идентификатор клиента** — определяет клиент, выполняющий запрос, и его можно получить из проекта в [консоли Google API](https://console.developers.google.com).
- **Секрет клиента** — это должен быть `null` или `string.Empty`.
- **Область** — определяет доступ API, запрашиваемый приложением, а значение информирует экран согласия, отображаемый пользователю. Дополнительные сведения об областях см. в статье [авторизация запросов](https://developers.google.com/docs/api/how-tos/authorizing) на веб-сайте Google.
- **Авторизация URL-адреса** — определяет URL-адрес, с которого будет получен код авторизации.
- **URL-адрес перенаправления** — определяет URL-адрес, по которому будет отправлен ответ. Значение этого параметра должно соответствовать одному из значений, отображаемых на вкладке **учетные данные** для проекта в [консоли Google Developers](https://console.developers.google.com/).
- **URL-адрес AccessToken** — определяет URL-адрес, используемый для запроса маркеров доступа после получения кода авторизации.
- **Жетусернамеасинк Func** — необязательный `Func`, который будет использоваться для асинхронного получения имени пользователя учетной записи после успешной проверки подлинности.
- **Использовать собственный пользовательский интерфейс** — `boolean` значение, указывающее, следует ли использовать веб-браузер устройства для выполнения запроса проверки подлинности.

### <a name="setup-authentication-event-handlers"></a>Настройка проверки подлинности обработчики событий

Перед представлением пользовательского интерфейса необходимо зарегистрировать обработчик событий для события `OAuth2Authenticator.Completed`, как показано в следующем примере кода:

```csharp
authenticator.Completed += OnAuthCompleted;
```

Эти события возникают, когда пользователь успешно проходит проверку подлинности или отменяет входа в систему.

При необходимости также можно зарегистрировать обработчик событий `OAuth2Authenticator.Error` события.

### <a name="presenting-the-sign-in-user-interface"></a>Представление входа в пользовательском интерфейсе

Интерфейс входа в систему могут отображаться для пользователя с помощью имени входа Xamarin.Auth презентатор, в которой должны быть инициализированы в каждом проекте платформы. В следующем примере кода показано, как инициализировать представление входа в класс `AppDelegate` в проекте iOS:

```csharp
global::Xamarin.Auth.Presenters.XamarinIOS.AuthenticationConfiguration.Init();
```

В следующем примере кода показано, как инициализировать представление входа в класс `MainActivity` в проекте Android:

```csharp
global::Xamarin.Auth.Presenters.XamarinAndroid.AuthenticationConfiguration.Init(this, bundle);
```

Проект библиотеки .NET Standard затем можно вызвать операцию презентатор входа следующим образом:

```csharp
var presenter = new Xamarin.Auth.Presenters.OAuthLoginPresenter();
presenter.Login(authenticator);
```

Обратите внимание, что аргументом для метода `Xamarin.Auth.Presenters.OAuthLoginPresenter.Login` является экземпляр `OAuth2Authenticator`. При вызове метода `Login` пользовательский интерфейс входа предоставляется пользователю на вкладке из веб-браузера устройства, который показан на следующих снимках экрана:

![](oauth-images/login.png "Google Sign-In")

### <a name="processing-the-redirect-url"></a>Обработка URL-адрес перенаправления

После того как пользователь завершит процесс проверки подлинности, управление вернется в приложение с вкладки веб-браузер. Это достигается путем регистрации настраиваемой схемы URL-адреса перенаправления, которая возвращается из процесса проверки подлинности, а затем обнаружения и обработки настраиваемого URL-адреса после его отправки.

При выборе схему URL-адрес должен быть сопоставлен приложения, приложения должны использовать схему, основанную на имени, находящийся под его контролем. Это можно сделать с помощью имя идентификатора пакета в iOS и имя пакета на устройстве Android, а затем обращение их, чтобы сделать схему URL-адрес. Тем не менее некоторые поставщики удостоверений, например, Google, назначьте идентификаторы клиента, используя доменные имена, которые затем в обратном порядке и используются в качестве схемы URL-адрес. Например, если Google создает идентификатор клиента `902730282010-ks3kd03ksoasioda93jldas93jjj22kr.apps.googleusercontent.com`, схема URL-адресов будет `com.googleusercontent.apps.902730282010-ks3kd03ksoasioda93jldas93jjj22kr`. Обратите внимание, что после компонента схемы может появиться только одно `/`. Таким образом, полный пример URL-адреса перенаправления, использующего настраиваемую схему URL-адресов, `com.googleusercontent.apps.902730282010-ks3kd03ksoasioda93jldas93jjj22kr:/oauth2redirect`.

При получении ответа от поставщика удостоверений, который содержит схему URL-адрес веб-браузер, он пытается загрузить URL-адрес, что приводит к ошибке. Вместо этого пользовательские схемы URL-адрес передается в операционную систему, вызывая событие. Операционная система осуществляет поиск зарегистрированных схем, и если он найден, операционная система будет запустится приложение, зарегистрированные схемы и отправить его URL-адрес перенаправления.

Механизм для регистрации схему URL-адрес в операционную систему и обработке схеме конкретной платформы.

#### <a name="ios"></a>iOS

В iOS пользовательская схема URL-адресов регистрируется в файле **info. plist**, как показано на следующем снимке экрана:

![](oauth-images/info-plist.png "URL Scheme Registration")

Значение **идентификатора** может быть любым, а значение **роли** должно быть задано в **средстве просмотра**. Значение **схемы URL-адресов** , которое начинается с `com.googleusercontent.apps`, может быть получено из идентификатора клиента iOS для проекта в [консоли Google API](https://console.developers.google.com).

По завершении запроса на авторизацию поставщик удостоверений перенаправляет URL-адрес перенаправления для приложения. Поскольку URL-адрес использует пользовательскую схему, она приводит к запуску приложения iOS, передавая URL-адрес в качестве параметра запуска, где он обрабатывается `OpenUrl` переопределением класса `AppDelegate` приложения, как показано в следующем примере кода:

```csharp
public override bool OpenUrl(UIApplication app, NSUrl url, NSDictionary options)
{
    // Convert NSUrl to Uri
    var uri = new Uri(url.AbsoluteString);

    // Load redirectUrl page
    AuthenticationState.Authenticator.OnPageLoading(uri);

    return true;
}
```

Метод `OpenUrl` преобразует полученный URL-адрес из `NSUrl` в `Uri`.NET перед обработкой URL-адреса перенаправления с помощью метода `OnPageLoading` открытого объекта `OAuth2Authenticator`. В результате Xamarin.Auth чтобы закрыть вкладку веб-браузера и синтаксический анализ полученных данных OAuth.

#### <a name="android"></a>Android

В Android пользовательская схема URL-адресов регистрируется путем указания атрибута [`IntentFilter`](xref:Android.App.IntentFilterAttribute) на `Activity`, который будет работать со схемой. По завершении запроса на авторизацию поставщик удостоверений перенаправляет URL-адрес перенаправления для приложения. Так как URL-адрес использует пользовательскую схему, он приводит к запуску приложения Android, передавая URL-адрес в качестве параметра запуска, где он обрабатывается методом `OnCreate` `Activity`, зарегистрированным для обработки настраиваемой схемы URL-адресов. В следующем примере кода показан класс из примера приложения, который обрабатывает пользовательские схемы URL-адрес:

```csharp
[Activity(Label = "CustomUrlSchemeInterceptorActivity", NoHistory = true, LaunchMode = LaunchMode.SingleTop )]
[IntentFilter(
    new[] { Intent.ActionView },
    Categories = new [] { Intent.CategoryDefault, Intent.CategoryBrowsable },
    DataSchemes = new [] { "<insert custom URL here>" },
    DataPath = "/oauth2redirect")]
public class CustomUrlSchemeInterceptorActivity : Activity
{
    protected override void OnCreate(Bundle savedInstanceState)
    {
        base.OnCreate(savedInstanceState);

        // Convert Android.Net.Url to Uri
        var uri = new Uri(Intent.Data.ToString());

        // Load redirectUrl page
        AuthenticationState.Authenticator.OnPageLoading(uri);

        Finish();
    }
}
```

Для свойства `DataSchemes` [`IntentFilter`](xref:Android.App.IntentFilterAttribute) необходимо задать обратный идентификатор клиента, полученный из идентификатора клиента Android для проекта в [консоли Google API](https://console.developers.google.com).

Метод `OnCreate` преобразует полученный URL-адрес из `Android.Net.Url` в `Uri`.NET перед обработкой URL-адреса перенаправления с помощью метода `OnPageLoading` открытого объекта `OAuth2Authenticator`. В результате Xamarin.Auth закрыть вкладку веб-браузера, а синтаксический анализ полученных данных OAuth.

> [!IMPORTANT]
> В Android Xamarin. auth использует API `CustomTabs` для взаимодействия с веб-браузером и операционной системой. Однако не гарантируется, что на устройстве пользователя будет установлен совместимый с `CustomTabs` браузер.

### <a name="examining-the-oauth-response"></a>Проверка ответа OAuth

После синтаксического анализа полученных данных OAuth Xamarin. auth вызовет событие `OAuth2Authenticator.Completed`. В обработчике событий для этого события можно использовать свойство `AuthenticatorCompletedEventArgs.IsAuthenticated`, чтобы определить, прошла ли проверка подлинности, как показано в следующем примере кода:

```csharp
async void OnAuthCompleted(object sender, AuthenticatorCompletedEventArgs e)
{
  ...
  if (e.IsAuthenticated)
  {
    ...
  }
}
```

Данные, собранные из успешной проверки подлинности, доступны в свойстве `AuthenticatorCompletedEventArgs.Account`. Это включает в себя маркер доступа, который может использоваться для подписывания запросов для данных в API, предоставляемые поставщиком удостоверений.

### <a name="making-requests-for-data"></a>Создание запросов для данных

Когда приложение получает маркер доступа, оно используется для выполнения запроса к `https://www.googleapis.com/oauth2/v2/userinfo` API, чтобы запросить базовые пользовательские данные от поставщика удостоверений. Этот запрос выполняется с помощью класса `OAuth2Request` Xamarin. auth, который представляет запрос, прошедший проверку подлинности с помощью учетной записи, полученной от экземпляра `OAuth2Authenticator`, как показано в следующем примере кода:

```csharp
// UserInfoUrl = https://www.googleapis.com/oauth2/v2/userinfo
var request = new OAuth2Request ("GET", new Uri (Constants.UserInfoUrl), null, e.Account);
var response = await request.GetResponseAsync ();
if (response != null)
{
  string userJson = response.GetResponseText ();
  var user = JsonConvert.DeserializeObject<User> (userJson);
}
```

Кроме метода HTTP и URL-адреса API, `OAuth2Request` экземпляр также указывает `Account` экземпляр, содержащий маркер доступа, который подписывает запрос на URL-адрес, указанный свойством `Constants.UserInfoUrl`. Затем поставщик удостоверений возвращает основных пользовательских данных в ответ JSON, включая имя пользователя и адрес электронной почты, при условии, что маркер доступа он распознает как допустимые. Затем ответ JSON считывается и десериализуется в переменную `user`.

Дополнительные сведения см. в статье [вызов Google API](https://developers.google.com/identity/protocols/OAuth2InstalledApp#callinganapi) на портале Google Developers.

### <a name="storing-and-retrieving-account-information-on-devices"></a>Хранения и извлечения сведений учетной записи на устройствах

Xamarin. auth безопасно сохраняет `Account` объекты в хранилище учетных записей, чтобы приложениям не применялись повторные проверки подлинности пользователей. Класс `AccountStore` отвечает за хранение данных учетной записи и обеспечивается службами цепочки ключей в iOS, а класс `KeyStore` в Android.

> [!IMPORTANT]
> Класс `AccountStore` в Xamarin. auth является устаревшим, и вместо него следует использовать класс Xamarin. Essentials `SecureStorage`. Дополнительные сведения см. в статье [Миграция с хранилище учетных данных на Xamarin. Essentials секурестораже](https://github.com/xamarin/Xamarin.Auth/wiki/Migrating-from-AccountStore-to-Xamarin.Essentials-SecureStorage).

В следующем примере кода показано, как безопасно сохранить объект `Account`:

```csharp
AccountStore.Create ().Save (e.Account, Constants.AppName);
```

Сохраненные учетные записи уникально идентифицируются с помощью ключа, состоящего из свойства `Username` учетной записи, и идентификатора службы, который представляет собой строку, используемую при выборке учетных записей из хранилища учетных записей. Если ранее был сохранен `Account`, вызов метода `Save` снова запишет его.

`Account` объекты для службы можно получить, вызвав метод `FindAccountsForService`, как показано в следующем примере кода:

```csharp
var account = AccountStore.Create ().FindAccountsForService (Constants.AppName).FirstOrDefault();
```

Метод `FindAccountsForService` Возвращает коллекцию `IEnumerable` объектов `Account`, в которой первый элемент коллекции задается как соответствующая учетная запись.

## <a name="troubleshooting"></a>Устранение неполадок

- В Android, если при закрытии браузера после проверки подлинности вы получаете всплывающее уведомление и хотите закрыть всплывающее уведомление, добавьте следующий код в проект Android после инициализации Xamarin. auth:

```csharp
Xamarin.Auth.CustomTabsConfiguration.CustomTabsClosingMessage = null;
```

- В Android, если браузер не закрывается автоматически, временное решение заключается в понижении уровня пакета Xamarin. auth до версии 1.5.0.3. Затем добавьте в проект Android 2.0.147 с помощью [PCL Crypto v](https://www.nuget.org/packages/PCLCrypto/2.0.147) .

## <a name="summary"></a>Сводка

В этой статье описываются способы использования Xamarin.Auth для управления процессом проверки подлинности в приложении Xamarin.Forms. Xamarin. auth предоставляет классы `OAuth2Authenticator` и `OAuth2Request`, используемые приложениями Xamarin. Forms для использования поставщиков удостоверений, таких как Google, Microsoft, Facebook и Twitter.

## <a name="related-links"></a>Связанные ссылки

- [Оауснативефлов (пример)](https://docs.microsoft.com/samples/xamarin/xamarin-forms-samples/webservices-oauthnativeflow)
- [OAuth 2,0 для собственных приложений](https://tools.ietf.org/html/draft-ietf-oauth-native-apps-12)
- [Использование OAuth 2.0 для доступа к Google API](https://developers.google.com/identity/protocols/OAuth2)
- [Xamarin. auth (NuGet)](https://www.nuget.org/packages/xamarin.auth/)
- [Xamarin. auth (GitHub)](https://github.com/xamarin/Xamarin.Auth)
