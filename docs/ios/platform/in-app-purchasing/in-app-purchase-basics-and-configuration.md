---
title: Основные сведения о приобретении в приложении и конфигурации в Xamarin. iOS
description: В этом документе описываются покупки из приложений в Xamarin. iOS, обсуждаются соответствующие сведения о правилах, конфигурации и iTunes Connect.
ms.prod: xamarin
ms.assetid: 11FB7F02-41B3-2B34-5A4F-69F12897FE10
ms.technology: xamarin-ios
author: davidortinau
ms.author: daortin
ms.date: 03/18/2017
ms.openlocfilehash: 786afa6967731fb1bd508fa3c835b980639eb282
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73032386"
---
# <a name="in-app-purchase-basics-and-configuration-in-xamarinios"></a>Основные сведения о приобретении в приложении и конфигурации в Xamarin. iOS

Для реализации покупок из приложения приложение должно использовать API StoreKit на устройстве. StoreKit управляет обменом данными с серверами iTunes Apple для получения сведений о продукте и выполнения транзакций. Профиль подготовки должен быть настроен для покупки в приложении, а сведения о продукте должны быть указаны в iTunes Connect.

 [![](in-app-purchase-basics-and-configuration-images/image1.png "StoreKit manages all communication with Apple’s as shown in this chart")](in-app-purchase-basics-and-configuration-images/image1.png#lightbox)

Для обеспечения покупки в приложении с помощью магазина приложений необходимо выполнить следующие действия по установке и настройке.

- **iTunes Connect** — Настройка продуктов для продажи и настройки учетных записей пользователей песочницы для тестирования приобретения. Кроме того, необходимо предоставить компании Apple сведения о банковской и налоговой информации, чтобы они могли подбирать фонды, собранные от вашего имени.
- **портал подготовки iOS** — создание идентификатора пакета и включение доступа к магазину приложений для приложения.
- **Комплект магазина** — Добавление кода в приложение для отображения продуктов, приобретения продуктов и восстановления транзакций.
- **Пользовательский код** — для учета покупок, производимых клиентами, и предоставления продуктов или услуг, которые они приобрели. Кроме того, вам может потребоваться реализовать серверный процесс для проверки поступления, если ваши продукты состоят из содержимого, загруженного с сервера (например, из-за проблем с книгой и журналами).

Существует два пакета "серверные среды магазина":

- **Производство** — транзакции с реальными деньгами. Доступен только через приложения, которые были отправлены и утверждены Apple. Продукты, приобретенные в приложении, должны быть также проверены и утверждены, прежде чем они будут доступны в рабочей среде.
- **Песочница** — там, где происходит тестирование. Продукты доступны здесь сразу после создания (процесс утверждения применяется только к рабочей среде). Для транзакций в песочнице требуются тестовые пользователи (а не реальные идентификаторы Apple ID) для выполнения транзакций.

## <a name="in-app-purchase-rules"></a>Правила покупки в приложении

Вы не можете принять другие формы оплаты для цифровых продуктов или услуг внутри приложения, а также не упоминать их и не обращаться к ним пользователей из приложения. Это означает, что вы не можете принимать кредитные карты или PayPal, когда покупка в приложении является наиболее подходящим механизмом оплаты. Существует особый случай приобретения цифровых продуктов за пределами приложения, но для использования в приложении, таких как покупка книг на веб-сайте, связанных с определенным именем входа, и использование этого имени входа в приложении позволяет пользователю получить доступ к приобретенным книгам.
Приложения, которые работают таким образом, не могут упомянуть о функции внешней покупки или ссылаться на нее, поэтому разработчики должны передать эту возможность своим пользователям другими способами (возможно, с помощью маркетинга по электронной почте или другого прямого канала).

Однако, поскольку вы не можете использовать покупки в приложении для физических товаров, в этом случае вы можете использовать альтернативный механизм оплаты (например, кредитной карты, PayPal) в приложении.

Компания Apple должна утвердить каждый продукт до того, как он поступает на продажу — для проверки требуется имя, описание и снимок экрана "продукт". Время проверки продукта совпадает со временем проверок приложений.

Вы не можете выбрать цену для продукта. Вы можете выбрать только ценовую категорию с конкретным значением в каждой стране или валюте, поддерживаемой Apple. У вас не может быть другой ценовой категории на разных рынках.

## <a name="configuration"></a>Параметр Configuration

Перед написанием любого кода покупки в приложении необходимо выполнить некоторые действия по настройке в iTunes Connect ( [iTunesConnect.Apple.com](https://itunesconnect.apple.com)) и на портале подготовки iOS ( [Developer.Apple.com/iOS](https://developer.apple.com/iOS)).

Перед написанием кода необходимо выполнить следующие три шага:

- **Учетная запись разработчика Apple** . Отправьте сведения о банковских и налогообложении в Apple.
- **портал подготовки iOS** — убедитесь, что приложение имеет допустимый идентификатор приложения (не является подстановочным знаком со звездочкой * в нем) и включен в покупки приложений.
- **Управление приложениями в iTunes Connect** — Добавление продуктов в приложение.

### <a name="apple-developer-account"></a>Учетная запись разработчика Apple

Создание и распространение бесплатных приложений требует очень малой настройки в [iTunes Connect](https://itunesconnect.apple.com), однако для продажи платных приложений или покупок в приложении необходимо предоставить Apple сведения о банковской и налогообложении. В главном меню, показанном здесь **, щелкните соглашения, налоговые и банковские** операции:

 [![](in-app-purchase-basics-and-configuration-images/image2.png "Click on Agreements, Tax and Banking from the main menu")](in-app-purchase-basics-and-configuration-images/image2.png#lightbox)

В учетной записи разработчика должен действовать контракт на **оплату приложений iOS** , как показано на следующем снимке экрана:

 [![](in-app-purchase-basics-and-configuration-images/image3.png "Your Developer Account should have an iOS Paid Applications contract in effect")](in-app-purchase-basics-and-configuration-images/image3.png#lightbox)

Вы не сможете протестировать какие-либо функции StoreKit, пока у вас не будет контракта с **платными приложениями iOS** — StoreKit вызовы в коде будут завершаться сбоем до тех пор, пока компания Apple не обработала свои **контракты, налоговые и банковские** сведения.

### <a name="ios-provisioning-portal"></a>Портал подготовки iOS

Новые приложения настраиваются в разделе **Идентификаторы приложений** на **портале подготовки iOS**. Чтобы создать идентификатор приложения, перейдите в [центр участников портала подготовки iOS](https://developer.apple.com/membercenter/index.action), перейдите к разделу **сертификаты, идентификаторы и профили** на портале и щелкните **идентификаторы** в разделе *приложения iOS*. Затем щелкните значок "+" в правом верхнем углу, чтобы создать новый идентификатор приложения.

Форма для создания новых **идентификаторов приложений**

 выглядит следующим образом:

 [![](in-app-purchase-basics-and-configuration-images/image4.png "The form for creating new App IDs")](in-app-purchase-basics-and-configuration-images/image4.png#lightbox)

Введите что-нибудь подходящее для *описания*, чтобы идентификатор приложения можно было легко найти в списке. В качестве *префикса идентификатора приложения*выберите идентификатор группы.

#### <a name="bundle-identifierapp-id-suffix-format"></a>Формат идентификатора пакета или суффикса идентификатора приложения

Вы можете использовать любую строку для **идентификатора пакета** (при условии, что он уникален в вашей учетной записи), однако Apple рекомендует использовать формат обратных DNS, а не любую произвольную строку. В примере приложения, прилагаемого к этой статье, используется COM. Xamarin. storekit. testing для идентификатора пакета, однако было бы так же допустимо использовать идентификатор, такой как my_store_example (даже если Apple не рекомендует его).

> [!IMPORTANT]
> Apple также позволяет добавить символ звездочки в конец **идентификатора пакета** , чтобы один идентификатор приложения можно было использовать для нескольких приложений, однако _Идентификаторы приложений с подстановочными знаками нельзя использовать для in-апппурчасе_. Пример подстановочного идентификатора пакета карты может быть com. Xamarin. *

#### <a name="enabling-app-services"></a>Включение служб приложений

Обратите внимание, что **Покупка в приложении** будет автоматически включена в списке служб:

 [![](in-app-purchase-basics-and-configuration-images/image5.png "In-App Purchase will be automatically enabled in the Services list")](in-app-purchase-basics-and-configuration-images/image5.png#lightbox)

#### <a name="provisioning-profiles"></a>Профили подготовки

Создайте профили подготовки и разработки в рабочей среде, как обычно, выбрав идентификатор приложения, настроенный для приобретения в приложении. Дополнительные сведения см. в разделе [Подготовка устройств iOS](~/ios/get-started/installation/device-provisioning/index.md) и их [Публикация в руководствах App Store](~/ios/deploy-test/app-distribution/app-store-distribution/publishing-to-the-app-store.md) .

## <a name="itunes-connect"></a>iTunes Connect

Щелкните **Мои приложения** в iTunes Connect, чтобы создать или изменить запись приложения iOS. Страница "Обзор приложения" показана здесь:

 [![](in-app-purchase-basics-and-configuration-images/image6.png "The application overview page")](in-app-purchase-basics-and-configuration-images/image6.png#lightbox)

Щелкните **покупки в приложении** , чтобы создать или изменить продукты для продажи. На этом снимке экрана показан пример приложения, в котором уже добавлено несколько продуктов:

 [![](in-app-purchase-basics-and-configuration-images/image7.png "The sample app with several products already added")](in-app-purchase-basics-and-configuration-images/image7.png#lightbox)

Процесс добавления новых продуктов выполняется в два этапа:

1. Выберите тип продукта:[![](in-app-purchase-basics-and-configuration-images/image8.png "Выбор типа продукта")](in-app-purchase-basics-and-configuration-images/image8.png#lightbox) 
2. Введите атрибуты продукта, включая идентификатор продукта, ценовую категорию и локализованные описания:[![](in-app-purchase-basics-and-configuration-images/image9.png "Ввод атрибутов продуктов")](in-app-purchase-basics-and-configuration-images/image9.png#lightbox)

Ниже описаны поля, необходимые для каждого продукта покупки в приложении.

### <a name="reference-name"></a>Ссылочное имя

Имя ссылки не отображается для пользователей. Он предназначен для внутреннего использования и отображается только в iTunes Connect.

### <a name="product-id-format"></a>Формат идентификатора продукта

Идентификатор продукта может содержать только буквы, цифры (A – Z, A – z, 0 – 9), символы подчеркивания (_) и точки (.). Хотя вы можете использовать любую строку для идентификаторов, Apple рекомендует формат обратных DNS. Например, пример приложения использует этот идентификатор пакета:

 `com.xamarin.storekit.testing`

Поэтому соглашение об определении продуктов для покупки в приложении будет следующим:

```csharp
com.xamarin.storekit.testing.consume5credits
com.xamarin.storekit.testing.consume10credits
com.xamarin.storekit.testing.sepia
com.xamarin.storekit.testing.greyscale
```

Это соглашение об именовании не применяется, просто рекомендации по управлению продуктами. Кроме того, несмотря на то же соглашение о обратных DNS, идентификаторы продуктов *не связаны* с идентификатором пакета и не должны начинаться с одной и той же строки. Он по-прежнему может использовать идентификаторы, такие как photo_product_greyscale (даже если Apple не рекомендует его).

КОД продукта не отображается для пользователей, но используется для ссылки на продукт в коде приложения.

### <a name="product-type"></a>Тип продукта

Существует пять типов продуктов для покупки в приложении, которые можно предложить:

1. **Потребленные** — это те вещи, которые используются в игре, например в карточной валюте, которую может потратить игрок. Если пользователь выполняет резервное копирование или восстановление или в противном случае обновляет устройство, используемая транзакция не восстанавливается (что эффективно придает проигрывателю то же самое преимущество). Код приложения должен предоставлять "потребляемый элемент" сразу после завершения транзакции.
1. **Невоспроизводимые** — продукты, которые пользователь "владеет" после покупки, например выпуск цифрового журнала или уровень игры.
1. **Устанавливать возобновляемуюные подписки** — так же, как и в реальной подписке на журнал, по окончании срока действия подписки компания Apple автоматически оплачивает оплату клиента и расширяет ее срок действия, бесконечно или до тех пор, пока клиент явно не отменит его. Это предпочтительный метод оплаты для киоска приложений (на самом деле, приложения должны поддерживать этот метод оплаты для киоска распространения).
1. **Бесплатная подписка** — может предлагаться только в приложениях с поддержкой киоска и позволяет клиенту получать доступ к содержимому подписки на всех своих устройствах. Срок действия бесплатных подписок никогда не истекает.
1. **Подписка, не поддерживающая продление** — следует использовать для продажи ограниченного времени доступа к статическому содержимому, например для доступа к архиву фотографий за один месяц.

 *В настоящее время этот документ охватывает только первые два типа продуктов (которые являются потребленными и невоспроизводимыми).*

 <a name="Price_Tiers" />

### <a name="price-tiers"></a>Ценовые категории

Магазин приложений не позволяет выбрать произвольную цену для ваших продуктов — Apple предоставляет фиксированные ценовые категории, которые можно выбрать. Цены зафиксированы в каждой валюте, а Apple резервирует право на корректировку относительных цен (например, после длительного изменения относительного валютного курса между определенной валютой и долларом США).

Компания Apple предоставляет ценовую матрицу, помогающую выбрать нужный уровень для нужной валюты или цены. Выдержка из матрицы цен (2012 августа) показана здесь:

 [![](in-app-purchase-basics-and-configuration-images/image10.png "An excerpt of the price matrix August 2012")](in-app-purchase-basics-and-configuration-images/image10.png#lightbox)

На момент написания статьи (Июнь 2013) имеется 87 уровней от USD 0,99 до USD 999,99. В матрице ценообразования показана Цена, которую клиенты будут платить, а также сумма, которую вы получаете от Apple. это меньше 30% оплаты, а также все местные налоги, которые требуется составлять (Обратите внимание в примере, в котором США и канадские продавцов получают 70C для 99C p. продукту, в то время как Австралии продавцов получает только 63c из-за "товаров &amp; Services налоги", взимаемых по цене продажи).

Цены на продукт можно обновить в любое время, включая запланированные изменения цен, которые вступают в силу в будущем. На этом снимке экрана показано, как добавляется изменение цены в будущем — цена временно изменяется с уровня 1 на уровень 3 в месяц только для сентября:

 [![](in-app-purchase-basics-and-configuration-images/image11.png "A future-dated price change where the price is being temporarily changed from tier 1 to tier 3 for the month of September only")](in-app-purchase-basics-and-configuration-images/image11.png#lightbox)

### <a name="free-products-not-supported"></a>Бесплатные продукты не поддерживаются

Хотя компания Apple предоставила специальный вариант бесплатной подписки для приложений киоска, вы не можете установить нулевую (свободную) цену для любых других типов покупок в приложении. Хотя вы можете редактировать цены (IE. ниже) для продвижения по продажам, вы не сможете делать покупки в приложении свободными через iTunes Connect.

### <a name="localization"></a>Локализация

В iTunes Connect можно ввести разные имена и описания для любого числа поддерживаемых языков. Каждый язык можно добавить или изменить в с помощью всплывающего окна:

 [![](in-app-purchase-basics-and-configuration-images/image12.png "Each language can be added/edited in via a popup")](in-app-purchase-basics-and-configuration-images/image12.png#lightbox)   

При отображении в приложении сведений о продукте локализованный текст доступен для просмотра через StoreKit. Отображение валюты также должно быть локализовано для отображения правильного формата символов и десятичного форматирования — это форматирование рассматривается далее в документе.

### <a name="app-store-review"></a>Проверка App Store

То же, что и приложения — каждый продукт просматривается компанией Apple до того, как будет разрешен переход на продажи. Продукты могут быть отклонены по имени или описанию, или Apple может решить, что выбран неправильный тип продукта (например, Вы создали ошибку книги или журнала, но использовали тип продукта "потреблено". Проверка продукта может занять до проверки приложения.

При первой отправке приложения с включенной покупкой в приложении (если это новое приложение или функция добавлена к существующей) необходимо также выбрать некоторые продукты для отправки вместе с ним. На портале iTunes Connect будет предложено сделать это, как показано на следующем снимке экрана:

 [![](in-app-purchase-basics-and-configuration-images/image13.png "The iTunes Connect portal will prompt you to submit some products as well")](in-app-purchase-basics-and-configuration-images/image13.png#lightbox)   

Приложение и покупка в приложении будут рассматриваться вместе, чтобы все они были утверждены одновременно (чтобы приложение не переходило в магазин без утвержденных продуктов!).

После утверждения первой версии с возможностью приобретения в приложении можно добавить дополнительные продукты и отправить их на проверку в любое время. Вы также можете отправить новую версию вместе с конкретными продуктами, приобретенными в приложении, используя страницу **сведений о версии** в соответствии с предложением.

Дополнительные сведения см. в руководстве по [проверке App Store](https://developer.apple.com/appstore/guidelines.html) .

 [Часть 2. Обзор комплекта магазина и получение сведений о продукте](~/ios/platform/in-app-purchasing/store-kit-overview-and-retreiving-product-information.md)
