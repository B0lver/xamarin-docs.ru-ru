---
title: Push-уведомлений в iOS
description: В этом документе описывается, как для работы с Push-уведомлений в iOS 9 и более ранних версий. Здесь рассматриваются сертификаты, регистрация Apple Push-уведомления шлюза Service (APNS) и многое другое.
ms.prod: xamarin
ms.assetid: 64B3BE6A-A3E2-4B1B-95ED-02D27A8FDAAC
ms.technology: xamarin-ios
author: bradumbaugh
ms.author: brumbaug
ms.date: 03/18/2017
ms.openlocfilehash: f11f5d1cbde0f5eae27215af8eb6544be46c0206
ms.sourcegitcommit: 47709db4d115d221e97f18bc8111c95723f6cb9b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2018
ms.locfileid: "39654819"
---
# <a name="push-notifications-in-ios"></a>Push-уведомлений в iOS

> [!IMPORTANT]
> Сведения в этом разделе, относятся к iOS 9 и предыдущий, она была оставлена здесь для поддержки более старых версий iOS. IOS 10 и более поздние версии, см. в разделе [руководство по Framework уведомление пользователя](~/ios/platform/user-notifications/index.md) за поддержку локальных и удаленных уведомлений на устройства iOS.

Push-уведомления, должны храниться краткое и только содержат достаточно данных для уведомления мобильного приложения о том, что его следует обратиться к серверному приложению для обновления. Например когда приходит новое электронное письмо, серверное приложение будет только уведомления мобильных приложения поступления новых сообщений электронной почты. Уведомление не будет содержать новое сообщение электронной почты, сама. Мобильное приложение затем извлечет новых сообщений электронной почты с сервера во время соответствующего

В центре принудительной отправке уведомления в iOS — *Apple Push Notification шлюз Service (APNS)*. Это служба, предоставляемых компанией Apple, который отвечает за маршрутизации уведомления от сервера приложений на устройствах iOS.
На рисунке ниже показана топология принудительной уведомления для iOS: ![](remote-notifications-in-ios-images/image4.png "это изображение иллюстрирует топологию уведомлений push для iOS")

Удаленные уведомления, сами являются строки, которые соответствуют формату в формате JSON и протоколы, указанные в [полезные данные уведомления](https://developer.apple.com/library/prerelease/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CreatingtheNotificationPayload.html#//apple_ref/doc/uid/TP40008194-CH10-SW1) раздел [локальных и Push-уведомлений руководство по программированию](https://developer.apple.com/library/prerelease/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/)в [документация для разработчиков iOS](https://developer.apple.com/devcenter/ios/index.action).

Apple поддерживает две среды из APNS: *"песочницы"* и *рабочей* среды. Среда "песочницы" предназначена для тестирования на этапе разработки и может быть найдено на `gateway.sandbox.push.apple.com` через TCP-порт 2195. В рабочей среде предназначен для использования в приложениях, которые были развернуты и можно найти в `gateway.push.apple.com` через TCP-порт 2195.

## <a name="requirements"></a>Требования

Push-уведомлений необходимо соблюдать следующие правила, которые определяются архитектурой APNS:

-  **256 байт ограничения на количество сообщений** -размер всего сообщения уведомления не должен превышать 256 байт.
-  **Подтверждение поступления, не** -APNS не предоставляет отправителю все уведомления, в которой сообщения предполагаемому получателю. Если устройство недоступно, несколько последовательных уведомления будут отправляться все уведомления, за исключением самого последнего будут потеряны. Только последнего уведомления будут доставлены на устройство.
-  **Каждому приложению требуется сертификат защищенного** -связи с APNS должны выполняться по протоколу SSL.


## <a name="creating-and-using-certificates"></a>Создание и использование сертификатов

Каждой из сред, упомянутые в предыдущем разделе требуется свой собственный сертификат. В этом разделе мы рассмотрим, как создать сертификат, свяжите ее с помощью профиля подготовки и затем получить сертификат обмена персональными данными для использования с PushSharp.

1.  Чтобы создать сертификаты перейдите к iOS портал подготовки на веб-сайте Apple, как показано на следующем снимке экрана (Обратите внимание, что пункт меню идентификаторов приложений в левой части):

    [![](remote-notifications-in-ios-images/image5new.png "На портале подготовки на веб-сайте яблоки iOS")](remote-notifications-in-ios-images/image5new.png#lightbox)

2.  После этого перейдите к разделу идентификаторов приложений и создайте новый идентификатор приложения, как показано на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image6new.png "Перейдите к разделу идентификаторов приложений и создайте новый идентификатор приложения")](remote-notifications-in-ios-images/image6new.png#lightbox)

3.  Когда вы щелкаете **+** кнопки, можно ввести описание и идентификатор пакета для идентификатора приложения, как показано на следующем рисунке:

    [![](remote-notifications-in-ios-images/image7new.png "Введите описание и идентификатор пакета для идентификатора приложения")](remote-notifications-in-ios-images/image7new.png#lightbox)

4. Не забудьте выбрать **явный идентификатор приложения** и что идентификатор пакета не заканчивается `*` . Будет создан идентификатор, который хорошо подходит для нескольких приложений и отправки уведомлений сертификаты должны быть для одного приложения.

1. В разделе службы приложений, выберите **Push-уведомления**:

    [![](remote-notifications-in-ios-images/image8new.png "Выберите Push-уведомлений")](remote-notifications-in-ios-images/image8new.png#lightbox)

2. И нажмите клавишу **отправить** для подтверждения регистрации нового идентификатора приложения:

    [![](remote-notifications-in-ios-images/image9new.png "Подтвердить регистрацию нового идентификатора приложения")](remote-notifications-in-ios-images/image9new.png#lightbox)

3.  Далее необходимо создать сертификат для идентификатора приложения. В области навигации слева, перейдите к **сертификаты > все** и выберите `+` кнопку, как показано на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image10new.png "Создайте сертификат для ИД приложения")](remote-notifications-in-ios-images/image8.png#lightbox)

4.  Выберите ли вы бы хотели использовать сертификат разработки или рабочей среде:

    [![](remote-notifications-in-ios-images/image11new.png "Выберите сертификат разработки или рабочей среде")](remote-notifications-in-ios-images/image11new.png#lightbox)

5. А затем выберите новый идентификатор приложения, который мы только что создали.

    [![](remote-notifications-in-ios-images/image12new.png "Выберите только что создали нового идентификатора приложения")](remote-notifications-in-ios-images/image12new.png#lightbox)

6.  При этом отобразится инструкции, которые позволят вам через процесс создания *запрос подписи сертификата* с помощью **доступ к цепочке ключей** приложения на компьютере Mac.

7.  Теперь, когда сертификат будет создан, он должен использоваться как часть процесса построения для подписи приложения таким образом, чтобы его можно зарегистрировать с помощью APNs. Для этого создание и установка профиля подготовки, использующего сертификат.

8.  Для создания профиля подготовки для разработки, перейдите к **профили подготовки** разделе и выполните действия, чтобы создать его, используя идентификатор приложения, мы только что создали.

9.  После создания профиля подготовки, откройте **Организатор Xcode** и обновить его. При создании профиля подготовки не может быть необходимо загрузить профиль на портале подготовки iOS и вручную импортировать его. На следующем снимке экрана показан пример Организатор с профилем подготовки добавлен:

    [![](remote-notifications-in-ios-images/image13new.png "Этот снимок экрана: пример Организатор с профилем подготовки добавлен")](remote-notifications-in-ios-images/image13new.png#lightbox)

10.  На этом этапе необходимо настроить проект Xamarin.iOS для использования нового профиля подготовки. Это делается с **параметры проекта** диалогового окна в разделе **подписывание пакета iOS** вкладки, как показано на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image11.png "Настройка проекта Xamarin.iOS для использования нового профиля подготовки")](remote-notifications-in-ios-images/image11.png#lightbox)

На этом этапе приложение настроено для работы с Push-уведомлений. Тем не менее по-прежнему существует несколько дополнительных действий, необходимых с сертификатом. Этот сертификат находится в DER-формате, который не совместим с PushSharp, который должен быть сертификат обмена личной информацией (PKCS12). Чтобы преобразовать сертификат, который должен использоваться PushSharp, выполнения этих действий:

1.  **Скачать файл сертификата** -вкладка "Сертификаты" выбранное имя входа на портал подготовки IOS, выберите сертификат, связанный с нужный профиль подготовки и выбрать **загрузить** .
1.  **Откройте доступ к цепочке ключей** -это приложение имеет Графический интерфейс пользователя в систему управления пароля в OS X.
1.  **Импортируйте сертификат** — Если добавляемой еще не установлен, **файл... Импорт элементов** меню доступ к цепочке ключей. Перейдите к сертификату, который экспортирован выше и выберите его.
1.  **Экспорт сертификата** — развернуть отображается связанный закрытый ключ сертификата, щелкните правой кнопкой мыши на ключ и выбрали экспорта. Вам будет предложено ввести имя файла и пароль для экспортируемого файла.

На этом этапе мы выполняются с помощью сертификатов. Мы создали сертификат, который будет использоваться для подписывания приложений iOS и преобразовать этот сертификат в формате, который может использоваться с PushSharp в серверном приложении. Далее рассмотрим взаимодействия приложений iOS с APNS.

## <a name="registering-with-apns"></a>Регистрация с помощью APNS

Прежде чем iOS приложение может получить удаленный уведомления, его необходимо зарегистрировать с помощью APNS. APNS создаст уникальный маркер и возвратить его в приложение iOS. Приложение iOS будет предпринимать маркер устройства и затем зарегистрироваться с сервером приложений. После этого все регистрации завершена, и сервер приложений может Push-уведомления на мобильное устройство.

В теории маркер устройства может меняться при каждом приложения iOS регистрирует себя с помощью APNS, однако на практике это не происходит, часто. Для оптимизации приложения кэширования последних маркер устройства и обновлять сервер приложений, только когда это приводит к изменению. Следующая схема иллюстрирует процесс регистрации и получения маркера устройства:

 ![](remote-notifications-in-ios-images/image12.png "На этой схеме показан процесс регистрации и получения маркера устройства")

Регистрация с помощью APNS обрабатывается в `FinishedLaunching` метод класса делегата приложения путем вызова `RegisterForRemoteNotificationTypes` в текущем `UIApplication` объекта. При регистрации приложения iOS с помощью APNS его необходимо также указать, какие виды удаленных уведомлений его хотите получать. Эти типы удаленного уведомления объявляются в перечислении `UIRemoteNotificationType`. В следующем фрагменте кода приведен пример как приложение iOS может зарегистрироваться для получения удаленных оповещение и всплывающих уведомлениях:

```csharp
if (UIDevice.CurrentDevice.CheckSystemVersion (8, 0)) {
    var pushSettings = UIUserNotificationSettings.GetSettingsForTypes (
                       UIUserNotificationType.Alert | UIUserNotificationType.Badge | UIUserNotificationType.Sound,
                       new NSSet ());

    UIApplication.SharedApplication.RegisterUserNotificationSettings (pushSettings);
    UIApplication.SharedApplication.RegisterForRemoteNotifications ();
} else {
    UIRemoteNotificationType notificationTypes = UIRemoteNotificationType.Alert | UIRemoteNotificationType.Badge | UIRemoteNotificationType.Sound;
    UIApplication.SharedApplication.RegisterForRemoteNotificationTypes (notificationTypes);
}
```

Запрос на регистрацию APNS происходит в фоновом режиме — при получении ответа iOS вызовет метод `RegisteredForRemoteNotifications` в `AppDelegate` и передайте маркер зарегистрированного устройства. Токен будет содержаться в `NSData` объекта. В следующем фрагменте кода показано, как получить маркер устройства, APNS, предоставляемые:

```csharp
public override void RegisteredForRemoteNotifications (
UIApplication application, NSData deviceToken)
{
    // Get current device token
    var DeviceToken = deviceToken.Description;
    if (!string.IsNullOrWhiteSpace(DeviceToken)) {
        DeviceToken = DeviceToken.Trim('<').Trim('>');
    }

    // Get previous device token
    var oldDeviceToken = NSUserDefaults.StandardUserDefaults.StringForKey("PushDeviceToken");

    // Has the token changed?
    if (string.IsNullOrEmpty(oldDeviceToken) || !oldDeviceToken.Equals(DeviceToken))
    {
        //TODO: Put your own logic here to notify your server that the device token has changed/been created!
    }

    // Save new device token
    NSUserDefaults.StandardUserDefaults.SetString(DeviceToken, "PushDeviceToken");
}
```

При сбое регистрации для какой-либо причине (например, устройство не подключено к Интернету), iOS будет вызывать `FailedToRegisterForRemoteNotifications` приложения класс делегата. В следующем фрагменте кода показан способ отображения предупреждения пользователю о том, регистрация завершается ошибкой:

```csharp
public override void FailedToRegisterForRemoteNotifications (UIApplication application , NSError error)
{
    new UIAlertView("Error registering push notifications", error.LocalizedDescription, null, "OK", null).Show();
}
```

### <a name="device-token-housekeeping"></a>Маркер устройства по обслуживанию

Маркеры устройств будет устареть или меняться со временем. По этой причине серверные приложения нужно будет сделать некоторые очистки дома и очистить эти маркеры с истекшим сроком действия или измененные. Когда приложение отправляет в виде Push-уведомлений на устройство с истекшим сроком действия маркера, APNS будет записать и сохранить этот маркер истекшим сроком действия. Серверы могут запросить APNS, чтобы узнать, какие маркеры, истек срок действия.

APNS используется для предоставления *обратной связи службы* -конечная точка HTTPS, выполняющий проверку подлинности с помощью сертификата, который был создан для отправки отправки уведомлений и отправляет назад данных о какие маркеров, истек срок действия. Это нерекомендуемая компанией Apple и удалены.

Вместо этого появился новый код состояния HTTP для случая, который был ранее, указываемого службой обратной связи:

> 410 - маркер устройства больше не активна для раздела.

Кроме того, новый `timestamp` ключ данных JSON будет находиться в тексте ответа:

> Если значение в: заголовок состояние 410, значение этого ключа — это время последней, по которому APNs подтверждает, что маркер устройства больше не является допустимым для раздела.
>
> Остановите, пока устройство регистрирует маркер с поздней временной меткой с поставщиком Push-уведомления.

## <a name="summary"></a>Сводка

В этом разделе представлены основные понятия, окружающие Push-уведомлений в iOS. Оно описывает роли из Apple Push Notification шлюз Service (APNS). Затем он рассматривается создание и использование сертификатов безопасности, которые необходимы для APNS. Наконец в этом документе закончил разработку с рассказа о том, как можно использовать серверы приложений *обратной связи служб* на прекращение отслеживания истечения срока действия маркеров устройств.


## <a name="related-links"></a>Связанные ссылки

- [Уведомления — Демонстрация локальных и удаленных уведомлений (пример)](https://developer.xamarin.com/samples/monotouch/Notifications/)
- [Локальных и Push-уведомлений для разработчиков](https://developer.apple.com/notifications/)
- [UIApplication](http://iosapi.xamarin.com/?link=T%3aMonoTouch.UIKit.UIApplication)
- [UIRemoteNotificationType](http://iosapi.xamarin.com/?link=T%3aMonoTouch.UIKit.UIRemoteNotificationType)
