---
title: Общие сведения о переносимых библиотеках классов (PCL)
description: В этой статье описываются проекты переносимой библиотеки классов (PCL) и рассматривается создание и использование проектов PCL в Visual Studio для Mac и Visual Studio.
ms.prod: xamarin
ms.assetid: 76ba8f7a-9b6e-40f5-9a29-ff1274ece4f2
author: conceptdev
ms.author: crdun
ms.date: 07/18/2018
ms.openlocfilehash: a4ee81f7d59c9fb680dfd371a7aaba7660fb3343
ms.sourcegitcommit: 9bfedf07940dad7270db86767eb2cc4007f2a59f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/21/2019
ms.locfileid: "68681072"
---
# <a name="portable-class-libraries-pcl"></a>Переносимые библиотеки классов (PCL)

> [!TIP]
> Переносимые библиотеки классов (PCL) считаются устаревшими в последних версиях Visual Studio.
> Хотя вы по-прежнему можете открывать, изменять и компилировать PCL для новых проектов, рекомендуется использовать [библиотеки .NET Standard](~/cross-platform/app-fundamentals/net-standard.md) для доступа к более крупной контактной зоне API.

Ключевым компонентом создания кросс-платформенных приложений является возможность совместного использования кода в различных проектах для конкретной платформы. Однако это усложняется тем, что на разных платформах часто используется другой поднабор библиотеки базовых классов (BCL) .NET, и, следовательно, они построены в другом профиле библиотеки .NET Core. Это означает, что каждая платформа может использовать только библиотеки классов, предназначенные для того же профиля, поэтому они должны будут требовать наличия отдельных проектов библиотеки классов для каждой платформы.

Существует три основных подхода к совместному использованию кода, которые позволяют решить эту проблему: **.NET Standard проекты**, **проекты общих ресурсов**и **проекты переносимой библиотеки классов (PCL)** .

- **.NET Standard проекты** являются предпочтительным подходом к совместному использованию кода .NET, Узнайте больше о [.NET Standard проектах и Xamarin](~/cross-platform/app-fundamentals/net-standard.md).
- **Проекты общих ресурсов** используют один набор файлов и предлагают быстрый и простой способ совместного использования кода в решении и обычно использует директивы условной компиляции для указания путей кода для различных платформ, которые будут его использовать (дополнительные см. [статью общие](~/cross-platform/app-fundamentals/shared-projects.md)сведения о проектах.
- Проекты **PCL** предназначены для конкретных профилей, которые поддерживают известный набор классов и функций BCL. Однако из-за недостаточной части в PCL часто требуются дополнительные архитектурные усилия для разделения кода конкретного профиля на собственные библиотеки.

На этой странице объясняется, как создать проект **PCL** , нацеленный на конкретный профиль, на который затем могут ссылаться несколько проектов для конкретных платформ.

## <a name="what-is-a-portable-class-library"></a>Что такое Переносимая библиотека классов?

При создании проекта приложения или проекта библиотеки результирующая библиотека DLL может работать только на той платформе, для которой она создается. Это не позволит вам писать сборку для приложения Windows, а затем повторно использовать его в Xamarin. iOS и Xamarin. Android.

Однако при создании переносимой библиотеки классов можно выбрать комбинацию платформ, в которой должен выполняться код. Варианты совместимости, вносимые при создании переносимой библиотеки классов, преобразуются в идентификатор "Profile", который описывает платформы, поддерживаемые библиотекой.

В таблице ниже показаны некоторые функции, зависящие от платформы .NET. Для написания сборки PCL, которая гарантированно будет выполняться на конкретных устройствах и платформах, вы просто выбираете, какая поддержка необходима при создании проекта.

|Возможность|.NET Framework|приложения универсальной платформы Windows;|Silverlight|Windows Phone|Xamarin|
|---|---|---|---|---|---|
|Ядро|Y|Y|Y|Y|Y|
|LINQ|Y|Y|Y|Y|Y|
|IQueryable|Y|Y|Y|7,5 +|Y|
|Сериализация|Y|Y|Y|Y|Y|
|Заметки к данным|4.0.3 +|Y|Y||Y|

Столбец Xamarin отражает тот факт, что Xamarin. iOS и Xamarin. Android поддерживают все профили, поставляемые с Visual Studio, а доступность функций в любых создаваемых библиотеках будет ограничена только другими платформами, которые вы выбрали для поддержки.

К ним относятся профили, которые являются комбинациями:

- .NET 4 или .NET 4,5
- Silverlight 5
- Windows Phone 8
- приложения универсальной платформы Windows;

Вы можете прочитать дополнительные сведения о возможностях различных профилей на [веб-сайте Майкрософт](https://msdn.microsoft.com/library/gg597391(v=vs.110).aspx) и просмотреть [сводку профиля PCL](http://embed.plnkr.co/03ck2dCtnJogBKHJ9EjY) , включающую сведения о поддерживаемых платформах и другие примечания.

**Преимущества**

1. Централизованное совместное использование кода — написание и тестирование кода в одном проекте, который может использоваться другими библиотеками или приложениями.
2. Операции рефакторинга будут влиять на весь код, загруженный в решении (Переносимая библиотека классов и проекты для конкретных платформ).
3. На проект PCL можно легко ссылаться из других проектов в решении, или выходную сборку можно использовать совместно, чтобы другие пользователи могли ссылаться на них в своих решениях.

**Недостатки**

1. Поскольку одна и та же Переносимая библиотека классов совместно используется несколькими приложениями, на библиотеки, относящиеся к платформе, нельзя ссылаться (например, Community. Кшарпсклите. WP7).
2. Подмножество переносимой библиотеки классов может не включать классы, которые в противном случае были бы доступны как с помощью монохромного касания, так и Mono для Android (например, DllImport или System. IO. File).

> [!NOTE]
> Переносимые библиотеки классов в последней версии Visual Studio являются устаревшими, а вместо них рекомендуется использовать [.NET Standard библиотек](net-standard.md) .

В некоторой степени недостатки можно обойти с помощью шаблона поставщика или внедрения зависимостей, чтобы создать код фактической реализации в проектах платформы по отношению к интерфейсу или базовому классу, определенному в переносимой библиотеке классов.

На этой схеме показана архитектура кросс-платформенного приложения с использованием переносимой библиотеки классов для совместного использования кода, но также использование внедрения зависимостей для передачи функций, зависящих от платформы:

[![](pcl-images/image1.png "This diagram shows the architecture of a cross-platform application using a Portable Class Library to share code, but also using Dependency Injection to pass in platform-dependent features")](pcl-images/image1.png#lightbox)

# <a name="visual-studio-for-mactabmacos"></a>[Visual Studio для Mac](#tab/macos)

## <a name="visual-studio-for-mac-walkthrough"></a>Пошаговое руководство по Visual Studio для Mac

В этом разделе описывается создание и использование переносимой библиотеки классов с помощью Visual Studio для Mac. Полную реализацию см. в разделе пример для PCL.

### <a name="creating-a-pcl"></a>Создание PCL

Добавление переносимой библиотеки классов в решение очень похоже на добавление обычного проекта библиотеки.

1. В диалоговом окне **Новый проект** выберите параметр **многоплатформенная библиотека > > переносимой библиотеке** :

    ![Создание нового проекта PCL](pcl-images/image2.png)

1. При создании PCL в Visual Studio для Mac он автоматически настраивается с помощью профиля, который работает для Xamarin. iOS и Xamarin. Android. Откроется проект PCL, как показано на следующем снимке экрана:

    ![Проект PCL на панели решения](pcl-images/image3.png)

Теперь PCL готов к добавлению кода. На него также могут ссылаться другие проекты (проекты приложений, проекты библиотек и даже другие проекты PCL).

### <a name="editing-pcl-settings"></a>Изменение параметров PCL

Чтобы просмотреть и изменить параметры PCL для этого проекта, щелкните проект правой кнопкой мыши и выберите **параметры > сборка > общие** , чтобы увидеть показанный здесь экран:

[![PCL параметры проекта для задания профиля](pcl-images/image4-sml.png)](pcl-images/image4.png#lightbox)

Нажмите кнопку **изменить...** , чтобы изменить целевой профиль для этой переносимой библиотеки классов.

Если профиль был изменен после добавления кода в PCL, то возможно, что библиотека больше не будет компилироваться, если код ссылается на компоненты, которые не являются частью вновь выбранного профиля.

## <a name="working-with-a-pcl"></a>Работа с PCL

При написании кода в библиотеке PCL редактор Visual Studio для Mac будет распознавать ограничения выбранного профиля и соответствующим образом настроить параметры автозавершения. Например, на этом снимке экрана показаны параметры автозаполнения для System.IO с использованием профиля по умолчанию (Profile136), используемого в Visual Studio для Mac — Обратите внимание на полосу прокрутки, которая показывает, что отображается около половины доступных классов (в действительности только 14 доступные классы).

[![Intellisense список 14 классов в классе System.IO для PCL](pcl-images/image6.png)](pcl-images/image6.png#lightbox)

Сравните это с автозавершением System.IO в проекте Xamarin. iOS или Xamarin. Android — доступно 40 классов, включая часто используемые классы, такие как `File` и `Directory`, которые не находятся ни в одном из профилей PCL.

[![Intellisense список классов 40 в пространстве имен .NET Framework System.IO](pcl-images/image7.png)](pcl-images/image7.png#lightbox)

Это отражает базовую компромисс использования PCL — возможность беспрепятственного совместного использования кода на многих платформах означает, что некоторые API недоступны, так как они не имеют сравнимых реализаций на всех возможных платформах.

### <a name="using-pcl"></a>Использование PCL

После создания проекта PCL можно добавить ссылку на него из любого совместимого приложения или проекта библиотеки так же, как обычно добавляются ссылки. В Visual Studio для Mac щелкните правой кнопкой мыши узел ссылки и выберите **изменить ссылки.** затем перейдите на вкладку **проекты** , как показано ниже.

[![Add ссылки на PCL с помощью параметра Edit References](pcl-images/image8.png)](pcl-images/image8.png#lightbox)

На следующем снимке экрана показана панель решения для примера приложения Таскипортабле, которая показывает библиотеку PCL внизу и ссылку на библиотеку PCL в проекте Xamarin. iOS.

[![TaskyPortable пример решения, демонстрирующий проект PCL](pcl-images/image9.png)](pcl-images/image9.png#lightbox)

Выходные данные PCL (Internet Explorer, результирующая сборка DLL) также можно добавить в качестве ссылки на большинство проектов. Это делает PCL идеальным способом поставки межплатформенных компонентов и библиотек.

# <a name="visual-studiotabwindows"></a>[Visual Studio](#tab/windows)

## <a name="visual-studio-walkthrough"></a>Пошаговое руководство по Visual Studio

В этом разделе описывается создание и использование переносимой библиотеки классов с помощью Visual Studio. Полную реализацию см. в разделе пример для PCL.

### <a name="creating-a-pcl"></a>Создание PCL

Добавление PCL в решение в Visual Studio немного отличается от добавления обычного проекта:

1. На экране **Добавление нового проекта** выберите вариант **Библиотека классов (унаследованная Переносимая)** . Обратите внимание, что в описании справа указано, что этот тип проекта является устаревшим.

    [![Новое окно проекта для создания переносимой библиотеки классов](pcl-images/image10-sml.png "Переносимая библиотека классов")](pcl-images/image10.png#lightbox)

2. Visual Studio сразу же выводит запрос со следующим диалоговым окном, чтобы можно было настроить профиль.
 Установите тактовые платформы, которые необходимо поддерживать, и нажмите кнопку ОК.

    [![Выберите целевые платформы для библиотеки](pcl-images/image11-sml.png "Тактовая поддержка платформ, которые необходимо поддерживать, и нажатие кнопки ОК")](pcl-images/image11.png#lightbox)

3. Проект PCL будет отображаться, как показано в обозреватель решений &ndash; текст **(переносимый)** отображается рядом с именем проекта, чтобы указать, что это PCL:

    ![NET Framework, определяемая профилем PCL](pcl-images/image12.png "NET Framework, определяемая профилем PCL")

Теперь PCL готов к добавлению кода. На него также могут ссылаться другие проекты (проекты приложений, проекты библиотек и даже другие проекты PCL).

### <a name="editing-pcl-settings"></a>Изменение параметров PCL

Параметры PCL можно просмотреть и изменить, щелкнув проект правой кнопкой мыши и выбрав **свойства > библиотека** , как показано на следующем снимке экрана:

[![Edit целевые платформы](pcl-images/image13-sml.png)](pcl-images/image13.png#lightbox)

Если профиль был изменен после добавления кода в PCL, то возможно, что библиотека больше не будет компилироваться, если код ссылается на компоненты, которые не являются частью вновь выбранного профиля.

> [!TIP]
> Кроме того, есть сообщение о том, что **. NETStandard является рекомендуемым методом для совместного использования кода**. Это означает, что хотя PCL по-прежнему поддерживаются, рекомендуется выполнить обновление до .NET Standard.

### <a name="working-with-a-pcl"></a>Работа с PCL

При написании кода в библиотеке PCL Visual Studio распознает ограничения выбранного профиля и соответствующим образом корректирует параметры IntelliSense. Например, на этом снимке экрана показаны параметры автозаполнения для System.IO с использованием профиля по умолчанию (Profile136) — Обратите внимание на полосу прокрутки, которая указывает на отображение около половины доступных классов (на самом деле доступно только 14 классов).

[![Reduced число классов ввода-вывода, доступных в PCL](pcl-images/image14.png)](pcl-images/image14.png#lightbox)

Сравните это с System.IO автозавершением в регулярном проекте — доступно 40 классов, включая часто используемые классы, такие как `File` и `Directory`, которые не находятся ни в одном профиле PCL.

[![Many больше классов ввода-вывода, доступных в .NET Framework](pcl-images/image15.png)](pcl-images/image15.png#lightbox)

Это отражает базовую компромисс использования PCL — возможность беспрепятственного совместного использования кода на многих платформах означает, что некоторые API недоступны, так как они не имеют сравнимых реализаций на всех возможных платформах.

> [!TIP]
> .NET Standard 2,0 представляет гораздо более крупную контактную зону API, чем PCL, включая пространство имен System.IO. Для новых проектов вместо PCL рекомендуется использовать .NET Standard.

### <a name="using-pcl"></a>Использование PCL

После создания проекта PCL можно добавить ссылку на него из любого совместимого приложения или проекта библиотеки так же, как обычно добавляются ссылки. В Visual Studio щелкните правой кнопкой мыши узел ссылки и выберите `Add Reference...` затем перейдите на вкладку **решение > проектов** , как показано ниже.

[![Add ссылки на PCL с помощью вкладки "добавить ссылочные проекты"](pcl-images/image16.png)](pcl-images/image16.png#lightbox)

На следующем снимке экрана показана область решения для примера приложения Таскипортабле с библиотекой PCL внизу и ссылкой на библиотеку PCL в проекте Xamarin. iOS.

[![TaskyPortable пример решения, показывающего библиотеку PCL](pcl-images/image17.png)](pcl-images/image17.png#lightbox)

Выходные данные PCL (Internet Explorer, результирующая сборка DLL) также можно добавить в качестве ссылки на большинство проектов.
Это делает PCL идеальным способом поставки межплатформенных компонентов и библиотек.

-----

## <a name="pcl-example"></a>Пример PCL

В примере приложения [таскипортабле](https://docs.microsoft.com/samples/xamarin/mobile-samples/taskyportable/) показано, как можно использовать переносимую библиотеку классов с Xamarin.
Ниже приведены некоторые снимки экрана приложений, работающих в iOS и Android.

[![](pcl-images/image18.png "Here are some screenshots of the resulting apps running on iOS, Android and Windows Phone")](pcl-images/image18.png#lightbox)

Он использует несколько классов данных и логики, которые являются исключительно переносимым кодом, а также показывает, как внедрять требования для конкретной платформы с помощью внедрения зависимостей для реализации базы данных SQLite.

Структура решения показана ниже (в Visual Studio для Mac и Visual Studio соответственно):

[![](pcl-images/image19.png "The solution structure is shown here in Visual Studio for Mac and Visual Studio respectively")](pcl-images/image19.png#lightbox)

Поскольку код SQLite-NET содержит части, зависящие от платформы (для работы с реализациями SQLite в каждой другой операционной системе), они были подвергнуты рефакторингу в абстрактный класс, который можно скомпилировать в переносимую библиотеку классов. фактический код, реализованный как подклассы в проектах iOS и Android.

### <a name="taskyportablelibrary"></a>таскипортаблелибрари

Переносимая библиотека классов ограничена функциями .NET, которые она может поддерживать. Поскольку он компилируется для выполнения на нескольких платформах, он не может использовать функции `[DllImport]`, которые используются в SQLite-NET. Вместо этого SQLite-NET реализуется как абстрактный класс, а затем на него ссылается остальная часть общего кода. Извлечение абстрактного API показано ниже.

```csharp
public abstract class SQLiteConnection : IDisposable {

    public string DatabasePath { get; private set; }
    public bool TimeExecution { get; set; }
    public bool Trace { get; set; }
    public SQLiteConnection(string databasePath) {
         DatabasePath = databasePath;
    }
    public abstract int CreateTable<T>();
    public abstract SQLiteCommand CreateCommand(string cmdText, params object[] ps);
    public abstract int Execute(string query, params object[] args);
    public abstract List<T> Query<T>(string query, params object[] args) where T : new();
    public abstract TableQuery<T> Table<T>() where T : new();
    public abstract T Get<T>(object pk) where T : new();
    public bool IsInTransaction { get; protected set; }
    public abstract void BeginTransaction();
    public abstract void Rollback();
    public abstract void Commit();
    public abstract void RunInTransaction(Action action);
    public abstract int Insert(object obj);
    public abstract int Update(object obj);
    public abstract int Delete<T>(T obj);

    public void Dispose()
    {
        Close();
    }
    public abstract void Close();

}
```

Оставшаяся часть общего кода использует абстрактный класс для хранения и извлечения объектов из базы данных. В любом приложении, использующем этот абстрактный класс, необходимо передать полную реализацию, которая предоставляет реальные функции базы данных.

### <a name="taskyandroid-and-taskyios"></a>Таскяндроид и Таскиос

Проекты приложений iOS и Android содержат пользовательский интерфейс и другой код, зависящий от платформы, используемый для подключения общего кода в PCL.

Эти проекты также содержат реализацию абстрактного API базы данных, который работает на этой платформе. В iOS и Android ядро базы данных SQLite встроено в операционную систему, поэтому реализация может использовать `[DllImport]`, как показано, чтобы обеспечить конкретную реализацию подключения к базе данных. Выдержка из кода реализации для конкретной платформы показана ниже:

```csharp
[DllImport("sqlite3", EntryPoint = "sqlite3_open")]
public static extern Result Open(string filename, out IntPtr db);

[DllImport("sqlite3", EntryPoint = "sqlite3_close")]
public static extern Result Close(IntPtr db);
```

Полную реализацию можно увидеть в примере кода.

## <a name="summary"></a>Сводка

В этой статье кратко обсуждались преимущества и ловушки переносимых библиотек классов, в которых демонстрируется создание и использование PCL из Visual Studio для Mac и Visual Studio. и, наконец, появился полный пример приложения — Таскипортабле —, в котором показана PCL в действии.

## <a name="related-links"></a>Связанные ссылки

- [Таскипортабле (пример)](https://docs.microsoft.com/samples/xamarin/mobile-samples/taskyportable/)
- [Создание кроссплатформенных приложений](~/cross-platform/app-fundamentals/building-cross-platform-applications/index.md)
- [Переносимые Visual Basic](~/cross-platform/platform/visual-basic/index.md)
- [Общие проекты](~/cross-platform/app-fundamentals/shared-projects.md)
- [Параметры общего доступа к коду](~/cross-platform/app-fundamentals/code-sharing.md)
- [Кросс-платформенная разработка с помощью .NET Framework (Майкрософт)](https://docs.microsoft.com/dotnet/standard/cross-platform/cross-platform-development-with-the-portable-class-library)
