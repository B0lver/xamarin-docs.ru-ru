---
title: Создание Android служб
description: В этом руководстве рассматриваются Xamarin.Android службы, являющиеся Android компонентов, которые позволяют выполнить без активных пользовательский интерфейс. Службы очень часто используются для задач, выполняемых в фоновом режиме, например много времени вычислений, загрузка файлов, музыка и т. д. Он описаны различные сценарии, подходящие для службы и показано, как реализовать их как для выполнения фоновой длительно выполняемых задач, а также для предоставления интерфейса для удаленных вызовов процедур.
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: topgenorth
ms.author: toopge
ms.date: 03/19/2018
ms.openlocfilehash: 92eabbec31b654f1aefcffb99ec2ed14062e8681
ms.sourcegitcommit: d80d93957040a14b4638a91b0eac797cfaade840
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/07/2018
ms.locfileid: "34847381"
---
# <a name="creating-android-services"></a>Создание Android служб

_В этом руководстве рассматриваются Xamarin.Android службы, являющиеся Android компонентов, которые позволяют выполнить без активных пользовательский интерфейс. Службы очень часто используются для задач, выполняемых в фоновом режиме, например много времени вычислений, загрузка файлов, музыка и т. д. Он описаны различные сценарии, подходящие для службы и показано, как реализовать их как для выполнения фоновой длительно выполняемых задач, а также для предоставления интерфейса для удаленных вызовов процедур._

## <a name="android-services-overview"></a>Общие сведения о службах Android

Мобильные приложения не похожи на классических приложениях. Настольные компьютеры имеют большое количество ресурсов, например площадь экрана, память, дисковое пространство и подключенный источник питания, мобильных устройств нет. Эти ограничения принудительное мобильных приложений ведут себя по-разному. Например маленьком экране на мобильном устройстве обычно означает, что одновременно отображается, только одно приложение (т. е. действие). Другие действия перемещения в фоновом режиме и передаче в приостановленном состоянии, когда они не могут выполнять никаких действий. Тем не менее только потому, что приложение находится в фоновом режиме означает, что его невозможно для приложения продолжить работу. 

Приложения Android состоят из по крайней мере один из следующих четырех основных компонентов: _действия_, _широковещательных приемники_, _поставщики содержимого_и _Службы_. Действия лежат в основе многих значительные приложений Android, так как они предоставляют пользовательский Интерфейс, позволяющий пользователю взаимодействовать с приложением. Тем не менее когда дело доходит до выполнения параллельной или фоновой работы, действий не всегда являются лучшим вариантом.
 
Является основным механизмом фоновой работы в Android _службы_. Android службы — это компонент, предназначенный для выполнения некоторых задач без пользовательского интерфейса. Служба может загрузить файл, послушать музыку или применить фильтр к изображению. Службы могут также использоваться для взаимодействия между процессами (_IPC_) между приложениями для Android. Например одно приложение Android с помощью музыка player — это служба, другое приложение или приложение может предоставлять данные (например, контактные данные человека) в другие приложения с помощью службы. 

Службы и возможности для выполнения фоновой работы чрезвычайно важны для предоставление smooth и жидкости пользовательского интерфейса. Все приложения Android имеют _основной поток_ (также известный как _поток пользовательского интерфейса_), на котором выполняются действия. Для обеспечения быстрого реагирования устройства, Android должны иметь возможность обновить пользовательский интерфейс с частотой 60 кадров в секунду. Если приложение Android выполняет слишком большой объем работы в основном потоке, а затем Android приводит к потере кадров, что в свою очередь вызывает пользовательский Интерфейс для отображения рывками (иногда также называют _janky_). Это означает, что вся работа выполняется в потоке пользовательского интерфейса должна завершиться в промежутке времени между двумя кадрами, приблизительно 16 миллисекунд (1 второй каждые 60 кадров). 

Чтобы устранить эту проблему, разработчик может использовать потоки в действии для выполнения части работы, которая может блокировать пользовательский Интерфейс. Тем не менее это может вызвать проблемы. Это вполне вероятно, что Android уничтожит и повторно создать несколько экземпляров действия. Однако Android не приведет к удалению автоматически потоки, которые могут стать причиной утечки памяти. Простым примером этого является при [повороте устройства](~/android/app-fundamentals/handling-rotation.md) &ndash; Android попытается удалить экземпляр действия и затем повторно создать новый:

![При повороте устройства, 1 экземпляр уничтожается и создается экземпляр 2](images/image-01.png)

Это представляет потенциальную утечку памяти &ndash; по-прежнему будут выполняться потока, созданного первого экземпляра действия. Если поток имеет ссылку на первый экземпляр действия, это будет препятствовать Android объект сбор мусора. Однако второй экземпляр действия по-прежнему создается (который в свою очередь может создать новый поток). Поворот устройства несколько раз в течение короткого промежутка времени может исчерпать всю ПАМЯТЬ и принудительно Android завершить работу всего приложения для освобождения памяти.

Как правило если выполняемой работы следует пережить действия, затем службы должны создаваться для выполнения этой работы. Тем не менее если работу применим только в контексте действия, затем создание потока для выполнения работы может оказаться более подходящей. Например Создание эскиза для фотографий, добавленный к приложению коллекции фотографий, скорее всего, произойдет в службе. Тем не менее поток может быть более удобным использовать для воспроизведения некоторые музыка, следует слышали только во время действия находится на переднем плане.

Фоновая операция можно разделить на две широкие категории:

1. **Длинные выполняемая задача** &ndash; это работы, еще выполняется, пока не будет остановлен. Пример _долго выполняющихся задач_ — это приложение, которое выполняет потоковую передачу музыки или, необходимо отслеживать данные, собранные из датчика. Эти задачи необходимо запустить, даже если приложение не имеет видимого пользовательского интерфейса.
2. **Периодические задачи** &ndash; (иногда называют _задания_) периодической задачи — задача, которая имеет короткое длительность (несколько секунд) и запускается по расписанию (т. е. один раз в день, неделю или, возможно, только один раз в Далее 60 секунд). Примером этого загрузки файла из Интернета или Создание эскиза для изображения.

Существует четыре различных типа Android служб:

* **Привязать службы** &ndash; A _привязан службы_ — это служба, с какой-либо компонент (обычно действия) привязанным к нему. Связанные службы предоставляет интерфейс, который позволяет связанный компонент и службы для взаимодействия друг с другом. Как только появятся дополнительные клиенты не привязан к службе, Android завершит работу службы. 

* **`IntentService`** &ndash; _`IntentService`_ Является специализированным подклассом `Service` класс, который упрощает создание службы и использования. `IntentService` Предназначен для обработки отдельных вызовов автономной. В отличие от службы, которая может одновременно обрабатывать несколько вызовов, `IntentService` , больше напоминает _работы очереди процессора_ &ndash; помещено рабочих и `IntentService` обрабатывает каждое задание один одновременно в одном рабочем потоке. Как правило`IntentService` не привязан к действию или фрагмент. 

* **Служба запущена** &ndash; A _запустил службу_ — служба, которая была запущена с какой-либо Android компонент (например, действия) и выполняется непрерывное в фоновом режиме, пока что-то явно указывает остановку службы. В отличие от привязанной службы служба, запускаемая не имеет любых клиентов, которые привязаны непосредственно к нему. По этой причине важно разработать запущенные службы, таким образом, чтобы они могут правильно перезапущены при необходимости.

* **Гибридная служба** &ndash; A _гибридная служба_ — это служба, имеющий характеристики _запустил службу_ и _привязан службы_. Гибридная служба запускается при привязывает к этому экземпляру компонента, или оно может начаться либо событием. Клиентский компонент может или не может быть привязан к службе гибридной. Гибридная служба будут продолжать работать до его явным образом сообщать, чтобы остановить или Дополнительные клиенты отсутствуют связанные с ним.

Какой тип службы, очень зависит от требований приложения. Как правило `IntentService` или связанные службы достаточно для большинства задач, которые должен выполнять приложения, поэтому предпочтений должен быть предоставлен для одного из этих двух типов служб. `IntentService` Лучше всего подойдет для «одноступенчатая» задачи, такие как загрузки файла, а привязанной службы будет подходит при необходимости частого взаимодействия с действие/фрагмент. 

Хотя большинство служб выполняется в фоновом режиме, есть специальные подкатегорий, известный как _службы переднего плана_. Это служба, которая имеет более высокий приоритет (по сравнению с обычным) для выполнения некоторых операций для пользователя (например, при воспроизведении музыки). 

Можно также для запуска службы в собственный процесс на одном устройстве, это иногда называется _удаленной службы_ или как _out of process службы_. Для этого требуются дополнительные усилия, чтобы создать, но может быть полезным для, когда приложению требуется совместного использования функциональных возможностей с другими приложениями и в некоторых случаях повышения удобства работы пользователей приложения. 

### <a name="background-execution-limits-in-android-80"></a>Ограничения выполнения фона в Android 8.0

Начиная с 8.0 Android (API уровня 26), приложение больше не могут свободно выполнение в фоновом режиме. В случае переднего плана, приложение можно запустить и выполнить служб без ограничений. Когда приложение перемещает в фоновом режиме, Android предоставляет приложение определенное время для запуска и использования служб. По истечении этого времени приложения не смогут запускаться все службы и все службы, которые были запущены будет прервано. Эта точка находится AT невозможна для приложения для выполнения задач. Android считает, что приложение может на переднем плане, если выполнено одно из следующих условий:

* Имеется действие видимым (запущена или приостановлена).
* Передний план службы запуска приложения.
* Другое приложение находится на переднем плане и используются компоненты из приложения, в противном случае будет в фоновом режиме. Примером этого является ли объект приложения, который находится на переднем плане, привязка к услуга, предоставляемая приложения В приложение б. также будут считаться на переднем плане и не завершен системой Android за то, что в фоновом режиме.

Существуют ситуации, где, несмотря на то, что приложение находится в фоновом режиме, Android будет пробуждения приложения и ослабить эти ограничения в течение нескольких минут, что позволяет приложению для выполнения некоторых задач:
* Высокий приоритет Firebase облака сообщения, полученные приложением.
* Приложение получает вещания, такие как 
* Приложение получает выполняет `PendingIntent` в ответ на уведомление.

Существующие приложения Xamarin.Android может потребоваться изменить их работу фоновой работы, чтобы избежать проблем, которые могут возникнуть в Android 8.0. Ниже приведены некоторые практические alterantives на Android службу.

* **Планирования работы в фоновом режиме, с помощью планировщика заданий Android или [диспетчера заданий Firebase](~/android/platform/firebase-job-dispatcher.md)**  &ndash; эти две библиотеки предоставляют платформу для приложений, чтобы разделить работу фона в _заданий_, дискретные единица работы. Приложения можно затем запланировать задания с операционной системой, вместе с некоторыми критериями о выполнения задания.
* **Запустить службу на переднем плане** &ndash; службы переднего плана используется для при приложения необходимо выполнить некоторые задачи в фоновом режиме, и пользователь может потребоваться периодически взаимодействовать с этой задачей. Передний план службы будут отображаться постоянные уведомления, чтобы пользователь в виду, что приложение работает в фоновом режиме, а также предоставляет способ для мониторинга и взаимодействия с задачей. Примером будет приложении технология подкастов, воспроизведение подкаст пользователю или возможно загрузка эпизода подкастов, чтобы понравилось ее позже. 
* **Использовать высокий приоритет сообщения облака Firebase (FCM)** &ndash; Android при получении важным FCM для приложения, разрешит этого приложения для запуска служб в фоновом режиме на короткое время. Это было бы это хорошая альтернатива, что фоновая служба, которая опрашивает приложения в фоновом режиме. 
* **Отложить работы при приложение отображается на переднем плане** &ndash; Если ни один из перечисленных выше решений не работало, то приложения необходимо разработать собственные способ приостанавливать и возобновлять работу, когда приложение отображается на переднем плане.

## <a name="related-links"></a>Связанные ссылки

* [Ограничивает Android Oreo фонового выполнения](https://www.youtube.com/watch?v=Pumf_4yjTMc)
