---
title: Создание служб Android
description: В этом руководством обсуждаются службы Xamarin. Android, которые являются компонентами Android, которые позволяют выполнять работу без активного пользовательского интерфейса. Службы очень часто используются для задач, выполняемых в фоновом режиме, таких как расчеты времени, Загрузка файлов, воспроизведение музыки и т. д. В нем объясняются различные сценарии, которые подходят службам, и демонстрируется их реализация как для выполнения длительных фоновых задач, так и для предоставления интерфейса для удаленных вызовов процедур.
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 03/19/2018
ms.openlocfilehash: a28376535128b247ed807a33d46167a0eb497a90
ms.sourcegitcommit: aac10ff2da8065913a93008dfb0a7490bdad48c6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2020
ms.locfileid: "87172819"
---
# <a name="creating-android-services"></a>Создание служб Android

_В этом руководством обсуждаются службы Xamarin. Android, которые являются компонентами Android, которые позволяют выполнять работу без активного пользовательского интерфейса. Службы очень часто используются для задач, выполняемых в фоновом режиме, таких как расчеты времени, Загрузка файлов, воспроизведение музыки и т. д. В нем объясняются различные сценарии, которые подходят службам, и демонстрируется их реализация как для выполнения длительных фоновых задач, так и для предоставления интерфейса для удаленных вызовов процедур._

## <a name="android-services-overview"></a>Общие сведения о службах Android

Мобильные приложения не подобны классическим приложениям. Настольные системы имеют копиаус объемы ресурсов, таких как реальное пространство экрана, память, дисковое пространство и подключенный источник питания, а мобильные устройства — нет. Эти ограничения принуждает мобильные приложения работать по-разному. Например, маленький экран на мобильном устройстве обычно означает, что за один раз отображается только одно приложение (например, действие). Другие действия перемещаются в фон и передаются в состояние SUSPENDED, где они не могут выполнять какие-либо действия. Тем не менее, поскольку приложение Android находится в фоновом режиме, оно не означает, что приложение не может оставаться работоспособным. 

Приложения Android состоят по крайней мере из одного из следующих четырех основных компонентов: _действий_, _широковещательных приемников_, _поставщиков содержимого_и _служб_. Действия являются основой многих замечательных приложений Android, так как они предоставляют пользовательский интерфейс, позволяющий пользователю взаимодействовать с приложением. Однако, когда дело доходит до выполнения параллельной или фоновой работы, действия не всегда являются лучшим выбором.

Основным механизмом для фоновой работы в Android является _Служба_. Служба Android — это компонент, предназначенный для выполнения некоторой работы без пользовательского интерфейса. Служба может скачать файл, воспроизвести музыку или применить фильтр к изображению. Службы также могут использоваться для межпроцессного взаимодействия (_IPC_) между приложениями Android. Например, одно приложение Android может использовать службу музыкального проигрывателя, которая находится в другом приложении, или приложение может предоставлять данные (например, контактные данные пользователя) другим приложениям через службу. 

Службы и их возможность выполнять фоновую работу очень важны для обеспечения плавного и жидкостного пользовательского интерфейса. Все приложения Android имеют _основной поток_ (также известный как _поток пользовательского интерфейса_), на котором выполняются действия. Чтобы поддерживать отклики устройства, Android должен иметь возможность обновлять пользовательский интерфейс с частотой 60 кадров в секунду. Если приложение Android выполняет слишком много операций в основном потоке, то Android удалит кадры, что, в свою очередь, приводит к отображению пользовательского интерфейса жерки (также иногда называется _жанки_). Это означает, что любая работа, выполненная в потоке пользовательского интерфейса, должна завершиться за период времени между двумя кадрами, приблизительно 16 миллисекунд (1 секунда каждые 60 кадров). 

Чтобы решить эту проблему, разработчик может использовать потоки в действии для выполнения некоторой работы, которая блокирует пользовательский интерфейс. Однако это может вызвать проблемы. Очень вероятно, что Android удалит и воссоздаст несколько экземпляров действия. Однако Android не будет автоматически уничтожать потоки, что может привести к утечкам памяти. Простым примером этого является то, что [устройство поворачивается](~/android/app-fundamentals/handling-rotation.md) &ndash; Android, попытается уничтожить экземпляр действия, а затем вновь создать его:

![При повороте устройства экземпляр 1 уничтожается, и создается экземпляр 2](images/image-01.png)

Это может привести к утечке памяти &ndash; . поток, созданный первым экземпляром действия, по-прежнему будет выполняться. Если поток содержит ссылку на первый экземпляр действия, это не позволит Android выполнить сборку мусора объекта. Однако второй экземпляр действия все еще создается (что, в свою очередь, может создать новый поток). Несколько раз при быстром последовательном перемещении устройства может быть исчерпана вся оперативная память и принудительное использование Android для завершения работы всего приложения для освобождения памяти.

Как правило, если выполняемая работа должна вести действие, для выполнения этой работы должна быть создана служба. Однако если работа применима только в контексте действия, то создание потока для выполнения работы может быть более подходящим. Например, создание эскиза для фотографии, только что добавленного в приложение фотоальбома, возможно, будет происходить в службе. Тем не менее, поток может быть более подходящим для воспроизведения некоторых музыкальных файлов, которые должны быть слышны только тогда, когда действие находится на переднем плане.

Фоновую работу можно разделить на две основные категории:

1. **Долго выполняющаяся задача** &ndash; Это работает, пока не будет явно остановлена. Примером _длительно выполняемой задачи_ является приложение, которое осуществляет потоковую передачу музыки или отслеживание данных, собранных с датчика. Эти задачи должны выполняться, даже если приложение не имеет видимого пользовательского интерфейса.
2. **Периодические задачи** &ndash; (иногда называется _заданием_) Периодическая задача — это относительно короткий период (несколько секунд) и выполняется по расписанию (т. е. один раз в день недели или, возможно, только один раз в течение следующих 60 секунд). Примером этого является загрузка файла из Интернета или создание эскиза для изображения.

Существует четыре разных типа служб Android:

* **Связанная служба** &ndash; _Привязанная служба_ — это служба, к которой привязан какой-либо другой компонент (обычно это действие). Привязанная служба предоставляет интерфейс, который позволяет привязанному компоненту и службе взаимодействовать друг с другом. При отсутствии клиентов, привязанных к службе, Android прекратит работу службы. 

* **`IntentService`**&ndash; _`IntentService`_ — Это специализированный подкласс `Service` класса, который упрощает создание и использование служб. Предназначен `IntentService` для управления отдельными автономными вызовами. В отличие от службы, которая может параллельно обрабатывать несколько вызовов, `IntentService` более похоже на работу _обработчика рабочей очереди_ &ndash; и `IntentService` обрабатывает каждое задание по одному в одном рабочем потоке. Как правило, объект `IntentService` не привязан к действию или фрагменту. 

* **Служба запущена** &ndash; _Запущенная служба_ — это служба, которая была запущена другим компонентом Android (например, действием) и выполняется непрерывно в фоновом режиме до тех пор, пока не будет явно указано, что служба должна быть остановлена. В отличие от привязанной службы, запущенная служба не имеет напрямую привязанных к ней клиентов. Поэтому важно спроектировать запущенные службы, чтобы их можно было надлежащим образом перезапустить при необходимости.

* **Гибридная служба** &ndash; _Гибридная служба_ — это служба, которая имеет характеристики _запущенной службы_ и _привязанной службы_. Гибридную службу можно запустить, когда компонент привязывается к ней или запускается с помощью какого-либо события. Клиентский компонент может быть привязан к гибридной службе или не может быть связан. Гибридная служба будет работать до тех пор, пока она не будет явно перенаправлена на прекращение или пока к ней не привязано больше клиентов.

Используемый тип службы зависит от требований приложения. Как правило, `IntentService` или привязанная служба достаточно для большинства задач, которые должно выполнить приложение Android, поэтому предпочтение должно предоставляться одному из этих двух типов служб. `IntentService`Является хорошим выбором для однофакторных задач, таких как загрузка файла, в то время как привязанная Служба подходит, когда требуется частое взаимодействие с действием или фрагментом. 

Хотя большинство служб выполняются в фоновом режиме, существует особая Подкатегория, известная как _Служба переднего плана_. Это служба с более высоким приоритетом (по сравнению со стандартной службой) для выполнения некоторой работы для пользователя (например, воспроизведения музыки). 

Можно также запустить службу в собственном процессе на том же устройстве, но иногда это называется _удаленной службой_ или _службой вне процесса_. Это требует больше усилий для создания, но может быть полезен, когда приложению требуется совместно использовать функциональность с другими приложениями, и в некоторых случаях может улучшить взаимодействие с пользователем приложения. 

### <a name="background-execution-limits-in-android-80"></a>Ограничения фонового выполнения в Android 8,0

Начиная с Android 8,0 (API уровня 26), приложение Android больше не может свободно работать в фоновом режиме. Когда на переднем плане приложение может запускать и запускать службы без ограничений. Когда приложение перемещается в фоновый режим, Android предоставит приложению определенное время для запуска и использования служб. По истечении этого времени приложение больше не сможет запускать какие бы то ни было службы, а запущенные службы будут прерваны. На этом этапе приложению не удается выполнить какую-либо работу. При выполнении одного из следующих условий Android считает, что приложение находится на переднем плане.

* Отображается видимое действие (запущено или приостановлено).
* Приложение запустило службу переднего плана.
* Другое приложение находится на переднем плане и использует компоненты из приложения, которые в противном случае были бы в фоновом режиме. Примером этого является то, что приложение а, которое находится на переднем плане, привязано к службе, предоставляемой приложением б. Затем приложение B будет также рассматриваться на переднем плане, а не прерываться Android для работы в фоновом режиме.

В некоторых ситуациях, когда приложение находится в фоновом режиме, Android выводит приложение из спящего режима и ослабляет эти ограничения в течение нескольких минут, позволяя приложению выполнять некоторую работу:

* Приложение получает облачное сообщение с высоким приоритетом Firebase.
* Приложение получает вещание. 
* Приложение получает и выполняет `PendingIntent` в ответ на уведомление.

Существующим приложениям Xamarin. Android может потребоваться изменить способ выполнения фоновой работы, чтобы избежать проблем, которые могут возникнуть в Android 8,0. Ниже приведены некоторые практические альтернативы службе Android.

* **Планирование выполнения работы в фоновом режиме с помощью планировщика заданий Android или [диспетчера](~/android/platform/firebase-job-dispatcher.md) ** &ndash; заданий Firebase Эти две библиотеки предоставляют платформу для приложений, которые позволяют разделить фоновую работу на _задания_, дискретную единицу работы. Приложения могут запланировать задание в операционной системе вместе с некоторыми критериями, когда задание может быть запущено.
* **Запуск службы на переднем плане** &ndash; Служба переднего плана полезна, когда приложение должно выполнить некоторую задачу в фоновом режиме, и пользователю может потребоваться периодически взаимодействовать с этой задачей. В службе переднего плана будет отображаться постоянное уведомление, чтобы пользователь знал, что приложение выполняет фоновую задачу, а также предоставляет способ наблюдения или взаимодействия с задачей. Примером этого может быть приложение для создания подкастов, которое воспроизводит подкаст пользователю или, возможно, скачивает эпизод подкаста, чтобы его можно было использовать позже. 
* **Использование облачного сообщения с высоким приоритетом Firebase (FCM)** &ndash; Когда Android получает FCM с высоким приоритетом для приложения, он позволит этому приложению запускать службы в фоновом режиме в течение короткого периода времени. Это может быть хорошим вариантом для фоновой службы, которая опрашивает приложение в фоновом режиме. 
* **Отложить работу, когда приложение поступает в передний план** &ndash; Если ни одно из предыдущих решений не является приемлемым, приложения должны разработать собственный способ приостановки и возобновления работы, когда приложение поступает на передний план.

## <a name="related-links"></a>Связанные ссылки

* [Ограничения фонового выполнения Oreo для Android](https://www.youtube.com/watch?v=Pumf_4yjTMc)
