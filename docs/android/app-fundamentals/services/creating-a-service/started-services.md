---
title: Службы, запущенные с помощью Xamarin. Android
ms.prod: xamarin
ms.assetid: 8CC3A850-4CD2-4F93-98EE-AF3470794000
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 02/16/2018
ms.openlocfilehash: f5b5f8cf224c18852a0a0e7e4f591b49905ba026
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73024766"
---
# <a name="started-services-with-xamarinandroid"></a>Службы, запущенные с помощью Xamarin. Android

## <a name="started-services-overview"></a>Обзор служб запущен

Запущенные службы обычно выполняют единицу работы, не предоставляя клиенту никаких прямых отзывов или результатов. Примером единицы работы является служба, которая передает файл на сервер. Клиент выполнит запрос к службе, чтобы передать файл с устройства на веб-сайт. Служба будет без загрузок загружать файл (даже если приложение не имеет действий на переднем плане) и завершать его после завершения передачи. Важно понимать, что запущенная служба будет запускаться в потоке пользовательского интерфейса приложения. Это означает, что если служба выполняет работу, которая блокирует поток пользовательского интерфейса, при необходимости она должна создавать и удалять потоки.

В отличие от привязанной службы, канал связи между "чистой" запущенной службой и ее клиентами не существует. Это означает, что запущенная служба будет реализовывать некоторые другие методы жизненного цикла, чем привязанная служба. В следующем списке перечислены распространенные методы жизненного цикла в запущенной службе.

- `OnCreate` &ndash; вызывается один раз при первом запуске службы. Здесь следует реализовать код инициализации.
- `OnBind` &ndash; этот метод должен быть реализован всеми классами служб, однако запущенная служба обычно не привязана к клиенту. В связи с этим запущенная служба просто возвращает `null`. В отличие от этого, гибридная служба (которая является сочетанием привязанной службы и запущенной службы) должна реализовывать и возвращать `Binder` для клиента.
- `OnStartCommand` &ndash; вызывается для каждого запроса на запуск службы либо в ответ на вызов `StartService`, либо перезапускается системой. Именно в этом случае служба может запустить любую длительную задачу. Метод возвращает `StartCommandResult` значение, которое указывает, как или если система должна выполнить перезапуск службы после завершения работы из-за нехватки памяти. Этот вызов выполняется в основном потоке. Этот метод более подробно описан ниже.
- `OnDestroy` &ndash; этот метод вызывается при уничтожении службы. Он используется для выполнения любой окончательной очистки.

Важным методом для запущенной службы является метод `OnStartCommand`. Он будет вызываться каждый раз, когда служба получает запрос для выполнения некоторой работы. Следующий фрагмент кода является примером `OnStartCommand`. 

```csharp
public override StartCommandResult OnStartCommand (Android.Content.Intent intent, StartCommandFlags flags, int startId)
{
    // This method executes on the main thread of the application.
    Log.Debug ("DemoService", "DemoService started");
    ...
    return StartCommandResult.Sticky;
}
```

Первый параметр — это `Intent` объект, содержащий метаданные о выполняемой работе. Второй параметр содержит `StartCommandFlags` значение, предоставляющее некоторые сведения о вызове метода. Этот параметр имеет одно из двух возможных значений:

- `StartCommandFlag.Redelivery` &ndash; это означает, что `Intent` является повторной доставкой предыдущего `Intent`. Это значение предоставляется, когда служба возвращала `StartCommandResult.RedeliverIntent`, но была остановлена до того, как она завершится надлежащим образом.
- `StartCommandFlag.Retry` &dash; это значение принимается, когда произошел сбой предыдущего вызова `OnStartCommand` и Android пытается запустить службу повторно с тем же намерением, что и предыдущая попытка неудачной попытки.

Наконец, третий параметр — это целочисленное значение, уникальное для приложения, идентифицирующего запрос. Возможно, несколько вызывающих объектов могут вызывать один и тот же объект службы. Это значение используется для связывания запроса на прерывание службы с заданным запросом для запуска службы. Более подробно он будет обсуждаться в разделе [Остановка службы](#Stopping_the_Service). 

Значение `StartCommandResult` возвращается службой в качестве предложения для Android на действиях, выполняемых в случае, если служба прервана из-за ограничений ресурсов. Существует три возможных значения для `StartCommandResult`:

- **[Старткоммандресулт. нотстикки](xref:Android.App.StartCommandResult.NotSticky)** &ndash; это значение указывает Android, что нет необходимости перезапускать службу, которая была уничтожена. В качестве примера рассмотрим службу, которая создает эскизы для коллекции в приложении. Если служба будет уничтожена, то не крайне важно повторно создавать эскиз немедленно &ndash; эскиз может быть создан повторно при следующем запуске приложения.
- **[Старткоммандресулт. прикрепленное](xref:Android.App.StartCommandResult.Sticky)** &ndash; это означает, что Android перезапускает службу, но не для предоставления последней цели, которая запустила службу. Если для обработки не существует ожидающих целей, то для параметра намерения будет указан `null`. Примером может быть приложение музыкального проигрывателя; Служба будет перезапущена для воспроизведения музыки, но она будет играть последнюю песню.
- **[Старткоммандресулт. ределиверинтент](xref:Android.App.StartCommandResult.RedeliverIntent)** &ndash; это значение указывает, что Android перезапускает службу и повторно доставляет последние `Intent`. Примером этого является служба, которая скачивает файл данных для приложения. Если служба уничтожена, файл данных по-прежнему необходимо скачать. Возвращая `StartCommandResult.RedeliverIntent`, когда Android перезапускает службу, она также предоставляет намерение (содержащее URL-адрес загружаемого файла) в службу. Это позволит загрузить или перезапустить или возобновить (в зависимости от точной реализации кода).

Существует четвертое значение для `StartCommandResult` &ndash; `StartCommandResult.ContinuationMask`. Это значение возвращается `OnStartCommand` и описывает, как Android продолжит работу службы, которая была остановлена. Это значение обычно не используется для запуска службы.

Основные события жизненного цикла запущенной службы показаны на этой схеме: 

![Схема, показывающая порядок вызова методов жизненного цикла](started-services-images/started-service-01.png "Схема, показывающая порядок вызова методов жизненного цикла.")

<a name="Stopping_the_Service" />

## <a name="stopping-the-service"></a>Остановка службы

Запущенная служба будет оставаться в состоянии неограниченно долго. Android продолжит работу службы, пока достаточно системных ресурсов. Клиент должен завершить работу службы, или служба может завершить свою работу после ее завершения. Существует два способа отключения службы. 

- **[Android. Content. Context. завис ()](xref:Android.Content.Context.StopService*)** &ndash; клиент (например, действие) может запросить завершение службы, вызвав метод `StopService`:

    ```csharp
    StopService(new Intent(this, typeof(DemoService));
    ```

- **[Android. app. Service. стопселф ()](xref:Android.App.Service.StopSelf*)** &ndash; служба может завершить свою работу, вызвав `StopSelf`:

    ```csharp
    StopSelf();
    ```

### <a name="using-startid-to-stop-a-service"></a>Использование Стартид для завершения службы

Несколько вызывающих объектов могут запросить запуск службы. Если имеется необработанный запрос на запуск, служба может использовать `startId`, переданные в `OnStartCommand`, чтобы предотвратить преждевременное прекращение работы службы. `startId` будет соответствовать последнему вызову `StartService`и будет увеличиваться каждый раз при вызове. Таким образом, если последующий запрос к `StartService` еще не привел к вызову `OnStartCommand`, служба может вызвать `StopSelfResult`, передав ей Последнее значение `startId` полученного объекта (вместо просто вызова `StopSelf`). Если вызов `StartService` еще не привел к вызову метода `OnStartCommand`, система не будет прекращать работу службы, так как `startId`, используемое в вызове `StopSelf`, не будет соответствовать последнему вызову `StartService`.

## <a name="related-links"></a>Связанные ссылки

- [Стартедсервицесдемо (пример)](https://docs.microsoft.com/samples/xamarin/monodroid-samples/applicationfundamentals-servicesamples-startedservicesdemo)
- [Android. app. Service](xref:Android.App.Service)
- [Android. app. Старткоммандфлагс](xref:Android.App.StartCommandFlags)
- [Android. app. Старткоммандресулт](xref:Android.App.StartCommandResult)
- [Android. Content. BroadcastReceiver](xref:Android.Content.BroadcastReceiver)
- [Android. Content. намерения](xref:Android.Content.Intent)
- [Android. OS. Handler](xref:Android.OS.Handler)
- [Android. widget. всплывающее](xref:Android.Widget.Toast)
- [Значки строки состояния](https://developer.android.com/guide/practices/ui_guidelines/icon_design_status_bar.html)
