---
title: Обмен сообщениями Firebase Cloud
description: Firebase Cloud Messaging (FCM) — это служба, которая упрощает обмен сообщениями между мобильными приложениями и серверных приложений. В этой статье приводятся общие сведения о том, как работает FCM, и объясняется, как настроить службы Google, чтобы приложение могла использовать FCM.
ms.prod: xamarin
ms.assetid: E5314D7F-2AAC-40DA-BEBA-27C834F078DD
ms.technology: xamarin-android
author: conceptdev
ms.author: crdun
ms.date: 07/31/2018
ms.openlocfilehash: ab42e190f5348de13610955f1175eb01531a280a
ms.sourcegitcommit: 57f815bf0024b1afe9754c0e28054fc0a53ce302
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2019
ms.locfileid: "70754545"
---
# <a name="firebase-cloud-messaging"></a>Обмен сообщениями Firebase Cloud

_Firebase Cloud Messaging (FCM) — это служба, которая упрощает обмен сообщениями между мобильными приложениями и серверных приложений. В этой статье приводятся общие сведения о том, как работает FCM, и объясняется, как настроить службы Google, чтобы приложение могла использовать FCM._

[![Образ Firebase Cloud Messaging Hero](firebase-cloud-messaging-images/preview.png)](firebase-cloud-messaging-images/preview.png#lightbox)

В этом разделе представлен общий обзор того, как Firebase Cloud Messaging маршрутизирует сообщения между приложением Xamarin. Android и сервером приложений, а также предоставляет пошаговую процедуру для получения учетных данных, чтобы приложение могла использовать службы FCM.

## <a name="overview"></a>Обзор

Firebase Cloud Messaging (FCM) — это кросс-платформенная служба, которая обрабатывает отправку, маршрутизацию и очередность сообщений между серверными приложениями и мобильными клиентскими приложениями. FCM является преемником Google Cloud Messaging (GCM) и построен на Сервисы Google Play.

Как показано на следующей схеме, FCM выступает в качестве посредника между отправителями и клиентами сообщений. *Клиентское приложение* — это приложение с поддержкой FCM, которое выполняется на устройстве. *Сервер приложений* (предоставленный вами или вашей организацией) — это сервер с поддержкой FCM, с которым клиентское приложение взаимодействует с помощью FCM. В отличие от GCM, FCM позволяет отправлять сообщения в клиентские приложения непосредственно через графический интерфейс уведомлений консоли Firebase:

[![FCM между клиентским приложением и сервером приложений](firebase-cloud-messaging-images/01-server-fcm-app-sml.png)](firebase-cloud-messaging-images/01-server-fcm-app.png#lightbox)

С помощью FCM серверы приложений могут передавать сообщения на одно устройство, в группу устройств или на несколько устройств, подписанных на раздел. Клиентское приложение может использовать FCM для подписки на подчиненные сообщения с сервера приложений (например, для получения удаленных уведомлений). Дополнительные сведения о различных типах сообщений Firebase см. в разделе [About FCM messages](https://firebase.google.com/docs/cloud-messaging/concept-options).

## <a name="fcm-in-action"></a>Firebase облачных сообщений в действии

Когда в клиентское приложение отправляется подчиненное сообщение с сервера приложений, сервер приложений отправляет сообщение на *сервер подключения FCM* , предоставленный Google; сервер подключения FCM, в свою очередь, перенаправляет сообщение на устройство, на котором выполняется клиентское приложение. Сообщения можно отправлять по протоколу HTTP или [XMPP](https://developers.google.com/cloud-messaging/ccs) (расширенный протокол обмена сообщениями и протокола присутствия). Поскольку клиентские приложения не всегда подключены или выполняются, сервер подключения FCM ставит в очередь и сохраняет сообщения, отправляя их в клиентские приложения при повторном подключении и доступности. Аналогичным образом FCM помещает в очередь вышестоящее сообщение от клиентского приложения к серверу приложений, если сервер приложений недоступен. Дополнительные сведения о серверах подключения FCM см. в разделе [о Firebase Cloud Messaging Server](https://firebase.google.com/docs/cloud-messaging/server).

FCM использует следующие учетные данные для указания сервера приложений и клиентского приложения и использует эти учетные данные для авторизации транзакций сообщений через FCM:

- <a name="fcm-in-action-sender-id"></a>**Идентификатор отправителя** Идентификатор отправителя — это уникальное числовое значение, которое назначается при создании проекта Firebase. &ndash; Идентификатор отправителя используется для идентификации каждого сервера приложений, который может передавать сообщения в клиентское приложение. Идентификатор отправителя также является номером вашего проекта; При регистрации проекта вы получаете идентификатор отправителя из консоли Firebase. Примером идентификатора отправителя является `496915549731`.

- <a name="fcm-in-action-api-key"></a>**Ключ API** Ключ API предоставляет серверу приложений доступ к службам Firebase Services; &ndash; FCM использует этот ключ для проверки подлинности сервера приложений. Эти учетные данные также называются *ключом сервера* или *ключом веб-API*. Примером ключа API является `AJzbSyCTcpfRT1YRqbz-jIwp1h06YdauvewGDzk`.

- <a name="fcm-in-action-app-id"></a>**Идентификатор приложения** &ndash; Удостоверение клиентского приложения (независимо от любого конкретного устройства), которое регистрируется для получения сообщений от FCM. Пример идентификатора приложения: `1:415712510732:android:0e1eb7a661af2460`.

- <a name="fcm-in-action-registration-token"></a>**Токен регистрации** Маркер регистрации (также называемый *идентификатором экземпляра*) является FCM удостоверением клиентского приложения на заданном устройстве. &ndash; Маркер регистрации создается во время &ndash; выполнения, когда приложение получает маркер регистрации при первой регистрации в FCM при выполнении на устройстве. Маркер регистрации авторизует экземпляр клиентского приложения (выполняющегося на этом конкретном устройстве) для получения сообщений от FCM.
    Примером маркера регистрации является `fkBQTHxKKhs:AP91bHuEedxM4xFAUn0z ... JKZS` (очень длинная строка).

[Настройка Firebase Cloud Messaging](#setup_fcm) (далее в этом пошаговом окне) приведены подробные инструкции по созданию проекта и созданию этих учетных данных. При создании нового проекта в &ndash; [консоли Firebase](https://console.firebase.google.com/)создается файл учетных данных под названием **Google-Services. JSON.** добавьте этот файл в проект Xamarin. Android, как описано в разделах [Удаленные уведомления с FCM](~/android/data-cloud/google-messaging/remote-notifications-with-fcm.md).

В следующих разделах объясняется, как эти учетные данные используются при взаимодействии клиентских приложений с серверами приложений через FCM.

<a name="registration" />

### <a name="registration-with-fcm"></a>Регистрация с помощью FCM

Клиентское приложение должно сначала зарегистрироваться в FCM до того, как система обмена сообщениями может быть выполнена. Клиентское приложение должно выполнить действия по регистрации, показанные на следующей схеме:

[![Схема шагов регистрации приложения](firebase-cloud-messaging-images/02-app-registration-sml.png)](firebase-cloud-messaging-images/02-app-registration.png#lightbox)

1. Клиентское приложение обращается к FCM, чтобы получить маркер регистрации, передав идентификатор отправителя, ключ API и идентификатор приложения в FCM.

2. FCM возвращает маркер регистрации клиентскому приложению.

3. Клиентское приложение (необязательно) перенаправляет маркер регистрации на сервер приложений.

Сервер приложений кэширует маркер регистрации для последующего взаимодействия с клиентским приложением. Сервер приложений может отправить подтверждение обратно в клиентское приложение, чтобы указать, что получен маркер регистрации. После выполнения этого подтверждения клиентское приложение может получать сообщения от сервера приложений (или отправлять сообщения на него). Клиентское приложение может получить новый маркер регистрации, если старый маркер скомпрометирован (см. раздел [Удаленные уведомления с помощью FCM](~/android/data-cloud/google-messaging/remote-notifications-with-fcm.md) в качестве примера того, как приложение получает обновления маркера регистрации).

Когда клиентскому приложению больше не требуется получать сообщения с сервера приложений, оно может отправить запрос на сервер приложений для удаления маркера регистрации. Если клиентское приложение удалено с устройства, FCM обнаруживает это и автоматически уведомляет сервер приложений об удалении маркера регистрации.

### <a name="downstream-messaging"></a>Подчиненный обмен сообщениями

На следующей схеме показано, как Firebase облачные службы обмена сообщениями сохраняют и пересылает нисходящие сообщения:

[![FCM использует Store и forward для обмена сообщениями в нисходящем направлении](firebase-cloud-messaging-images/03-downstream-sml.png)](firebase-cloud-messaging-images/03-downstream.png#lightbox)

Когда сервер приложений отправляет в клиентское приложение подчиненное сообщение, он выполняет следующие действия, как перечислено на приведенной выше схеме.

1. Сервер приложений отправляет сообщение в FCM.

2. Если клиентское устройство недоступно, сервер FCM сохраняет сообщение в очереди для последующей передачи. Сообщения хранятся в хранилище FCM не более 4 недель (Дополнительные сведения см. в разделе [Установка срока существования сообщения](https://firebase.google.com/docs/cloud-messaging/concept-options#ttl)).

3. Когда клиентское устройство доступно, FCM перенаправляет сообщение клиентскому приложению на этом устройстве.

4. Клиентское приложение получает сообщение от FCM, обрабатывает его и отображает для пользователя. Например, если сообщение представляет собой удаленное уведомление, оно будет представлено пользователю в области уведомлений.

В этом сценарии обмена сообщениями (где сервер приложений отправляет сообщение в одно клиентское приложение) размер сообщений может доставлять до 4 КБ.

Подробные сведения о получении подчиненных сообщений FCM в Android см. в разделе [Удаленные уведомления с помощью FCM](~/android/data-cloud/google-messaging/remote-notifications-with-fcm.md).

### <a name="topic-messaging"></a>Обмен сообщениями с темой

*Обмен сообщениями с разделами* позволяет серверу приложений отправить сообщение на несколько устройств, участвующих в определенном разделе. Вы также можете создавать и отправлять сообщения раздела с помощью графического интерфейса уведомлений консоли Firebase. FCM обрабатывает маршрутизацию и доставку сообщений раздела клиентам, подписавшимся на них. Эта функция может использоваться для таких сообщений, как оповещения о погоде, котировки котировок и заголовки новостей.

[![Схема обмена сообщениями раздела](firebase-cloud-messaging-images/04-topic-messaging-sml.png)](firebase-cloud-messaging-images/04-topic-messaging.png#lightbox)

Следующие шаги используются в разделе Обмен сообщениями (после того, как клиентское приложение получит маркер регистрации, как описано выше):

1. Клиентское приложение подписывается на раздел, отправляя сообщение подписки в FCM.

2. Сервер приложений отправляет сообщения раздела в FCM для распространения.

3. FCM пересылает сообщения раздела клиентам, которые подписались на этот раздел.

Дополнительные сведения о сообщениях в разделе Firebase см. [в разделе Обмен сообщениями Google в Android](https://firebase.google.com/docs/cloud-messaging/android/topic-messaging).

<a name="setup_fcm" />

## <a name="setting-up-firebase-cloud-messaging"></a>Настройка Firebase Cloud Messaging

Прежде чем можно будет использовать службы FCM в приложении, необходимо создать новый проект (или импортировать существующий проект) через [консоль Firebase](https://console.firebase.google.com/). Чтобы создать Firebase облачный проект обмена сообщениями для приложения, выполните следующие действия.

1. Войдите в [консоль Firebase](https://console.firebase.google.com/) , используя учетную запись Google (т. е. адрес Gmail), и щелкните **создать новый проект**:

    [![Кнопка "создать новый проект"](firebase-cloud-messaging-images/05-firebase-console-sml.png)](firebase-cloud-messaging-images/05-firebase-console.png#lightbox)

    Если у вас уже есть проект, щелкните **Импорт проекта Google**.

2. В диалоговом окне **Создание проекта** введите имя проекта и нажмите кнопку **создать проект**. В следующем примере создается новый проект с именем **ксамаринфкм** :

    [![Диалоговое окно создания проекта](firebase-cloud-messaging-images/06-create-a-project-sml.png)](firebase-cloud-messaging-images/06-create-a-project.png#lightbox)

3. В разделе **Обзор**консоли Firebase щелкните **Добавить Firebase в приложение Android**:

    [![Добавление Firebase в приложение Android](firebase-cloud-messaging-images/07-add-firebase-sml.png)](firebase-cloud-messaging-images/07-add-firebase.png#lightbox)

4. На следующем экране введите имя пакета приложения. В этом примере имя пакета — **com. Xamarin. фкмексампле**. Это значение должно совпадать с именем пакета приложения Android. Псевдоним приложения также можно указать в поле **псевдонима приложения** :

    [![Ввод примера FCM в качестве псевдонима приложения](firebase-cloud-messaging-images/08-package-name-sml.png)](firebase-cloud-messaging-images/08-package-name.png#lightbox)

5. Если приложение использует динамические ссылки, приглашения или Google AUTH, необходимо также ввести сертификат для подписи отладки. Дополнительные сведения о поиске сертификата для подписи см. в разделе [Поиск подписи MD5 или SHA1](~/android/deploy-test/signing/keystore-signature.md).
    В этом примере сертификат подписи остается пустым.

6. Щелкните **Добавить приложение**:

    [![Нажатие кнопки "добавить приложение"](firebase-cloud-messaging-images/09-add-app-sml.png)](firebase-cloud-messaging-images/09-add-app.png#lightbox)

    Для приложения автоматически создаются ключ API сервера и идентификатор клиента. Эти сведения упаковываются в файл **Google-Services. JSON** , который автоматически загружается при нажатии кнопки **Добавить приложение**.
    Не забудьте сохранить этот файл в надежном месте.

Подробный пример добавления **Google-Services. JSON** в проект приложения для получения сообщений push-уведомлений FCM на устройстве Android см. в статье [Удаленные уведомления с помощью FCM](~/android/data-cloud/google-messaging/remote-notifications-with-fcm.md).

## <a name="for-further-reading"></a>Дополнительные материалы

- [Облачная система обмена сообщениями Google Firebase](https://firebase.google.com/docs/cloud-messaging/) предоставляет общие сведения о ключевых возможностях Firebase облачных сообщений, описание его работы и инструкции по установке.

- Запросы на [отправку приложений Google Build Server](https://firebase.google.com/docs/cloud-messaging/send-message) посвящены отправке сообщений с сервера приложений.

- [Rfc 6120](https://tools.ietf.org/html/rfc6120) и [RFC 6121](https://tools.ietf.org/html/rfc6121) объясняют и определяют расширяемый протокол обмена сообщениями и присутствия (XMPP).

- [О сообщениях FCM](https://firebase.google.com/docs/cloud-messaging/concept-options) описывает различные типы сообщений, которые можно отправить с помощью Firebase Cloud Messaging.

## <a name="summary"></a>Сводка

В этой статье представлен обзор Firebase Cloud Messaging (FCM). В нем объясняются различные учетные данные, используемые для обнаружения и авторизации обмена сообщениями между серверами приложений и клиентскими приложениями. В нем проиллюстрированы сценарии регистрации и подчиненных сообщений, а также подробно описаны действия по регистрации приложения в FCM для использования служб FCM.

## <a name="related-links"></a>Связанные ссылки

- [Обмен сообщениями Firebase Cloud](https://firebase.google.com/docs/cloud-messaging/)
