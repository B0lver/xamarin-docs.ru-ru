---
title: Доступ к файлам с помощью Xamarin. Android
description: В этом руководством рассматривается доступ к файлам в Xamarin. Android
ms.prod: xamarin
ms.assetid: FC1CFC58-B799-4DD6-8ED1-DE36B0E56856
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 07/23/2018
ms.openlocfilehash: 1bb0fae73a1e3647cdc0e3266c7b44ac04fcc1ee
ms.sourcegitcommit: eedc6032eb5328115cb0d99ca9c8de48be40b6fa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/07/2020
ms.locfileid: "78914233"
---
# <a name="file-storage-and-access-with-xamarinandroid"></a>Хранение файлов и доступ с помощью Xamarin. Android

Распространенное требование для приложений Android заключается в управлении файлами &ndash; сохранении изображений, скачивании документов или экспорте данных для совместного использования с другими программами. Android (основанный на Linux) поддерживает это, предоставляя пространство для хранения файлов. Android группирует файл в два разных типа хранилища:

* **Внутренняя &ndash; хранения** . это часть файловой системы, доступ к которой может осуществляться только приложением или операционной системой.
* **Внешнее хранилище** &ndash; это раздел для хранения файлов, доступных для всех приложений, пользователя и, возможно, других устройств. На некоторых устройствах внешнее хранилище может быть съемным (например, SD-картой).

Эти группирования являются концептуальными и не обязательно ссылаются на один раздел или каталог на устройстве. Устройство Android всегда будет предоставлять раздел для внутреннего хранения и внешнего хранилища. Возможно, некоторые устройства могут иметь несколько секций, которые считаются внешним хранилищем. Независимо от раздела, API-интерфейсы для чтения, записи или создания файлов одинаковы. Существует два набора интерфейсов API, которые приложение Xamarin. Android может использовать для доступа к файлам:

1. **API-интерфейсы .NET (предоставленные Mono и заключенные в Xamarin. Android)** &ndash; включают [вспомогательные функции файловой системы](~/essentials/file-system-helpers.md?context=xamarin/android) , предоставляемые [Xamarin. Essentials](~/essentials/index.md?context=xamarin/android). API-интерфейсы .NET обеспечивают лучшую совместимость с различными платформами и, как и в этом разделе, они будут включены в эти API.
1. **Собственные API-интерфейсы доступа к файлам Java (предоставляемые Java и Упакованные Xamarin. Android)** &ndash; Java предоставляет собственные интерфейсы API для чтения и записи файлов. Это полностью приемлемая альтернатива интерфейсам API .NET, но они относятся только к Android и не подходят для приложений, предназначенных для кросс-платформенных платформ.

Чтение и запись в файлы практически идентичны в Xamarin. Android, как и в любом другом приложении .NET. Приложение Xamarin. Android определяет путь к файлу, который будет обрабатываться, а затем использует стандартные идиомы .NET для доступа к файлам. Так как фактические пути к внутреннему и внешнему хранилищу могут отличаться от устройства к устройству или от версии Android до версии Android, не рекомендуется жестко кодировать путь к файлам. Вместо этого используйте интерфейсы API Xamarin. Android, чтобы определить путь к файлам. Таким образом, API-интерфейсы .NET для чтения и записи файлов предоставляют собственные API-интерфейсы Android, которые помогут определить путь к файлам во внутреннем и внешнем хранилище.

Прежде чем обсуждать интерфейсы API, участвующие в доступе к файлам, важно понимать некоторые сведения о внутреннем и внешнем хранилище. Это будет рассмотрено в следующем разделе.

## <a name="internal-vs-external-storage"></a>Внутреннее и внешнее хранилище

По сути, внутреннее хранилище и внешнее хранилище очень похожи &ndash; они являются местами, в которых приложение Xamarin. Android может сохранять файлы. Такое сходство может быть запутанным для разработчиков, не знакомых с Android, так как это неясно, когда приложение должно использовать внутреннее хранилище и внешнее хранилище.

Внутренняя система хранения относится к энергонезависимой памяти, которую Android выделяет операционной системе, пакетов apk и отдельным приложениям. Это пространство недоступно за исключением операционной системы или приложений. Android будет выделять каталог во внутреннем разделе хранилища для каждого приложения. При удалении приложения все файлы, хранящиеся во внутреннем хранилище в этом каталоге, также будут удалены. Внутреннее хранилище лучше всего подходит для файлов, доступных только для приложения, которые не будут использоваться совместно с другими приложениями, или будут иметь очень мало значений после удаления приложения. В Android 6,0 или более поздней версии файлы во внутреннем хранилище могут автоматически архивироваться Google с помощью [функции автоматического резервного копирования в Android 6,0](https://developer.android.com/guide/topics/data/autobackup). Внутренние хранилища имеют следующие недостатки.

* Не удается предоставить общий доступ к файлам.
* Файлы будут удалены при удалении приложения.
* Возможно, пространство, доступное во внутренней памяти, ограничено.

Внешнее хранилище относится к хранилищу файлов, которое не является внутренним хранилищем и недоступно для приложения. Основной целью внешнего хранилища является предоставление места для размещения файлов, которые должны совместно использоваться приложениями или которые слишком велики для размещения во внутреннем хранилище. Преимущество внешнего хранилища состоит в том, что обычно пространство для файлов занимает гораздо больше места, чем внутреннее хранилище. Однако внешнее хранилище не всегда гарантировано должно присутствовать на устройстве и может потребовать от пользователя специального разрешения на доступ к нему.

> [!NOTE]
> Для устройств, поддерживающих несколько пользователей, Android предоставит каждому пользователю собственный каталог как во внутреннем, так и во внешнем хранилище. Этот каталог недоступен для других пользователей на устройстве. Это разделение невидимо для приложений, если они не жестко используют пути к файлам во внутреннем или внешнем хранилище.

Как правило, приложения Xamarin. Android должны предпочесть сохранять свои файлы во внутреннем хранилище, когда это разумно, и полагаться на внешнее хранилище, когда файлы необходимо совместно использовать с другими приложениями, являются очень большими или должны сохраняться даже при удалении приложения. Например, файл конфигурации лучше всего подходит для внутреннего хранилища, так как он не имеет важности, за исключением приложения, которое его создает.  Фотографии, напротив, являются хорошим кандидатом для внешнего хранилища. Они могут быть очень большими, и во многих случаях пользователю может потребоваться предоставить доступ к ним или получить доступ к ним, даже если приложение удалено.

В этом руководством основное внимание уделяется внутреннему хранилищу. Дополнительные сведения об использовании внешнего хранилища в приложении Xamarin. Android см. в статье [внешнее хранилище](~/android/platform/files/external-storage.md) руководств.

## <a name="working-with-internal-storage"></a>Работа с внутренним хранилищем

Внутренний каталог хранилища для приложения определяется операционной системой и предоставляется приложениям Android с помощью свойства `Android.Content.Context.FilesDir`. Будет возвращен объект `Java.IO.File`, представляющий каталог, выделенный Android исключительно для приложения.  Например, в приложении с именем пакета **com. CompanyName** внутренний каталог хранения может быть следующим:

```bash
/data/user/0/com.companyname/files
```

Этот документ будет ссылаться на внутренний каталог хранилища в качестве _внутреннего\_хранилища_.

> [!IMPORTANT]
> Точный путь к внутреннему каталогу хранения может отличаться от устройства к устройству и между версиями Android. По этой причине приложения не должны жестко кодировать путь к каталогу хранения внутренних файлов, а вместо этого использовать интерфейсы API Xamarin. Android, например `System.Environment.GetFolderPath()`.

Чтобы максимально увеличить общий доступ к коду, приложения Xamarin. Android (или приложения Xamarin. Forms, предназначенные для Xamarin. Android) должны использовать метод [`System.Environment.GetFolderPath()`](xref:System.Environment.GetFolderPath*) . В Xamarin. Android этот метод возвращает строку для каталога, который находится в том же расположении, что и `Android.Content.Context.FilesDir`. Этот метод принимает перечисление, `System.Environment.SpecialFolder`, которое используется для определения набора перечислимых констант, представляющих пути специальных папок, используемых операционной системой. Не все значения `System.Environment.SpecialFolder` будут сопоставляться с допустимым каталогом в Xamarin. Android. В следующей таблице описано, какой путь может быть ожидаемым для заданного значения `System.Environment.SpecialFolder`:

| System.Environment.SpecialFolder | путь  |
|----------------------|---|
| `ApplicationData` | **/.Конфиг _хранилища внутренней\__** |
| `Desktop` | **/Desktop _хранилища внутренней\__** |
| `LocalApplicationData` | **/.Local/share _хранилища внутренней\__** |
| `MyDocuments` | **_ВНУТРЕННЕЕ хранилище\__** |
| `MyMusic` | **/Мусик _хранилища внутренней\__** |
| `MyPictures` | **/Пиктурес _хранилища внутренней\__** |
| `MyVideos` | **/Видеос _хранилища внутренней\__** |
| `Personal` | **_ВНУТРЕННЕЕ хранилище\__** |

### <a name="reading-or-writing-to-files-on-internal-storage"></a>Чтение или запись в файлы во внутренней памяти

Любой из [ C# API для записи](https://docs.microsoft.com/dotnet/csharp/programming-guide/file-system/how-to-write-to-a-text-file) в файл достаточно; все, что необходимо, — получить путь к файлу, который находится в каталоге, выделенном для приложения. Настоятельно рекомендуется использовать асинхронные версии API-интерфейсов .NET для снижения числа проблем, которые могут быть связаны с блокированием доступа к файлу для блокировки основного потока.

Этот фрагмент кода является одним из примеров записи целого числа в текстовый файл в кодировке UTF-8 во внутренний каталог хранения приложения:

```csharp
public async Task SaveCountAsync(int count)
{
    var backingFile = Path.Combine(System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal), "count.txt");
    using (var writer = File.CreateText(backingFile))
    {
        await writer.WriteLineAsync(count.ToString());
    }
}
```

Следующий фрагмент кода предоставляет один из способов чтения целочисленного значения, хранящегося в текстовом файле:

```csharp
public async Task<int> ReadCountAsync()
{
    var backingFile = Path.Combine(System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal), "count.txt");

    if (backingFile == null || !File.Exists(backingFile))
    {
        return 0;
    }

    var count = 0;
    using (var reader = new StreamReader(backingFile, true))
    {
        string line;
        while ((line = await reader.ReadLineAsync()) != null)
        {
            if (int.TryParse(line, out var newcount))
            {
                count = newcount;
            }
        }
    }

    return count;
}
```

## <a name="using--xamarinessentials-ndash-file-system-helpers"></a>Использование средств поддержки &ndash; файловой системы в Xamarin. Essentials

[Xamarin. Essentials](~/essentials/file-system-helpers.md?context=xamarin/android) — это набор API-интерфейсов для написания кода, совместимого с разными платформами. [Вспомогательные функции файловой системы](~/essentials/file-system-helpers.md?context=xamarin/android) — это класс, который содержит ряд вспомогательных функций для упрощения поиска каталогов кэша и данных приложения. В этом фрагменте кода приведен пример того, как найти внутренний каталог хранилища и каталог кэша для приложения:

```csharp
// Get the path to a file on internal storage
var backingFile = Path.Combine(Xamarin.Essentials.FileSystem.AppDataDirectory, "count.txt");

// Get the path to a file in the cache directory
var cacheFile = Path.Combine(Xamarin.Essentials.FileSystem.CacheDirectory, "count.txt");
```

## <a name="hiding-files-from-the-mediastore"></a>Скрытие файлов из `MediaStore`

`MediaStore` — это компонент Android, который собирает метаданные о файлах мультимедиа (видео, музыку, изображениях) на устройстве Android. Его целью является упрощение совместного использования этих файлов во всех приложениях Android на устройстве.

Закрытые файлы не будут отображаться как общие носители. Например, если приложение сохраняет изображение в закрытом внешнем хранилище, этот файл не будет выбран сканером мультимедиа (`MediaStore`).

Общедоступные файлы будут отобраны `MediaStore`. Каталоги, имеющие нулевое имя файла в байтах **.** `MediaStore`не будет сканировать носитель.

## <a name="related-links"></a>Связанные ссылки

* [Внешнее хранилище](~/android/platform/files/external-storage.md)
* [Сохранение файлов в хранилище устройств](https://developer.android.com/training/data-storage/files)
* [Вспомогательные методы файловой системы Xamarin. Essentials](~/essentials/file-system-helpers.md?context=xamarin/android)
* [Резервное копирование пользовательских данных с помощью автоматической архивации](https://developer.android.com/guide/topics/data/autobackup)
* [Внедренное хранилище](https://source.android.com/devices/storage/adoptable)
